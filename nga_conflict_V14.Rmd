---
Title: "Studying the relationship betwen conflict and children's wellbeing in Nigeria"
Author: Hernando Grueso
Output: nga_conflict
---

Creation: 20/03/2024
Update: 14/08/2024
Data Sources: 
1) MICS: https://mics.unicef.org/surveys
2) Conflict data from Nigeria: https://ucdp.uu.se/country/475
3) Soil Moisture Index: Google Earth Engine https://code.earthengine.google.com/?project=ee-hernandogrueso 
---
<!-- # Code I used to download soil moisture from Google Earth Engine: -->
<!-- // Define the area of interest (Nigeria) -->
<!-- var nigeria = ee.FeatureCollection("USDOS/LSIB_SIMPLE/2017") -->
<!--                .filter(ee.Filter.eq('country_na', 'Nigeria')); -->

<!-- // Define the time range -->
<!-- var startDate = '2020-01-01'; -->
<!-- var endDate = '2021-12-31'; -->

<!-- // Load the Soil Moisture dataset -->
<!-- var soilMoisture = ee.ImageCollection('NASA_USDA/HSL/SMAP10KM_soil_moisture') -->
<!--                      .filterDate(startDate, endDate) -->
<!--                      .select('ssm'); -->

<!-- // Mask out any areas with no data -->
<!-- var maskNoData = function(image) { -->
<!--   return image.updateMask(image.gt(0)); -->
<!-- }; -->

<!-- soilMoisture = soilMoisture.map(maskNoData); -->

<!-- // Calculate the monthly mean soil moisture -->
<!-- var monthlySoilMoisture = ee.ImageCollection( -->
<!--   ee.List.sequence(0, ee.Date(endDate).difference(ee.Date(startDate), 'month').subtract(1)).map(function(n) { -->
<!--     var start = ee.Date(startDate).advance(n, 'month'); -->
<!--     var end = start.advance(1, 'month'); -->
<!--     return soilMoisture.filterDate(start, end) -->
<!--       .mean() -->
<!--       .set('system:time_start', start.millis()) -->
<!--       .set('month', start.get('month')) -->
<!--       .set('year', start.get('year')); -->
<!--   }) -->
<!-- ); -->

<!-- // Clip to Nigeria -->
<!-- monthlySoilMoisture = monthlySoilMoisture.map(function(image) { -->
<!--   return image.clip(nigeria); -->
<!-- }); -->

<!-- // Convert the collection to a list of images -->
<!-- var monthlySoilMoistureList = monthlySoilMoisture.toList(monthlySoilMoisture.size()); -->

<!-- // Export the images to Google Drive -->
<!-- for (var i = 0; i < monthlySoilMoistureList.size().getInfo(); i++) { -->
<!--   var img = ee.Image(monthlySoilMoistureList.get(i)); -->
<!--   var date = ee.Date(img.get('system:time_start')).format('YYYY-MM').getInfo(); -->
<!--   Export.image.toDrive({ -->
<!--     image: img, -->
<!--     description: 'Nigeria_Soil_Moisture_Mean_' + date, -->
<!--     folder: 'soil_moisture_gee', -->
<!--     scale: 10000, -->
<!--     region: nigeria.geometry().bounds(), -->
<!--     fileFormat: 'GeoTIFF' -->
<!--   }); -->
}
---

A. Install Required Packages
```{r}
# List of packages to install
packages <- c("haven", "stargazer", "modelsummary", "ivreg", "bnlearn", "Rgraphviz", "lattice", "gdata", "gRain", "AER", "naijR", "readr", "sf", "rnaturalearth", "rnaturalearthdata", "ggplot2", "dplyr", "geosphere", "survey", "stargazer", "MatchIt", "broom", "cobalt", "lubridate", "units", "sf", "grf", "kableExtra", "texreg", "gstat")

# Find which packages are not installed
packages_to_install <- setdiff(packages, installed.packages()[,"Package"])

# Install the missing packages
if(length(packages_to_install)) install.packages(packages_to_install)

```

B. Define Directory
```{r}
# Defining Directory:
groupDir <- "C:/Users/hgruesohurtado/Dropbox/Documents/Laboral/Oxford/Climate, Conflicts, & Pandemics/Data/"

```

C. Import Data
```{r}
# Conflict data
library(readr)
conf_nga <- read_csv("Conflict/gedevents-2024-03-20.csv")

# Climate
library(raster)
library(sf)
library(dplyr)
library(utils)
# Define the directory where the soil moisture zip file is located
zip_file <- "Climate/Drought/soil_moisture_gee.zip"
unzip_dir <- "Climate/Drought/soil_moisture_gee_unzipped"
# Unzip the folder
unzip(zip_file, exdir = unzip_dir)
# List all soil moisture files in the unzipped directory for 2020 and 2021
file_list <- list.files(unzip_dir, pattern = "Nigeria_Soil_Moisture_Mean_202[01]-.*\\.tif$", full.names = TRUE)
# Load all soil moisture rasters into a stack
soil_moisture_stack <- stack(file_list)

# MICS Geocodes
library(haven)
zip_path <- "MICS/Nigeria MICS5 2016-17 spatial data.zip"
zip_file <- "Anonymised_cluster_geocodes.sav"
geocode_16 <- read_sav(unzip(zip_path, files = zip_file))
zip_path <- "MICS/Nigeria MICS6 2021 spatial data.zip"
geocode_21 <- read_sav(unzip(zip_path, files = zip_file))

# MICS Survey
zip_path <- "MICS/Nigeria MICS5 Datasets.zip"
zip_file <- "Nigeria MICS5 Datasets/Nigeria MICS 2016-17 SPSS Datasets/hh.sav"
nga_hh_16 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS5 Datasets/Nigeria MICS 2016-17 SPSS Datasets/hl.sav"
nga_hl_16 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS5 Datasets/Nigeria MICS 2016-17 SPSS Datasets/wm.sav"
nga_wm_16 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS5 Datasets/Nigeria MICS 2016-17 SPSS Datasets/mn.sav"
nga_mn_16 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS5 Datasets/Nigeria MICS 2016-17 SPSS Datasets/ch.sav"
nga_ch_16 <- read_sav(unzip(zip_path, files = zip_file))

zip_path <- "MICS/Nigeria MICS6 Datasets.zip"
zip_file <- "Nigeria MICS6 Datasets/Nigeria MICS6 SPSS Datasets/hh.sav"
nga_hh_21 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS6 Datasets/Nigeria MICS6 SPSS Datasets/hl.sav"
nga_hl_21 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS6 Datasets/Nigeria MICS6 SPSS Datasets/wm.sav"
nga_wm_21 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS6 Datasets/Nigeria MICS6 SPSS Datasets/mn.sav"
nga_mn_21 <- read_sav(unzip(zip_path, files = zip_file))
zip_file <- "Nigeria MICS6 Datasets/Nigeria MICS6 SPSS Datasets/ch.sav"
nga_ch_21 <- read_sav(unzip(zip_path, files = zip_file))

```

D.1 Clean-Up & Merge Data Sets
```{r}
### Conflict data ###
# Year
conf_nga$year <- substr(conf_nga$source_date, 1, 4)

# Date
conf_nga$date <- substr(conf_nga$source_date, 1, 10)
conf_nga$source_date <- NULL

# Remove "," in low-est 
conf_nga$low_est <- sub(",$", "", conf_nga$low_est)

### MICS 2021 ###
# Merge survey with geocodes at the cluster level (geo-codes are defined at the cluster level)
nga_hh_21 <- merge(nga_hh_21, geocode_21, by = "HH1")
nga_hh_16 <- merge(nga_hh_16, geocode_16, by = "HH1")

# replace variable names
names(nga_hh_21)[names(nga_hh_21) == "Latitude"] <- "latitude"
names(nga_hh_21)[names(nga_hh_21) == "Longitude"] <- "longitude"

#----2.1 Rename Vars with Weird Names----
names(nga_hh_21)[names(nga_hh_21) == "ST3$1"] <- "ST3A"
names(nga_hh_21)[names(nga_hh_21) == "ST3$2"] <- "ST3B"
names(nga_hh_21)[names(nga_hh_21) == "ST3$3"] <- "ST3C"
names(nga_hh_21)[names(nga_hh_21) == "ST3$4"] <- "ST3D"
names(nga_hh_21)[names(nga_hh_21) == "ST4U$1"] <- "ST4A"
names(nga_hh_21)[names(nga_hh_21) == "ST4U$2"] <- "ST4B"
names(nga_hh_21)[names(nga_hh_21) == "ST4U$3"] <- "ST4C"
names(nga_hh_21)[names(nga_hh_21) == "ST4U$4"] <- "ST4D"
names(nga_hh_21)[names(nga_hh_21) == "ST4N$1"] <- "ST4A_M"
names(nga_hh_21)[names(nga_hh_21) == "ST4N$2"] <- "ST4B_M"
names(nga_hh_21)[names(nga_hh_21) == "ST4N$3"] <- "ST4C_M"
names(nga_hh_21)[names(nga_hh_21) == "ST4N$4"] <- "ST4D_M"

# Create new variables
nga_hh_21$christian <- ifelse(nga_hh_21$HC1A==1,1,0)
nga_hh_21$muslim <- ifelse(nga_hh_21$HC1A==2,1,0)
nga_hh_21$traditional <- ifelse(nga_hh_21$HC1A==3,1,0)

#----2.2 Keep variables of interest----
# List of variables without NAs in nga_hl_21
complete_vars <- sapply(nga_hl_21, function(x) sum(is.na(x)) == 0)
names(nga_hl_21)[complete_vars]

vars <- c("HH1", # Cluster Number
          "helevel", # Head of Household Education
          "HH2", # Household Number
          "HH6", # 1=urban, 2=rural 
          "HH48", # Household size
          "HH7", # Province
          "FE1", # During the last 1 year, was there a time when you or others in your household worried about not having enough food to eat because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE1A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE1B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE2", # During the last 1 year, was there a time when you or others in your household were unable to eat healthy and nutritious food because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE2A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE2B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE3", # During the last 1 year, was there a time when you or others in your household ate only a few kinds of foods because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE3A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE3B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE4", # During the last 1 year, was there a time when you or others in your household had to skip a meal because there was not enough money or other resources to get food?: 1=Yes, 2=No, 8=DK 
          "FE4A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE4B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE5", # During the last 1 year, was there a time when you or others in your household ate less than you thought you should because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE5A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE5B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE6", # During the last 1 year, was there a time when your household ran out of food because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE6A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE6B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE6C", #How often did this happen during the last 1 month? Would you say: rarely, sometimes or often?
          "FE7", # During the last 1 year, was there a time when you or others in your household were hungry but did not eat because there was not enough money or other resources for food?: 1=Yes, 2=No, 8=DK 
          "FE7A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE7B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE7C", #How often did this happen during the last 1 month? Would you say: rarely, sometimes or often?
          "FE8", # During the last 1 year, was there a time when you or others in your household went without eating for a whole day because of a lack of money or other resources?: 1=Yes, 2=No, 8=DK 
          "FE8A", # Was this specifically due to the COVID-19 crisis?: 1=Yes, 2=No, 8=DK
          "FE8B", # Did this happen in the last 1 month?: 1=Yes, 2=No, 8=DK
          "FE8C", #How often did this happen during the last 1 month? Would you say: rarely, sometimes or often?
          "ST3A", # Has your household or anyone in your household received assistance through: N-POWER CONDITIONAL CASH TRANSFER?: 1=Yes, 2=No, 8=DK 
          "ST3B", # Has your household or anyone in your household received assistance through: HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”?: 1=Yes, 2=No, 8=DK 
          "ST3C", # Has your household or anyone in your household received assistance through: ANY RETIREMENT PENSION?: 1=Yes, 2=No, 8=DK
          "ST3D", # Has your household or anyone in your household received assistance through: ANY OTHER EXTERNAL ASSISTANCE PROGRAMME?: 1=Yes, 2=No, 8=DK
          "ST4A", # When was the last time your household or anyone in your household received assistance through: N-POWER CONDITIONAL CASH TRANSFER?: 1=months ago, 2=years ago, 9=dk
          "ST4B", # When was the last time your household or anyone in your household received assistance through: HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”?: 1=months ago, 2=years ago, 9=dk
          "ST4C", # When was the last time your household or anyone in your household received assistance through: ANY RETIREMENT PENSION?: 1=months ago, 2=years ago, 9=dk
          "ST4D", # When was the last time your household or anyone in your household received assistance through: ANY OTHER EXTERNAL ASSISTANCE PROGRAMME?: 1=months ago, 2=years ago, 9=dk
          "ST4A_M", # No. of months
          "ST4B_M", # No. of months
          "ST4C_M", # No. of months
          "ST4D_M", # No. of months
          "Displaced",
          "christian", # Religion
          "muslim", # Religion
          "traditional", # Religion
          "ethnicity", # Ethnic group
          "GEONAME",
          "GEONAMES",
          "GEONAMET",
          "latitude",
          "longitude") 

nga_hh_21 <- nga_hh_21[, vars] # Subset of relevant variables

vars <- c("HH1", # Cluster Number
          "HH2", # Household Number
          "windex5",
          "PSU",
          "stratum",
          "hhweight",
          "HL3", # Household relationship
          "HL10", # Child (Age<4)
          "HL11", # Child (Age<17)
          "HH5D", # Day of the interview
          "HH5M", # Month of the interview
          "HH5Y", # Month of the interview
          "zone", # Geographic zone
          "schage", #Age of school-going household members
          "ED16A", # 41=Higher/Tertiary Education, ... , 21=Junior Secondary
          "ED6", # Did you complete that grade/year?: 1=Yes, 2=No
          "HL6", # Age
          "HL4", # 1=male, 2=female
          "ED15", # At any time during the previous (2019-2020) school year did you attend formal school or any Early Childhood Education programme?: 1=Yes, 2=No, 9=DK
          "ED9", # At any time during the current (2020-2021) school year did you attend formal school or any Early Childhood Education programme?: 1=Yes, 2=No, 9=DK
          "ED5A", # Highest Level of Education Attended 
          "HL1", # Head of Household, HL1==1
          "ED12") # In the current (2020-2021) school year, have you received any school tuition support?: 1=Yes, 2=No, 8=DK
nga_hl_21 <- nga_hl_21[, vars] # Subset of relevant variables

vars <- c("HH1", # Cluster Number
          "HH2", # Household Number
          "LN", # Household Member Line Number
          "windex5", #Wealth index quintile 
          "PSU",
          "stratum",
          "wmweight",
          "UN2", # If currently pregnant, did you wanted to get pregnant? 1= Yes, 2=No
          "DB2", # If ever pregnant, did you wanted to get pregnant at that time? 1= Yes, 2=No
          "WB6A", # 41=Higher/Tertiary Education, ... , 21=Junior Secondary
          "WB7", # Did you complete that grade/year?: 1=Yes, 2=No
          "WB4C", # Age
          "WB9", # At any time during the current school year did  you attend school?
          "WB11", # At any time during the previous school year did you attend school
          "MA8Y", # When did you get married?
          "MA11", # How old were you when you started living with your (husband/partner)?
          "WM6D", # Interview day
          "WM6M", # Interview month
          "WM6Y", # Inteview year
          "CP2", #Currently on contraception?
          "SB3", #Last time you had sex was a condom used?
          "SB4", #"5=sex worker"
          "LS1", # Taking all things together, would you say you are (1) very happy, (2) somewhat happy, (3) neither happy nor unhappy, (4) somewhat unhappy or (5) very unhappy
          "LS3") # Compared to this time last year, would you say that your life has (1) improved, (2) stayed more or less the same, or (3) worsened, overall? 
nga_wm_21 <- nga_wm_21[, vars] # Subset of relevant variables

vars <- c("HH1", # Cluster Number
          "HH2", # Household Number
          "LN", # Household Member Line Number
          "windex5", #Wealth index quintile 
          "PSU",
          "stratum",
          "mnweight",
          "MWB6A", # 41=Higher/Tertiary Education, ... , 21=Junior Secondary
          "MWB7", # Did you complete that grade/year?: 1=Yes, 2=No
          "MWB4", # Age
          "MWB9", # At any time during the current school year did  you attend school?
          "MWB11", # At any time during the previous school year did you attend school
          "MMA8Y", # When did you get married?
          "MMA11", # How old were you when you started living with your (husband/partner)?
          "MLS1", # Taking all things together, would you say you are (1) very happy, (2) somewhat happy, (3) neither happy nor unhappy, (4) somewhat unhappy or (5) very unhappy
          "MLS3") # Compared to this time last year, would you say that your life has (1) improved, (2) stayed more or less the same, or (3) worsened, overall?
nga_mn_21 <- nga_mn_21[, vars] # Subset of relevant variables

vars <- c("HH1", # Cluster Number
          "HH2", # Household Number
          "windex5",
          "PSU",
          "stratum",
          "chweight",
          "UB1Y", # Birth Year
          "UB2", # Age
          "UB6", # Have you ever attended any early childhood education programme?
          "UB7", # At any time since September 2020 did you attend the above mentioned programme?
          "BR1", # Do you have a birth certificate? 1=Yes, seen, 2=Yes, not seen, 3=No, 8=DK
          "IM2", # . Do you have a child health card / vaccination card or immunisation records from a private health provider or any other document where (name)’s vaccinations are written down? 1=YES, HAS ONLY CARD(S), 2=YES, HAS ONLY OTHER DOCUMENT, 3=YES, HAS CARD(S) AND OTHER DOCUMENT, 4=NO, HAS NO CARDS AND NO OTHER DOCUMENT
          "IM6BY", # Date of immunization
          "IM6H0Y",
          "IM6IY",
          "IM6MVY",
          "IM6N1Y",
          "IM6N2Y",
          "IM6P0Y",
          "IM6P1Y",
          "IM6P2Y",
          "IM6P3Y",
          "IM6PCV1Y",
          "IM6PCV2Y",
          "IM6PCV3Y",
          "IM6PENTA1Y",   
          "IM6PENTA2Y",
          "IM6PENTA3Y",
          "IM6Z1Y",
          "IM6Z2Y",
          "IM6YY",
          "UF7D", # Interview Day
          "UF7M", # Interview Month
          "UF7Y", # Interview Year
          "UB8", # Currently attending childhood education?
          "EC3A", # On how many days during the last week was the child left alone for more than an hour?
          "EC3B", # On how many days during the last week was the child left in care of another child that is less than 10 years old?
          "EC5AY", # During the past 3 days, did you or any household member older that 15 engaged with: reading books?
          "EC5BY", # During the past 3 days, did you or any household member older that 15 engaged with: story telling?
          "EC5CY", # During the past 3 days, did you or any household member older that 15 engaged with: singing?
          "EC5DY", # During the past 3 days, did you or any household member older that 15 engaged with: going outside?
          "EC5EY", # During the past 3 days, did you or any household member older that 15 engaged with: playing?
          "EC39", # How often does the child seem sad or depressed?
          "EC40", # How often does he/she display aggresive behavior?
          "UCD2F", # During the last month, have you: spanked or hit your child?
          "UCD2G", # During the last month, have you: hit your child with an object?
          "UCD2H", # During the last month, have you: called your child dumb, lazy, or another name?
          "UCD2I", # During the last month, have you: hit or slapped your child's face?        
          "UCD2J", # During the last month, have you: hit or slapped your child's leg?
          "UCD2K" # During the last month, have you: bitten up your child?
          ) 
nga_ch_21 <- nga_ch_21[, vars] # Subset of relevant variables

#----2.3 Merge Data Sets----
# Specify NAs of Head of Household Education
nga_hh_21$helevel[nga_hh_21$helevel>4] <- NA

## Merging ##
# Household Members     
nga_hl_21 <- merge(nga_hl_21, nga_hh_21, by = c("HH1", "HH2")) # Add household level vars 

# Women      
nga_wm_21 <- merge(nga_wm_21, nga_hh_21, by = c("HH1", "HH2")) # Add household level vars

# Men
nga_mn_21 <- merge(nga_mn_21, nga_hh_21, by = c("HH1", "HH2")) # Add household level vars

# Children (under 5)
nga_ch_21 <- merge(nga_ch_21, nga_hh_21, by = c("HH1", "HH2")) # Add household level vars

# Removed non-used data sets
rm(nga_hh_21)

#----2.4 Clean Household Members Data Set----
# survey weight
names(nga_hl_21)[names(nga_hl_21) == "hhweight"] <- "weight"

# Household received any social transfer or benefit
nga_hl_21$ST3A[nga_hl_21$ST3A>2] <- NA
nga_hl_21$ST3B[nga_hl_21$ST3B>2] <- NA
nga_hl_21$ST3C[nga_hl_21$ST3C>2] <- NA
nga_hl_21$ST3D[nga_hl_21$ST3D>2] <- NA

nga_hl_21$ST3A[nga_hl_21$ST3A==2] <- 0
nga_hl_21$ST3B[nga_hl_21$ST3B==2] <- 0
nga_hl_21$ST3C[nga_hl_21$ST3C==2] <- 0
nga_hl_21$ST3D[nga_hl_21$ST3D==2] <- 0

nga_hl_21$soc_pro <- ifelse(nga_hl_21$ST3A==1, 1, NA)
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3A==0] <- 0
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3B==1] <- 1
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3B==0] <- 0
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3C==1] <- 1
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3C==0] <- 0
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3D==1] <- 1
nga_hl_21$soc_pro[is.na(nga_hl_21$soc_pro) & nga_hl_21$ST3D==0] <- 0

# Household Size
names(nga_hl_21)[names(nga_hl_21) == "HH48"] <- "size"

# No. of social protection programs received
nga_hl_21$soc_pro_n <- ifelse(is.na(nga_hl_21$ST3A), 0, nga_hl_21$ST3A) + ifelse(is.na(nga_hl_21$ST3B), 0, nga_hl_21$ST3B) + ifelse(is.na(nga_hl_21$ST3C), 0, nga_hl_21$ST3C)

# No. of social protection programs received / No. of people in the household
nga_hl_21$soc_pro_pc <- nga_hl_21$soc_pro_n/nga_hl_21$size

# Total No. of months since last assistance 
nga_hl_21$ST4A[nga_hl_21$ST4A>2] <- NA
nga_hl_21$ST4B[nga_hl_21$ST4B>2] <- NA
nga_hl_21$ST4C[nga_hl_21$ST4C>2] <- NA
nga_hl_21$ST4D[nga_hl_21$ST4D>2] <- NA

nga_hl_21$ST4A_M[nga_hl_21$ST4A_M==99] <- NA
nga_hl_21$ST4B_M[nga_hl_21$ST4B_M==98] <- NA
nga_hl_21$ST4C_M[nga_hl_21$ST4C_M==98] <- NA
nga_hl_21$ST4D_M[nga_hl_21$ST4D_M==98] <- NA

nga_hl_21$soc_cash_m <- nga_hl_21$ST4A*nga_hl_21$ST4A_M
nga_hl_21$soc_hup_m <- nga_hl_21$ST4B*nga_hl_21$ST4B_M
nga_hl_21$soc_pension_m <- nga_hl_21$ST4C*nga_hl_21$ST4C_M
nga_hl_21$soc_other_m <- nga_hl_21$ST4D*nga_hl_21$ST4D_M

# Received Cash Transfer
names(nga_hl_21)[names(nga_hl_21) == "ST3A"] <- "soc_cash"

# Received HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”
names(nga_hl_21)[names(nga_hl_21) == "ST3B"] <- "soc_hup"

# Received a retirement pension
names(nga_hl_21)[names(nga_hl_21) == "ST3C"] <- "soc_pension"

# Received any other assistance
names(nga_hl_21)[names(nga_hl_21) == "ST3D"] <- "soc_other"

# Received tuition aid
names(nga_hl_21)[names(nga_hl_21) == "ED12"] <- "soc_tuition"

nga_hl_21$ST4A <- NULL
nga_hl_21$ST4B <- NULL
nga_hl_21$ST4C <- NULL
nga_hl_21$ST4D <- NULL

nga_hl_21$ST4A_M <- NULL
nga_hl_21$ST4B_M <- NULL
nga_hl_21$ST4C_M <- NULL
nga_hl_21$ST4D_M <- NULL

# Total No. of months since last assistance (including multiple but excluding school tuition)
nga_hl_21$soc_m <- pmin(nga_hl_21$soc_cash_m, nga_hl_21$soc_hup_m, nga_hl_21$soc_pension_m, nga_hl_21$soc_other_m, na.rm = TRUE)

# Rural
nga_hl_21$rural <- ifelse(nga_hl_21$HH6==1,1,NA)
nga_hl_21$rural[nga_hl_21$HH6==2] <- 0
nga_hl_21$HH6 <- NULL 

# Household Size
names(nga_hl_21)[names(nga_hl_21) == "HH48"] <- "size"

# State
names(nga_hl_21)[names(nga_hl_21) == "HH7"] <- "state"

# Age
names(nga_hl_21)[names(nga_hl_21) == "HL6"] <- "age"

# Female
nga_hl_21$female <- ifelse(nga_hl_21$HL4==2,1,NA)
nga_hl_21$female[nga_hl_21$HL4==1] <- 0
nga_hl_21$HL4 <- NULL 

# School Attendance in 2020-2021
nga_hl_21$ED9[nga_hl_21$ED9>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "ED9"] <- "school20"
nga_hl_21$school20[nga_hl_21$school20==2] <- 0

# School Attendance in 2019-2020
nga_hl_21$ED15[nga_hl_21$ED15>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "ED15"] <- "school19"
nga_hl_21$school19[nga_hl_21$school19==2] <- 0

# School Dropout
nga_hl_21$ED16A[nga_hl_21$ED16A>41] <- NA
nga_hl_21$ED6[nga_hl_21$ED6>2] <- NA
nga_hl_21$school_drop <- ifelse(nga_hl_21$school20==0 & nga_hl_21$ED16A<41 & nga_hl_21$ED6==2, 1, NA)
nga_hl_21$school_drop[nga_hl_21$school20==1 & nga_hl_21$school19==1] <- 0
nga_hl_21$school_drop[nga_hl_21$school20==1 & nga_hl_21$school19==1 & nga_hl_21$ED16A>21 & nga_hl_21$ED6==1] <- 0
nga_hl_21$ED16A <- NULL
nga_hl_21$ED6 <- NULL

# Household relationship
nga_hl_21$HL3[nga_hl_21$HL3>14] <- NA

# Child (Age<17)
names(nga_hl_21)[names(nga_hl_21) == "HL11"] <- "child"
nga_hl_21$child[nga_hl_21$child==2] <- 0

# Interview day
nga_hl_21$int_day <- nga_hl_21$date <- as.Date(paste(nga_hl_21$HH5Y, nga_hl_21$HH5M, nga_hl_21$HH5D, sep = "-"), format = "%Y-%m-%d")
nga_hl_21$HH5Y <- NULL
nga_hl_21$HH5M <- NULL
nga_hl_21$HH5D <- NULL

#--Food Insecurity & COVID--#
# 1) Food insecurity: worried about not having enough food to eat because of a lack of money or other resources
nga_hl_21$FE1[nga_hl_21$FE1>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE1"] <- "food1_20"
nga_hl_21$food1_20[nga_hl_21$food1_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE1A[nga_hl_21$FE1A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE1A"] <- "food1_covid"
nga_hl_21$food1_covid[nga_hl_21$food1_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE1B[nga_hl_21$FE1B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE1B"] <- "food1_21"
nga_hl_21$food1_21[nga_hl_21$food1_21==2] <- 0

# 2) Food insecurity: were unable to eat healthy and nutritious food because of a lack of money or other resources
nga_hl_21$FE2[nga_hl_21$FE2>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE2"] <- "food2_20"
nga_hl_21$food2_20[nga_hl_21$food2_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE2A[nga_hl_21$FE2A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE2A"] <- "food2_covid"
nga_hl_21$food2_covid[nga_hl_21$food2_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE2B[nga_hl_21$FE2B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE2B"] <- "food2_21"
nga_hl_21$food2_21[nga_hl_21$food2_21==2] <- 0

# 3) Food insecurity: ate only a few kinds of foods because of a lack of money or other resources
nga_hl_21$FE3[nga_hl_21$FE3>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE3"] <- "food3_20"
nga_hl_21$food3_20[nga_hl_21$food3_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE3A[nga_hl_21$FE3A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE3A"] <- "food3_covid"
nga_hl_21$food3_covid[nga_hl_21$food3_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE3B[nga_hl_21$FE3B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE3B"] <- "food3_21"
nga_hl_21$food3_21[nga_hl_21$food3_21==2] <- 0

# 4) Food insecurity:  skip a meal because there was not enough money or other resources to get food
nga_hl_21$FE4[nga_hl_21$FE4>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE4"] <- "food4_20"
nga_hl_21$food4_20[nga_hl_21$food4_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE4A[nga_hl_21$FE4A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE4A"] <- "food4_covid"
nga_hl_21$food4_covid[nga_hl_21$food4_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE4B[nga_hl_21$FE4B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE4B"] <- "food4_21"
nga_hl_21$food4_21[nga_hl_21$food4_21==2] <- 0

# 5) Food insecurity: ate less than you thought you should because of a lack of money or other resources
nga_hl_21$FE5[nga_hl_21$FE5>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE5"] <- "food5_20"
nga_hl_21$food5_20[nga_hl_21$food5_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE5A[nga_hl_21$FE5A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE5A"] <- "food5_covid"
nga_hl_21$food5_covid[nga_hl_21$food5_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE5B[nga_hl_21$FE5B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE5B"] <- "food5_21"
nga_hl_21$food5_21[nga_hl_21$food5_21==2] <- 0

# 6) Food insecurity: ran out of food because of a lack of money or other resources
nga_hl_21$FE6[nga_hl_21$FE6>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE6"] <- "food6_20"
nga_hl_21$food6_20[nga_hl_21$food6_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE6A[nga_hl_21$FE6A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE6A"] <- "food6_covid"
nga_hl_21$food6_covid[nga_hl_21$food6_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE6B[nga_hl_21$FE6B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE6B"] <- "food6_21"
nga_hl_21$food6_21[nga_hl_21$food6_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_hl_21$FE6C[nga_hl_21$FE6C>3] <- NA
nga_hl_21$food6_int_21 <- ifelse(nga_hl_21$food6_21==1,nga_hl_21$FE6C,0)
nga_hl_21$FE6C <- NULL

# 7) Food insecurity: were hungry but did not eat because there was not enough money or other resources for food
nga_hl_21$FE7[nga_hl_21$FE7>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE7"] <- "food7_20"
nga_hl_21$food7_20[nga_hl_21$food7_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE7A[nga_hl_21$FE7A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE7A"] <- "food7_covid"
nga_hl_21$food7_covid[nga_hl_21$food7_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE7B[nga_hl_21$FE7B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE7B"] <- "food7_21"
nga_hl_21$food7_21[nga_hl_21$food7_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_hl_21$FE7C[nga_hl_21$FE7C>3] <- NA
nga_hl_21$food7_int_21 <- ifelse(nga_hl_21$food7_21==1,nga_hl_21$FE7C,0)
nga_hl_21$FE7C <- NULL

# 8) Food insecurity: went without eating for a whole day because of a lack of money or other resources
nga_hl_21$FE8[nga_hl_21$FE8>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE8"] <- "food8_20"
nga_hl_21$food8_20[nga_hl_21$food8_20==2] <- 0
# Was this due to COVID-19?
nga_hl_21$FE8A[nga_hl_21$FE8A>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE8A"] <- "food8_covid"
nga_hl_21$food8_covid[nga_hl_21$food8_covid==2] <- 0
# Did this happen during the last month?
nga_hl_21$FE8B[nga_hl_21$FE8B>2] <- NA
names(nga_hl_21)[names(nga_hl_21) == "FE8B"] <- "food8_21"
nga_hl_21$food8_21[nga_hl_21$food8_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_hl_21$FE8C[nga_hl_21$FE8C>3] <- NA
nga_hl_21$food8_int_21 <- ifelse(nga_hl_21$food8_21==1,nga_hl_21$FE8C,0)
nga_hl_21$FE8C <- NULL

# Food insecurity intensity in 2020
nga_hl_21$food_20 <- ifelse(nga_hl_21$food1_20==0,0,NA)
nga_hl_21$food_20[nga_hl_21$food1_20==1] <- 1
nga_hl_21$food_20[nga_hl_21$food2_20==1] <- 2
nga_hl_21$food_20[nga_hl_21$food3_20==1] <- 3
nga_hl_21$food_20[nga_hl_21$food4_20==1] <- 4
nga_hl_21$food_20[nga_hl_21$food5_20==1] <- 5
nga_hl_21$food_20[nga_hl_21$food6_20==1] <- 6
nga_hl_21$food_20[nga_hl_21$food7_20==1] <- 7
nga_hl_21$food_20[nga_hl_21$food8_20==1] <- 8

# Food insecurity intensity in 2021
nga_hl_21$food_21 <- ifelse(nga_hl_21$food1_21==0,0,NA)
nga_hl_21$food_21[nga_hl_21$food1_21==1] <- 1
nga_hl_21$food_21[nga_hl_21$food2_21==1] <- 2
nga_hl_21$food_21[nga_hl_21$food3_21==1] <- 3
nga_hl_21$food_21[nga_hl_21$food4_21==1] <- 4
nga_hl_21$food_21[nga_hl_21$food5_21==1] <- 5
nga_hl_21$food_21[nga_hl_21$food6_21==1] <- 6
nga_hl_21$food_21[nga_hl_21$food7_21==1] <- 7
nga_hl_21$food_21[nga_hl_21$food8_21==1] <- 8

#----2.5 Clean Women Data Set----
# survey weight
names(nga_wm_21)[names(nga_wm_21) == "wmweight"] <- "weight"

# Household received any social transfer or benefit
nga_wm_21$ST3A[nga_wm_21$ST3A>2] <- NA
nga_wm_21$ST3B[nga_wm_21$ST3B>2] <- NA
nga_wm_21$ST3C[nga_wm_21$ST3C>2] <- NA
nga_wm_21$ST3D[nga_wm_21$ST3D>2] <- NA

nga_wm_21$ST3A[nga_wm_21$ST3A==2] <- 0
nga_wm_21$ST3B[nga_wm_21$ST3B==2] <- 0
nga_wm_21$ST3C[nga_wm_21$ST3C==2] <- 0
nga_wm_21$ST3D[nga_wm_21$ST3D==2] <- 0

nga_wm_21$soc_pro <- ifelse(nga_wm_21$ST3A==1, 1, NA)
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3A==0] <- 0
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3B==1] <- 1
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3B==0] <- 0
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3C==1] <- 1
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3C==0] <- 0
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3D==1] <- 1
nga_wm_21$soc_pro[is.na(nga_wm_21$soc_pro) & nga_wm_21$ST3D==0] <- 0

# Household Size
names(nga_wm_21)[names(nga_wm_21) == "HH48"] <- "size"

# No. of social protection programs received
nga_wm_21$soc_pro_n <- ifelse(is.na(nga_wm_21$ST3A), 0, nga_wm_21$ST3A) + ifelse(is.na(nga_wm_21$ST3B), 0, nga_wm_21$ST3B) + ifelse(is.na(nga_wm_21$ST3C), 0, nga_wm_21$ST3C)

# No. of social protection programs received / No. of people in the household
nga_wm_21$soc_pro_pc <- nga_wm_21$soc_pro_n/nga_wm_21$size

# Total No. of months since last assistance 
nga_wm_21$ST4A[nga_wm_21$ST4A>2] <- NA
nga_wm_21$ST4B[nga_wm_21$ST4B>2] <- NA
nga_wm_21$ST4C[nga_wm_21$ST4C>2] <- NA
nga_wm_21$ST4D[nga_wm_21$ST4D>2] <- NA

nga_wm_21$ST4A_M[nga_wm_21$ST4A_M==99] <- NA
nga_wm_21$ST4B_M[nga_wm_21$ST4B_M==98] <- NA
nga_wm_21$ST4C_M[nga_wm_21$ST4C_M==98] <- NA
nga_wm_21$ST4D_M[nga_wm_21$ST4D_M==98] <- NA

nga_wm_21$soc_cash_m <- nga_wm_21$ST4A*nga_wm_21$ST4A_M
nga_wm_21$soc_hup_m <- nga_wm_21$ST4B*nga_wm_21$ST4B_M
nga_wm_21$soc_pension_m <- nga_wm_21$ST4C*nga_wm_21$ST4C_M
nga_wm_21$soc_other_m <- nga_wm_21$ST4D*nga_wm_21$ST4D_M

# Received Cash Transfer
names(nga_wm_21)[names(nga_wm_21) == "ST3A"] <- "soc_cash"

# Received HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”
names(nga_wm_21)[names(nga_wm_21) == "ST3B"] <- "soc_hup"

# Received a retirement pension
names(nga_wm_21)[names(nga_wm_21) == "ST3C"] <- "soc_pension"

# Received any other assistance
names(nga_wm_21)[names(nga_wm_21) == "ST3D"] <- "soc_other"

# Received tuition aid
names(nga_wm_21)[names(nga_wm_21) == "ED12"] <- "soc_tuition"

nga_wm_21$ST4A <- NULL
nga_wm_21$ST4B <- NULL
nga_wm_21$ST4C <- NULL
nga_wm_21$ST4D <- NULL

nga_wm_21$ST4A_M <- NULL
nga_wm_21$ST4B_M <- NULL
nga_wm_21$ST4C_M <- NULL
nga_wm_21$ST4D_M <- NULL

# Total No. of months since last assistance (including multiple but excluding school tuition)
nga_wm_21$soc_m <- pmin(nga_wm_21$soc_cash_m, nga_wm_21$soc_hup_m, nga_wm_21$soc_pension_m, nga_wm_21$soc_other_m, na.rm = TRUE)

# Rural
nga_wm_21$rural <- ifelse(nga_wm_21$HH6==1,1,NA)
nga_wm_21$rural[nga_wm_21$HH6==2] <- 0
nga_wm_21$HH6 <- NULL 

# State
names(nga_wm_21)[names(nga_wm_21) == "HH7"] <- "state"

# Age
names(nga_wm_21)[names(nga_wm_21) == "WB4C"] <- "age"

# School Attendance in 2020-2021
nga_wm_21$WB9[nga_wm_21$WB9>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "WB9"] <- "school20"
nga_wm_21$school20[nga_wm_21$school20==2] <- 0

# School Attendance in 2019-2020
nga_wm_21$WB11[nga_wm_21$WB11>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "WB11"] <- "school19"
nga_wm_21$school19[nga_wm_21$school19==2] <- 0

# School Dropout
nga_wm_21$WB6A[nga_wm_21$WB6A>41] <- NA
nga_wm_21$WB7[nga_wm_21$WB7>2] <- NA
nga_wm_21$school_drop <- ifelse(nga_wm_21$school20==0 & nga_wm_21$school19==1 & nga_wm_21$WB6A<41 & nga_wm_21$WB7==2, 1, NA)
nga_wm_21$school_drop[nga_wm_21$school20==1 & nga_wm_21$school19==1] <- 0
nga_wm_21$school_drop[nga_wm_21$school20==0 & nga_wm_21$school19==1 & nga_wm_21$WB6>21 & nga_wm_21$WB7==1] <- 0
nga_wm_21$WB6A <- NULL
nga_wm_21$WB7 <- NULL

# Child Marriage
nga_wm_21$MA8Y[nga_wm_21$MA8Y>9997] <- NA
names(nga_wm_21)[names(nga_wm_21) == "MA8Y"] <- "marriage_date"

nga_wm_21$MA11[nga_wm_21$MA11==99] <- NA
names(nga_wm_21)[names(nga_wm_21) == "MA11"] <- "marriage_age"

nga_wm_21$marriage_child <- ifelse(nga_wm_21$marriage_age<19,1,0)

# Mental health
nga_wm_21$LS1[nga_wm_21$LS1>9] <- NA
nga_wm_21$happiness_20 <- ifelse(nga_wm_21$LS1==1,2,NA)
nga_wm_21$happiness_20[nga_wm_21$LS1==2] <- 1
nga_wm_21$happiness_20[nga_wm_21$LS1==3] <- 0
nga_wm_21$happiness_20[nga_wm_21$LS1==4] <- -1
nga_wm_21$happiness_20[nga_wm_21$LS1==5] <- -2
nga_wm_21$LS1 <- NULL

nga_wm_21$LS3[nga_wm_21$LS3>9] <- NA
nga_wm_21$happiness_change <- ifelse(nga_wm_21$LS3==2,0,NA)
nga_wm_21$happiness_change[nga_wm_21$LS3==1] <- 1
nga_wm_21$happiness_change[nga_wm_21$LS3==3] <- -1
nga_wm_21$LS3 <- NULL

# Calculate Proxy for Happiness 2021:
nga_wm_21$happiness_21 <- nga_wm_21$happiness_20+nga_wm_21$happiness_change

#--Food Insecurity & COVID--#
# 1) Food insecurity: worried about not having enough food to eat because of a lack of money or other resources
nga_wm_21$FE1[nga_wm_21$FE1>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE1"] <- "food1_20"
nga_wm_21$food1_20[nga_wm_21$food1_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE1A[nga_wm_21$FE1A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE1A"] <- "food1_covid"
nga_wm_21$food1_covid[nga_wm_21$food1_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE1B[nga_wm_21$FE1B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE1B"] <- "food1_21"
nga_wm_21$food1_21[nga_wm_21$food1_21==2] <- 0

# 2) Food insecurity: were unable to eat healthy and nutritious food because of a lack of money or other resources
nga_wm_21$FE2[nga_wm_21$FE2>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE2"] <- "food2_20"
nga_wm_21$food2_20[nga_wm_21$food2_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE2A[nga_wm_21$FE2A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE2A"] <- "food2_covid"
nga_wm_21$food2_covid[nga_wm_21$food2_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE2B[nga_wm_21$FE2B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE2B"] <- "food2_21"
nga_wm_21$food2_21[nga_wm_21$food2_21==2] <- 0

# 3) Food insecurity: ate only a few kinds of foods because of a lack of money or other resources
nga_wm_21$FE3[nga_wm_21$FE3>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE3"] <- "food3_20"
nga_wm_21$food3_20[nga_wm_21$food3_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE3A[nga_wm_21$FE3A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE3A"] <- "food3_covid"
nga_wm_21$food3_covid[nga_wm_21$food3_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE3B[nga_wm_21$FE3B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE3B"] <- "food3_21"
nga_wm_21$food3_21[nga_wm_21$food3_21==2] <- 0

# 4) Food insecurity:  skip a meal because there was not enough money or other resources to get food
nga_wm_21$FE4[nga_wm_21$FE4>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE4"] <- "food4_20"
nga_wm_21$food4_20[nga_wm_21$food4_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE4A[nga_wm_21$FE4A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE4A"] <- "food4_covid"
nga_wm_21$food4_covid[nga_wm_21$food4_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE4B[nga_wm_21$FE4B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE4B"] <- "food4_21"
nga_wm_21$food4_21[nga_wm_21$food4_21==2] <- 0

# 5) Food insecurity: ate less than you thought you should because of a lack of money or other resources
nga_wm_21$FE5[nga_wm_21$FE5>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE5"] <- "food5_20"
nga_wm_21$food5_20[nga_wm_21$food5_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE5A[nga_wm_21$FE5A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE5A"] <- "food5_covid"
nga_wm_21$food5_covid[nga_wm_21$food5_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE5B[nga_wm_21$FE5B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE5B"] <- "food5_21"
nga_wm_21$food5_21[nga_wm_21$food5_21==2] <- 0

# 6) Food insecurity: ran out of food because of a lack of money or other resources
nga_wm_21$FE6[nga_wm_21$FE6>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE6"] <- "food6_20"
nga_wm_21$food6_20[nga_wm_21$food6_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE6A[nga_wm_21$FE6A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE6A"] <- "food6_covid"
nga_wm_21$food6_covid[nga_wm_21$food6_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE6B[nga_wm_21$FE6B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE6B"] <- "food6_21"
nga_wm_21$food6_21[nga_wm_21$food6_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_wm_21$FE6C[nga_wm_21$FE6C>3] <- NA
nga_wm_21$food6_int_21 <- ifelse(nga_wm_21$food6_21==1,nga_wm_21$FE6C,0)
nga_wm_21$FE6C <- NULL

# 7) Food insecurity: were hungry but did not eat because there was not enough money or other resources for food
nga_wm_21$FE7[nga_wm_21$FE7>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE7"] <- "food7_20"
nga_wm_21$food7_20[nga_wm_21$food7_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE7A[nga_wm_21$FE7A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE7A"] <- "food7_covid"
nga_wm_21$food7_covid[nga_wm_21$food7_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE7B[nga_wm_21$FE7B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE7B"] <- "food7_21"
nga_wm_21$food7_21[nga_wm_21$food7_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_wm_21$FE7C[nga_wm_21$FE7C>3] <- NA
nga_wm_21$food7_int_21 <- ifelse(nga_wm_21$food7_21==1,nga_wm_21$FE7C,0)
nga_wm_21$FE7C <- NULL

# 8) Food insecurity: went without eating for a whole day because of a lack of money or other resources
nga_wm_21$FE8[nga_wm_21$FE8>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE8"] <- "food8_20"
nga_wm_21$food8_20[nga_wm_21$food8_20==2] <- 0
# Was this due to COVID-19?
nga_wm_21$FE8A[nga_wm_21$FE8A>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE8A"] <- "food8_covid"
nga_wm_21$food8_covid[nga_wm_21$food8_covid==2] <- 0
# Did this happen during the last month?
nga_wm_21$FE8B[nga_wm_21$FE8B>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "FE8B"] <- "food8_21"
nga_wm_21$food8_21[nga_wm_21$food8_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_wm_21$FE8C[nga_wm_21$FE8C>3] <- NA
nga_wm_21$food8_int_21 <- ifelse(nga_wm_21$food8_21==1,nga_wm_21$FE8C,0)
nga_wm_21$FE8C <- NULL

# Food insecurity intensity in 2020
nga_wm_21$food_20 <- ifelse(nga_wm_21$food1_20==0,0,NA)
nga_wm_21$food_20[nga_wm_21$food1_20==1] <- 1
nga_wm_21$food_20[nga_wm_21$food2_20==1] <- 2
nga_wm_21$food_20[nga_wm_21$food3_20==1] <- 3
nga_wm_21$food_20[nga_wm_21$food4_20==1] <- 4
nga_wm_21$food_20[nga_wm_21$food5_20==1] <- 5
nga_wm_21$food_20[nga_wm_21$food6_20==1] <- 6
nga_wm_21$food_20[nga_wm_21$food7_20==1] <- 7
nga_wm_21$food_20[nga_wm_21$food8_20==1] <- 8

# Food insecurity intensity in 2021
nga_wm_21$food_21 <- ifelse(nga_wm_21$food1_21==0,0,NA)
nga_wm_21$food_21[nga_wm_21$food1_21==1] <- 1
nga_wm_21$food_21[nga_wm_21$food2_21==1] <- 2
nga_wm_21$food_21[nga_wm_21$food3_21==1] <- 3
nga_wm_21$food_21[nga_wm_21$food4_21==1] <- 4
nga_wm_21$food_21[nga_wm_21$food5_21==1] <- 5
nga_wm_21$food_21[nga_wm_21$food6_21==1] <- 6
nga_wm_21$food_21[nga_wm_21$food7_21==1] <- 7
nga_wm_21$food_21[nga_wm_21$food8_21==1] <- 8

## Pregnancy
# Unwanted current pregnancy (after COVID-19?)
nga_wm_21$UN2[nga_wm_21$UN2>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "UN2"] <- "un_preg_now"
nga_wm_21$un_preg_now[nga_wm_21$un_preg_now==2] <- 0

# Unwanted previous pregnancy (before COVID-19?)
nga_wm_21$DB2[nga_wm_21$DB2>2] <- NA
names(nga_wm_21)[names(nga_wm_21) == "DB2"] <- "un_preg_past"
nga_wm_21$un_preg_past[nga_wm_21$un_preg_past==2] <- 0

# Interview day
nga_wm_21$int_day <- nga_wm_21$date <- as.Date(paste(nga_wm_21$WM6Y, nga_wm_21$WM6M, nga_wm_21$WM6D, sep = "-"), format = "%Y-%m-%d")
nga_wm_21 <- subset(nga_wm_21, !is.na(nga_wm_21$int_day))
nga_wm_21$WM6Y <- NULL
nga_wm_21$WM6M <- NULL
nga_wm_21$WM6D <- NULL

### SHRH ###
# Using contraception
nga_wm_21$contracep <- ifelse(nga_wm_21$CP2==1,1,NA)
nga_wm_21$contracep[nga_wm_21$CP2 == 2] <- 0
nga_wm_21$CP2 <- NULL

# Condom use    
nga_wm_21$condom <- ifelse(nga_wm_21$SB3==1,1,NA)
nga_wm_21$condom[nga_wm_21$SB3 == 2] <- 0
nga_wm_21$SB3 <- NULL

# Are you currently a sex worker?
nga_wm_21$sex_worker <- ifelse(nga_wm_21$SB4==5,1,0)
nga_wm_21$SB4 <- NULL

#----2.6 Clean Men Data Set----
names(nga_mn_21)[names(nga_mn_21) == "mnweight"] <- "weight"

# Household received any social transfer or benefit
nga_mn_21$ST3A[nga_mn_21$ST3A>2] <- NA
nga_mn_21$ST3B[nga_mn_21$ST3B>2] <- NA
nga_mn_21$ST3C[nga_mn_21$ST3C>2] <- NA
nga_mn_21$ST3D[nga_mn_21$ST3D>2] <- NA

nga_mn_21$ST3A[nga_mn_21$ST3A==2] <- 0
nga_mn_21$ST3B[nga_mn_21$ST3B==2] <- 0
nga_mn_21$ST3C[nga_mn_21$ST3C==2] <- 0
nga_mn_21$ST3D[nga_mn_21$ST3D==2] <- 0

nga_mn_21$soc_pro <- ifelse(nga_mn_21$ST3A==1, 1, NA)
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3A==0] <- 0
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3B==1] <- 1
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3B==0] <- 0
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3C==1] <- 1
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3C==0] <- 0
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3D==1] <- 1
nga_mn_21$soc_pro[is.na(nga_mn_21$soc_pro) & nga_mn_21$ST3D==0] <- 0

# Household Size
names(nga_mn_21)[names(nga_mn_21) == "HH48"] <- "size"

# No. of social protection programs received
nga_mn_21$soc_pro_n <- ifelse(is.na(nga_mn_21$ST3A), 0, nga_mn_21$ST3A) + ifelse(is.na(nga_mn_21$ST3B), 0, nga_mn_21$ST3B) + ifelse(is.na(nga_mn_21$ST3C), 0, nga_mn_21$ST3C)

# No. of social protection programs received / No. of people in the household
nga_mn_21$soc_pro_pc <- nga_mn_21$soc_pro_n/nga_mn_21$size

# Total No. of months since last assistance 
nga_mn_21$ST4A[nga_mn_21$ST4A>2] <- NA
nga_mn_21$ST4B[nga_mn_21$ST4B>2] <- NA
nga_mn_21$ST4C[nga_mn_21$ST4C>2] <- NA
nga_mn_21$ST4D[nga_mn_21$ST4D>2] <- NA

nga_mn_21$ST4A_M[nga_mn_21$ST4A_M==99] <- NA
nga_mn_21$ST4B_M[nga_mn_21$ST4B_M==98] <- NA
nga_mn_21$ST4C_M[nga_mn_21$ST4C_M==98] <- NA
nga_mn_21$ST4D_M[nga_mn_21$ST4D_M==98] <- NA

nga_mn_21$soc_cash_m <- nga_mn_21$ST4A*nga_mn_21$ST4A_M
nga_mn_21$soc_hup_m <- nga_mn_21$ST4B*nga_mn_21$ST4B_M
nga_mn_21$soc_pension_m <- nga_mn_21$ST4C*nga_mn_21$ST4C_M
nga_mn_21$soc_other_m <- nga_mn_21$ST4D*nga_mn_21$ST4D_M

# Received Cash Transfer
names(nga_mn_21)[names(nga_mn_21) == "ST3A"] <- "soc_cash"

# Received HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”
names(nga_mn_21)[names(nga_mn_21) == "ST3B"] <- "soc_hup"

# Received a retirement pension
names(nga_mn_21)[names(nga_mn_21) == "ST3C"] <- "soc_pension"

# Received any other assistance
names(nga_mn_21)[names(nga_mn_21) == "ST3D"] <- "soc_other"

# Received tuition aid
names(nga_mn_21)[names(nga_mn_21) == "ED12"] <- "soc_tuition"

nga_mn_21$ST4A <- NULL
nga_mn_21$ST4B <- NULL
nga_mn_21$ST4C <- NULL
nga_mn_21$ST4D <- NULL

nga_mn_21$ST4A_M <- NULL
nga_mn_21$ST4B_M <- NULL
nga_mn_21$ST4C_M <- NULL
nga_mn_21$ST4D_M <- NULL

# Total No. of months since last assistance (including multiple but excluding school tuition)
nga_mn_21$soc_m <- pmin(nga_mn_21$soc_cash_m, nga_mn_21$soc_hup_m, nga_mn_21$soc_pension_m, nga_mn_21$soc_other_m, na.rm = TRUE)

# Rural
nga_mn_21$rural <- ifelse(nga_mn_21$HH6==1,1,NA)
nga_mn_21$rural[nga_mn_21$HH6==2] <- 0
nga_mn_21$HH6 <- NULL 

# State
names(nga_mn_21)[names(nga_mn_21) == "HH7"] <- "state"

# Age
names(nga_mn_21)[names(nga_mn_21) == "MWB4"] <- "age"

# School Attendance in 2020-2021
nga_mn_21$MWB9[nga_mn_21$MWB9>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "MWB9"] <- "school20"
nga_mn_21$school20[nga_mn_21$school20==2] <- 0

# School Attendance in 2019-2020
nga_mn_21$MWB11[nga_mn_21$MWB11>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "MWB11"] <- "school19"
nga_mn_21$school19[nga_mn_21$school19==2] <- 0

# School Dropout
nga_mn_21$MWB6A[nga_mn_21$MWB6A>41] <- NA
nga_mn_21$MWB7[nga_mn_21$MWB7>2] <- NA
nga_mn_21$school_drop <- ifelse(nga_mn_21$school20==0 & nga_mn_21$school19==1 & nga_mn_21$MWB6A<41 & nga_mn_21$MWB7==2, 1, NA)
nga_mn_21$school_drop[nga_mn_21$school20==1 & nga_mn_21$school19==1] <- 0
nga_mn_21$school_drop[nga_mn_21$school20==0 & nga_mn_21$school19==1 & nga_mn_21$MWB6>21 & nga_mn_21$MWB7==1] <- 0
nga_mn_21$MWB6A <- NULL
nga_mn_21$MWB7 <- NULL

# Child Marriage
nga_mn_21$MMA8Y[nga_mn_21$MMA8Y>9997] <- NA
names(nga_mn_21)[names(nga_mn_21) == "MMA8Y"] <- "marriage_date"

nga_mn_21$MMA11[nga_mn_21$MMA11==99] <- NA
names(nga_mn_21)[names(nga_mn_21) == "MMA11"] <- "marriage_age"

nga_mn_21$marriage_child <- ifelse(nga_mn_21$marriage_age<19,1,0)

# Mental health
nga_mn_21$MLS1[nga_mn_21$MLS1>9] <- NA
nga_mn_21$happiness_20 <- ifelse(nga_mn_21$MLS1==1,2,NA)
nga_mn_21$happiness_20[nga_mn_21$MLS1==2] <- 1
nga_mn_21$happiness_20[nga_mn_21$MLS1==3] <- 0
nga_mn_21$happiness_20[nga_mn_21$MLS1==4] <- -1
nga_mn_21$happiness_20[nga_mn_21$MLS1==5] <- -2
nga_mn_21$MLS1 <- NULL

nga_mn_21$MLS3[nga_mn_21$MLS3>9] <- NA
nga_mn_21$happiness_change <- ifelse(nga_mn_21$MLS3==2,0,NA)
nga_mn_21$happiness_change[nga_mn_21$MLS3==1] <- 1
nga_mn_21$happiness_change[nga_mn_21$MLS3==3] <- -1
nga_mn_21$MLS3 <- NULL

# Calculate Proxy for Happiness 2021:
nga_mn_21$happiness_21 <- nga_mn_21$happiness_20+nga_mn_21$happiness_change

#--Food Insecurity & COVID--#
# 1) Food insecurity: worried about not having enough food to eat because of a lack of money or other resources
nga_mn_21$FE1[nga_mn_21$FE1>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE1"] <- "food1_20"
nga_mn_21$food1_20[nga_mn_21$food1_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE1A[nga_mn_21$FE1A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE1A"] <- "food1_covid"
nga_mn_21$food1_covid[nga_mn_21$food1_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE1B[nga_mn_21$FE1B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE1B"] <- "food1_21"
nga_mn_21$food1_21[nga_mn_21$food1_21==2] <- 0

# 2) Food insecurity: were unable to eat healthy and nutritious food because of a lack of money or other resources
nga_mn_21$FE2[nga_mn_21$FE2>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE2"] <- "food2_20"
nga_mn_21$food2_20[nga_mn_21$food2_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE2A[nga_mn_21$FE2A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE2A"] <- "food2_covid"
nga_mn_21$food2_covid[nga_mn_21$food2_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE2B[nga_mn_21$FE2B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE2B"] <- "food2_21"
nga_mn_21$food2_21[nga_mn_21$food2_21==2] <- 0

# 3) Food insecurity: ate only a few kinds of foods because of a lack of money or other resources
nga_mn_21$FE3[nga_mn_21$FE3>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE3"] <- "food3_20"
nga_mn_21$food3_20[nga_mn_21$food3_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE3A[nga_mn_21$FE3A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE3A"] <- "food3_covid"
nga_mn_21$food3_covid[nga_mn_21$food3_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE3B[nga_mn_21$FE3B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE3B"] <- "food3_21"
nga_mn_21$food3_21[nga_mn_21$food3_21==2] <- 0

# 4) Food insecurity:  skip a meal because there was not enough money or other resources to get food
nga_mn_21$FE4[nga_mn_21$FE4>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE4"] <- "food4_20"
nga_mn_21$food4_20[nga_mn_21$food4_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE4A[nga_mn_21$FE4A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE4A"] <- "food4_covid"
nga_mn_21$food4_covid[nga_mn_21$food4_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE4B[nga_mn_21$FE4B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE4B"] <- "food4_21"
nga_mn_21$food4_21[nga_mn_21$food4_21==2] <- 0

# 5) Food insecurity: ate less than you thought you should because of a lack of money or other resources
nga_mn_21$FE5[nga_mn_21$FE5>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE5"] <- "food5_20"
nga_mn_21$food5_20[nga_mn_21$food5_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE5A[nga_mn_21$FE5A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE5A"] <- "food5_covid"
nga_mn_21$food5_covid[nga_mn_21$food5_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE5B[nga_mn_21$FE5B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE5B"] <- "food5_21"
nga_mn_21$food5_21[nga_mn_21$food5_21==2] <- 0

# 6) Food insecurity: ran out of food because of a lack of money or other resources
nga_mn_21$FE6[nga_mn_21$FE6>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE6"] <- "food6_20"
nga_mn_21$food6_20[nga_mn_21$food6_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE6A[nga_mn_21$FE6A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE6A"] <- "food6_covid"
nga_mn_21$food6_covid[nga_mn_21$food6_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE6B[nga_mn_21$FE6B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE6B"] <- "food6_21"
nga_mn_21$food6_21[nga_mn_21$food6_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_mn_21$FE6C[nga_mn_21$FE6C>3] <- NA
nga_mn_21$food6_int_21 <- ifelse(nga_mn_21$food6_21==1,nga_mn_21$FE6C,0)
nga_mn_21$FE6C <- NULL

# 7) Food insecurity: were hungry but did not eat because there was not enough money or other resources for food
nga_mn_21$FE7[nga_mn_21$FE7>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE7"] <- "food7_20"
nga_mn_21$food7_20[nga_mn_21$food7_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE7A[nga_mn_21$FE7A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE7A"] <- "food7_covid"
nga_mn_21$food7_covid[nga_mn_21$food7_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE7B[nga_mn_21$FE7B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE7B"] <- "food7_21"
nga_mn_21$food7_21[nga_mn_21$food7_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_mn_21$FE7C[nga_mn_21$FE7C>3] <- NA
nga_mn_21$food7_int_21 <- ifelse(nga_mn_21$food7_21==1,nga_mn_21$FE7C,0)
nga_mn_21$FE7C <- NULL

# 8) Food insecurity: went without eating for a whole day because of a lack of money or other resources
nga_mn_21$FE8[nga_mn_21$FE8>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE8"] <- "food8_20"
nga_mn_21$food8_20[nga_mn_21$food8_20==2] <- 0
# Was this due to COVID-19?
nga_mn_21$FE8A[nga_mn_21$FE8A>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE8A"] <- "food8_covid"
nga_mn_21$food8_covid[nga_mn_21$food8_covid==2] <- 0
# Did this happen during the last month?
nga_mn_21$FE8B[nga_mn_21$FE8B>2] <- NA
names(nga_mn_21)[names(nga_mn_21) == "FE8B"] <- "food8_21"
nga_mn_21$food8_21[nga_mn_21$food8_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_mn_21$FE8C[nga_mn_21$FE8C>3] <- NA
nga_mn_21$food8_int_21 <- ifelse(nga_mn_21$food8_21==1,nga_mn_21$FE8C,0)
nga_mn_21$FE8C <- NULL

# Food insecurity intensity in 2020
nga_mn_21$food_20 <- ifelse(nga_mn_21$food1_20==0,0,NA)
nga_mn_21$food_20[nga_mn_21$food1_20==1] <- 1
nga_mn_21$food_20[nga_mn_21$food2_20==1] <- 2
nga_mn_21$food_20[nga_mn_21$food3_20==1] <- 3
nga_mn_21$food_20[nga_mn_21$food4_20==1] <- 4
nga_mn_21$food_20[nga_mn_21$food5_20==1] <- 5
nga_mn_21$food_20[nga_mn_21$food6_20==1] <- 6
nga_mn_21$food_20[nga_mn_21$food7_20==1] <- 7
nga_mn_21$food_20[nga_mn_21$food8_20==1] <- 8

# Food insecurity intensity in 2021
nga_mn_21$food_21 <- ifelse(nga_mn_21$food1_21==0,0,NA)
nga_mn_21$food_21[nga_mn_21$food1_21==1] <- 1
nga_mn_21$food_21[nga_mn_21$food2_21==1] <- 2
nga_mn_21$food_21[nga_mn_21$food3_21==1] <- 3
nga_mn_21$food_21[nga_mn_21$food4_21==1] <- 4
nga_mn_21$food_21[nga_mn_21$food5_21==1] <- 5
nga_mn_21$food_21[nga_mn_21$food6_21==1] <- 6
nga_mn_21$food_21[nga_mn_21$food7_21==1] <- 7
nga_mn_21$food_21[nga_mn_21$food8_21==1] <- 8

#----2.7 Clean Children Data Set----
names(nga_ch_21)[names(nga_ch_21) == "chweight"] <- "weight"

# Household received any social transfer or benefit
nga_ch_21$ST3A[nga_ch_21$ST3A>2] <- NA
nga_ch_21$ST3B[nga_ch_21$ST3B>2] <- NA
nga_ch_21$ST3C[nga_ch_21$ST3C>2] <- NA
nga_ch_21$ST3D[nga_ch_21$ST3D>2] <- NA

nga_ch_21$ST3A[nga_ch_21$ST3A==2] <- 0
nga_ch_21$ST3B[nga_ch_21$ST3B==2] <- 0
nga_ch_21$ST3C[nga_ch_21$ST3C==2] <- 0
nga_ch_21$ST3D[nga_ch_21$ST3D==2] <- 0

nga_ch_21$soc_pro <- ifelse(nga_ch_21$ST3A==1, 1, NA)
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3A==0] <- 0
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3B==1] <- 1
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3B==0] <- 0
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3C==1] <- 1
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3C==0] <- 0
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3D==1] <- 1
nga_ch_21$soc_pro[is.na(nga_ch_21$soc_pro) & nga_ch_21$ST3D==0] <- 0

# Household Size
names(nga_ch_21)[names(nga_ch_21) == "HH48"] <- "size"

# No. of social protection programs received
nga_ch_21$soc_pro_n <- ifelse(is.na(nga_ch_21$ST3A), 0, nga_ch_21$ST3A) + ifelse(is.na(nga_ch_21$ST3B), 0, nga_ch_21$ST3B) + ifelse(is.na(nga_ch_21$ST3C), 0, nga_ch_21$ST3C)

# No. of social protection programs received / No. of people in the household
nga_ch_21$soc_pro_pc <- nga_ch_21$soc_pro_n/nga_ch_21$size

# Total No. of months since last assistance 
nga_ch_21$ST4A[nga_ch_21$ST4A>2] <- NA
nga_ch_21$ST4B[nga_ch_21$ST4B>2] <- NA
nga_ch_21$ST4C[nga_ch_21$ST4C>2] <- NA
nga_ch_21$ST4D[nga_ch_21$ST4D>2] <- NA

nga_ch_21$ST4A_M[nga_ch_21$ST4A_M==99] <- NA
nga_ch_21$ST4B_M[nga_ch_21$ST4B_M==98] <- NA
nga_ch_21$ST4C_M[nga_ch_21$ST4C_M==98] <- NA
nga_ch_21$ST4D_M[nga_ch_21$ST4D_M==98] <- NA

nga_ch_21$soc_cash_m <- nga_ch_21$ST4A*nga_ch_21$ST4A_M
nga_ch_21$soc_hup_m <- nga_ch_21$ST4B*nga_ch_21$ST4B_M
nga_ch_21$soc_pension_m <- nga_ch_21$ST4C*nga_ch_21$ST4C_M
nga_ch_21$soc_other_m <- nga_ch_21$ST4D*nga_ch_21$ST4D_M

# Received Cash Transfer
names(nga_ch_21)[names(nga_ch_21) == "ST3A"] <- "soc_cash"

# Received HOUSEHOLD UPLIFTING PROGRAMME (HUP) –“BETA DON COME”
names(nga_ch_21)[names(nga_ch_21) == "ST3B"] <- "soc_hup"

# Received a retirement pension
names(nga_ch_21)[names(nga_ch_21) == "ST3C"] <- "soc_pension"

# Received any other assistance
names(nga_ch_21)[names(nga_ch_21) == "ST3D"] <- "soc_other"

# Received tuition aid
names(nga_ch_21)[names(nga_ch_21) == "ED12"] <- "soc_tuition"

nga_ch_21$ST4A <- NULL
nga_ch_21$ST4B <- NULL
nga_ch_21$ST4C <- NULL
nga_ch_21$ST4D <- NULL

nga_ch_21$ST4A_M <- NULL
nga_ch_21$ST4B_M <- NULL
nga_ch_21$ST4C_M <- NULL
nga_ch_21$ST4D_M <- NULL

# Total No. of months since last assistance (including multiple but excluding school tuition)
nga_ch_21$soc_m <- pmin(nga_ch_21$soc_cash_m, nga_ch_21$soc_hup_m, nga_ch_21$soc_pension_m, nga_ch_21$soc_other_m, na.rm = TRUE)

# Rural
nga_ch_21$rural <- ifelse(nga_ch_21$HH6==1,1,NA)
nga_ch_21$rural[nga_ch_21$HH6==2] <- 0
nga_ch_21$HH6 <- NULL 

# State
names(nga_ch_21)[names(nga_ch_21) == "HH7"] <- "state"

# Age
names(nga_ch_21)[names(nga_ch_21) == "UB2"] <- "age"

# Born after 2019
nga_ch_21$UB1Y[nga_ch_21$UB1Y==9999] <- NA
nga_ch_21$born_post19 <- ifelse(nga_ch_21$UB1Y>2019,1,0)
nga_ch_21$UB1Y <- NULL

# School Attendance in 2020-2021
nga_ch_21$UB7[nga_ch_21$UB7>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "UB7"] <- "school20"
nga_ch_21$school20[nga_ch_21$school20==2] <- 0

# School Attendance in 2019-2020
nga_ch_21$UB6[nga_ch_21$UB6>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "UB6"] <- "school19"
nga_ch_21$school19[nga_ch_21$school19==2] <- 0

# School Dropout
nga_ch_21$school_drop <- ifelse(nga_ch_21$school20==0 & nga_ch_21$school19==1, 1, NA)
nga_ch_21$school_drop[nga_ch_21$school20==1 & nga_ch_21$school19==1] <- 0

# Birth Certificate
names(nga_ch_21)[names(nga_ch_21) == "BR1"] <- "birth_cert"
nga_ch_21$birth_cert[nga_ch_21$birth_cert==2] <- 1
nga_ch_21$birth_cert[nga_ch_21$birth_cert==3] <- 0
nga_ch_21$birth_cert[nga_ch_21$birth_cert==8] <- NA
nga_ch_21$birth_cert[nga_ch_21$birth_cert==9] <- NA

# Vaccination card
names(nga_ch_21)[names(nga_ch_21) == "IM2"] <- "vacs_card"
nga_ch_21$vacs_card[nga_ch_21$vacs_card==2] <- 1
nga_ch_21$vacs_card[nga_ch_21$vacs_card==3] <- 1
nga_ch_21$vacs_card[nga_ch_21$vacs_card==4] <- 0
nga_ch_21$vacs_card[nga_ch_21$vacs_card==9] <- NA

# Received any immunisation after 2019
nga_ch_21$IM6BY[nga_ch_21$IM6BY==9999] <- NA
nga_ch_21$IM6H0Y[nga_ch_21$IM6H0Y==9999] <- NA
nga_ch_21$IM6IY[nga_ch_21$IM6IY==9999] <- NA
nga_ch_21$IM6N2Y[nga_ch_21$IM6N2Y==9999] <- NA
nga_ch_21$IM6P0Y[nga_ch_21$IM6P0Y==9999] <- NA
nga_ch_21$IM6P1Y[nga_ch_21$IM6P1Y==9999] <- NA
nga_ch_21$IM6P2Y[nga_ch_21$IM6P2Y==9999] <- NA
nga_ch_21$IM6P3Y[nga_ch_21$IM6P3Y==9999] <- NA
nga_ch_21$IM6PCV1Y[nga_ch_21$IM6PCV1Y==9999] <- NA
nga_ch_21$IM6PCV2Y[nga_ch_21$IM6PCV2Y==9999] <- NA
nga_ch_21$IM6PCV3Y[nga_ch_21$IM6PCV3Y==9999] <- NA
nga_ch_21$IM6PENTA1Y[nga_ch_21$IM6PENTA1Y==9999] <- NA
nga_ch_21$IM6PENTA2Y[nga_ch_21$IM6PENTA2Y==9999] <- NA
nga_ch_21$IM6PENTA3Y[nga_ch_21$IM6PENTA3Y==9999] <- NA
nga_ch_21$IM6YY[nga_ch_21$IM6YY==9999] <- NA
nga_ch_21$IM6Z1Y[nga_ch_21$IM6Z1Y==9999] <- NA
nga_ch_21$IM6Z2Y[nga_ch_21$IM6Z2Y==9999] <- NA

nga_ch_21$vacs_post20 <- ifelse(nga_ch_21$IM6BY>2020 | 
                             nga_ch_21$IM6H0Y>2020 |
                             nga_ch_21$IM6IY>2020 |
                             nga_ch_21$IM6MVY>2020 |
                             nga_ch_21$IM6N1Y>2020 |
                             nga_ch_21$IM6N2Y>2020 |
                             nga_ch_21$IM6P0Y>2020 |
                             nga_ch_21$IM6P1Y>2020 |
                             nga_ch_21$IM6P2Y>2020 |
                             nga_ch_21$IM6P3Y>2020 |
                             nga_ch_21$IM6PCV1Y>2020 |
                             nga_ch_21$IM6PCV2Y>2020 |
                             nga_ch_21$IM6PCV3Y>2020 |
                             nga_ch_21$IM6PENTA1Y>2020 |
                             nga_ch_21$IM6PENTA2Y>2020 |
                             nga_ch_21$IM6PENTA3Y>2020 |
                             nga_ch_21$IM6YY>2020 |
                             nga_ch_21$IM6Z1Y>2020 |
                             nga_ch_21$IM6Z2Y>2020, 1, 0)

nga_ch_21$vacs_pre21 <- ifelse(nga_ch_21$IM6BY<2021 | 
                               nga_ch_21$IM6H0Y<2021 |
                               nga_ch_21$IM6IY<2021 |
                               nga_ch_21$IM6MVY<2021 |
                               nga_ch_21$IM6N1Y<2021 |
                               nga_ch_21$IM6N2Y<2021 |
                               nga_ch_21$IM6P0Y<2021 |
                               nga_ch_21$IM6P1Y<2021 |
                               nga_ch_21$IM6P2Y<2021 |
                               nga_ch_21$IM6P3Y<2021 |
                               nga_ch_21$IM6PCV1Y<2021 |
                               nga_ch_21$IM6PCV2Y<2021 |
                               nga_ch_21$IM6PCV3Y<2021 |
                               nga_ch_21$IM6PENTA1Y<2021 |
                               nga_ch_21$IM6PENTA2Y<2021 |
                               nga_ch_21$IM6PENTA3Y<2021 |
                               nga_ch_21$IM6YY<2021 |
                               nga_ch_21$IM6Z1Y<2021 |
                               nga_ch_21$IM6Z2Y<2021, 1, 0)

#--Food Insecurity & COVID--#
# 1) Food insecurity: worried about not having enough food to eat because of a lack of money or other resources
nga_ch_21$FE1[nga_ch_21$FE1>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE1"] <- "food1_20"
nga_ch_21$food1_20[nga_ch_21$food1_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE1A[nga_ch_21$FE1A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE1A"] <- "food1_covid"
nga_ch_21$food1_covid[nga_ch_21$food1_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE1B[nga_ch_21$FE1B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE1B"] <- "food1_21"
nga_ch_21$food1_21[nga_ch_21$food1_21==2] <- 0

# 2) Food insecurity: were unable to eat healthy and nutritious food because of a lack of money or other resources
nga_ch_21$FE2[nga_ch_21$FE2>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE2"] <- "food2_20"
nga_ch_21$food2_20[nga_ch_21$food2_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE2A[nga_ch_21$FE2A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE2A"] <- "food2_covid"
nga_ch_21$food2_covid[nga_ch_21$food2_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE2B[nga_ch_21$FE2B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE2B"] <- "food2_21"
nga_ch_21$food2_21[nga_ch_21$food2_21==2] <- 0

# 3) Food insecurity: ate only a few kinds of foods because of a lack of money or other resources
nga_ch_21$FE3[nga_ch_21$FE3>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE3"] <- "food3_20"
nga_ch_21$food3_20[nga_ch_21$food3_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE3A[nga_ch_21$FE3A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE3A"] <- "food3_covid"
nga_ch_21$food3_covid[nga_ch_21$food3_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE3B[nga_ch_21$FE3B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE3B"] <- "food3_21"
nga_ch_21$food3_21[nga_ch_21$food3_21==2] <- 0

# 4) Food insecurity:  skip a meal because there was not enough money or other resources to get food
nga_ch_21$FE4[nga_ch_21$FE4>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE4"] <- "food4_20"
nga_ch_21$food4_20[nga_ch_21$food4_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE4A[nga_ch_21$FE4A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE4A"] <- "food4_covid"
nga_ch_21$food4_covid[nga_ch_21$food4_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE4B[nga_ch_21$FE4B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE4B"] <- "food4_21"
nga_ch_21$food4_21[nga_ch_21$food4_21==2] <- 0

# 5) Food insecurity: ate less than you thought you should because of a lack of money or other resources
nga_ch_21$FE5[nga_ch_21$FE5>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE5"] <- "food5_20"
nga_ch_21$food5_20[nga_ch_21$food5_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE5A[nga_ch_21$FE5A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE5A"] <- "food5_covid"
nga_ch_21$food5_covid[nga_ch_21$food5_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE5B[nga_ch_21$FE5B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE5B"] <- "food5_21"
nga_ch_21$food5_21[nga_ch_21$food5_21==2] <- 0

# 6) Food insecurity: ran out of food because of a lack of money or other resources
nga_ch_21$FE6[nga_ch_21$FE6>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE6"] <- "food6_20"
nga_ch_21$food6_20[nga_ch_21$food6_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE6A[nga_ch_21$FE6A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE6A"] <- "food6_covid"
nga_ch_21$food6_covid[nga_ch_21$food6_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE6B[nga_ch_21$FE6B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE6B"] <- "food6_21"
nga_ch_21$food6_21[nga_ch_21$food6_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_ch_21$FE6C[nga_ch_21$FE6C>3] <- NA
nga_ch_21$food6_int_21 <- ifelse(nga_ch_21$food6_21==1,nga_ch_21$FE6C,0)
nga_ch_21$FE6C <- NULL

# 7) Food insecurity: were hungry but did not eat because there was not enough money or other resources for food
nga_ch_21$FE7[nga_ch_21$FE7>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE7"] <- "food7_20"
nga_ch_21$food7_20[nga_ch_21$food7_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE7A[nga_ch_21$FE7A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE7A"] <- "food7_covid"
nga_ch_21$food7_covid[nga_ch_21$food7_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE7B[nga_ch_21$FE7B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE7B"] <- "food7_21"
nga_ch_21$food7_21[nga_ch_21$food7_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_ch_21$FE7C[nga_ch_21$FE7C>3] <- NA
nga_ch_21$food7_int_21 <- ifelse(nga_ch_21$food7_21==1,nga_ch_21$FE7C,0)
nga_ch_21$FE7C <- NULL

# 8) Food insecurity: went without eating for a whole day because of a lack of money or other resources
nga_ch_21$FE8[nga_ch_21$FE8>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE8"] <- "food8_20"
nga_ch_21$food8_20[nga_ch_21$food8_20==2] <- 0
# Was this due to COVID-19?
nga_ch_21$FE8A[nga_ch_21$FE8A>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE8A"] <- "food8_covid"
nga_ch_21$food8_covid[nga_ch_21$food8_covid==2] <- 0
# Did this happen during the last month?
nga_ch_21$FE8B[nga_ch_21$FE8B>2] <- NA
names(nga_ch_21)[names(nga_ch_21) == "FE8B"] <- "food8_21"
nga_ch_21$food8_21[nga_ch_21$food8_21==2] <- 0
# Intensity: How often did this happen during the last 1 month? Would you say: 1=rarely, 2=sometimes or 3=often?
nga_ch_21$FE8C[nga_ch_21$FE8C>3] <- NA
nga_ch_21$food8_int_21 <- ifelse(nga_ch_21$food8_21==1,nga_ch_21$FE8C,0)
nga_ch_21$FE8C <- NULL

# Food insecurity intensity in 2020
nga_ch_21$food_20 <- ifelse(nga_ch_21$food1_20==0,0,NA)
nga_ch_21$food_20[nga_ch_21$food1_20==1] <- 1
nga_ch_21$food_20[nga_ch_21$food2_20==1] <- 2
nga_ch_21$food_20[nga_ch_21$food3_20==1] <- 3
nga_ch_21$food_20[nga_ch_21$food4_20==1] <- 4
nga_ch_21$food_20[nga_ch_21$food5_20==1] <- 5
nga_ch_21$food_20[nga_ch_21$food6_20==1] <- 6
nga_ch_21$food_20[nga_ch_21$food7_20==1] <- 7
nga_ch_21$food_20[nga_ch_21$food8_20==1] <- 8

# Food insecurity intensity in 2021
nga_ch_21$food_21 <- ifelse(nga_ch_21$food1_21==0,0,NA)
nga_ch_21$food_21[nga_ch_21$food1_21==1] <- 1
nga_ch_21$food_21[nga_ch_21$food2_21==1] <- 2
nga_ch_21$food_21[nga_ch_21$food3_21==1] <- 3
nga_ch_21$food_21[nga_ch_21$food4_21==1] <- 4
nga_ch_21$food_21[nga_ch_21$food5_21==1] <- 5
nga_ch_21$food_21[nga_ch_21$food6_21==1] <- 6
nga_ch_21$food_21[nga_ch_21$food7_21==1] <- 7
nga_ch_21$food_21[nga_ch_21$food8_21==1] <- 8

# Currently attending childhood education
nga_ch_21$school_21 <- ifelse(nga_ch_21$UB8==1,1,NA)
nga_ch_21$school_21[nga_ch_21$UB8==2] <- 0
nga_ch_21$UB8 <- NULL

# On how many days during the last week was the child left alone for more than an hour?
names(nga_ch_21)[names(nga_ch_21) == "EC3A"] <- "neglect1"

# On how many days during the last week was the child left in care of another child that is less than 10 years old?
names(nga_ch_21)[names(nga_ch_21) == "EC3B"] <- "neglect2"

# During the past 3 days, did you or any household member older that 15 engaged with: reading books?
nga_ch_21$reading <- ifelse(nga_ch_21$EC5AY=="Y",0,1)
nga_ch_21$reading[nga_ch_21$EC5AY=="?"] <- NA
nga_ch_21$EC5AY <- NULL

# During the past 3 days, did you or any household member older that 15 engaged with: story telling?
nga_ch_21$story <- ifelse(nga_ch_21$EC5BY=="Y",0,1)
nga_ch_21$story[nga_ch_21$EC5BY=="?"] <- NA
nga_ch_21$EC5BY <- NULL

# During the past 3 days, did you or any household member older that 15 engaged with: singing?
nga_ch_21$singing <- ifelse(nga_ch_21$EC5CY=="Y",0,1)
nga_ch_21$singing[nga_ch_21$EC5CY=="?"] <- NA
nga_ch_21$EC5CY <- NULL

# During the past 3 days, did you or any household member older that 15 engaged with: going outside?
nga_ch_21$outside <- ifelse(nga_ch_21$EC5DY=="Y",0,1)
nga_ch_21$outside[nga_ch_21$EC5DY=="?"] <- NA
nga_ch_21$EC5DY <- NULL

# During the past 3 days, did you or any household member older that 15 engaged with: playing?
nga_ch_21$playing <- ifelse(nga_ch_21$EC5EY=="Y",0,1)
nga_ch_21$playing[nga_ch_21$EC5EY=="?"] <- NA
nga_ch_21$EC5EY <- NULL

# How often does the child seem sad or depressed?: 0=Never, 1=Once a year, ..., 4=Daily
nga_ch_21$depressed <- ifelse(nga_ch_21$EC39==5,0,NA)
nga_ch_21$depressed[nga_ch_21$EC39==4] <- 1
nga_ch_21$depressed[nga_ch_21$EC39==3] <- 2
nga_ch_21$depressed[nga_ch_21$EC39==2] <- 3
nga_ch_21$depressed[nga_ch_21$EC39==1] <- 4
nga_ch_21$EC39 <- NULL

# How often does he/she display aggresive behavior?: 0=Not at all, ..., 4=A lot more
nga_ch_21$depressed <- ifelse(nga_ch_21$EC40==1,0,NA)
nga_ch_21$depressed[nga_ch_21$EC40==2] <- 1
nga_ch_21$depressed[nga_ch_21$EC40==3] <- 2
nga_ch_21$depressed[nga_ch_21$EC40==4] <- 3
nga_ch_21$depressed[nga_ch_21$EC40==5] <- 4
nga_ch_21$EC40 <- NULL

# During the last month, have you: spanked or hit your child?
nga_ch_21$violence_1 <- ifelse(nga_ch_21$UCD2F==1,1,NA)
nga_ch_21$violence_1[nga_ch_21$UCD2F==2] <- 0
nga_ch_21$UCD2F <- NULL

# During the last month, have you: spanked or hit your child?
nga_ch_21$violence_2 <- ifelse(nga_ch_21$UCD2G==1,1,NA)
nga_ch_21$violence_2[nga_ch_21$UCD2G==2] <- 0
nga_ch_21$UCD2G <- NULL

# During the last month, have you: called your child dumb, lazy, or another name?
nga_ch_21$violence_3 <- ifelse(nga_ch_21$UCD2H==1,1,NA)
nga_ch_21$violence_3[nga_ch_21$UCD2H==2] <- 0
nga_ch_21$UCD2H <- NULL

# During the last month, have you: hit or slapped your child's face?
nga_ch_21$violence_4 <- ifelse(nga_ch_21$UCD2I==1,1,NA)
nga_ch_21$violence_4[nga_ch_21$UCD2I==2] <- 0
nga_ch_21$UCD2I <- NULL

# During the last month, have you: hit or slapped your child's leg?
nga_ch_21$violence_5 <- ifelse(nga_ch_21$UCD2J==1,1,NA)
nga_ch_21$violence_5[nga_ch_21$UCD2J==2] <- 0
nga_ch_21$UCD2J <- NULL

# During the last month, have you: bitten up your child?
nga_ch_21$violence_6 <- ifelse(nga_ch_21$UCD2K==1,1,NA)
nga_ch_21$violence_6[nga_ch_21$UCD2K==2] <- 0
nga_ch_21$UCD2K <- NULL

# Interview Date
nga_ch_21$int_day <- nga_ch_21$date <- as.Date(paste(nga_ch_21$UF7Y, nga_ch_21$UF7M, nga_ch_21$UF7D, sep = "-"), format = "%Y-%m-%d")
nga_ch_21$UF7Y <- NULL
nga_ch_21$UF7M <- NULL
nga_ch_21$UF7D <- NULL

# Child abuse
child_abuse_columns <- c("violence_1", "violence_2", "violence_3", 
                         "violence_4", "violence_5", "violence_6")

# Create the new indicator in the nga_ch_21 dataset
nga_ch_21 <- nga_ch_21 %>%
    mutate(child_abuse = case_when(
        rowSums(select(., all_of(child_abuse_columns)) == 1, na.rm = TRUE) > 0 ~ 1,  # If any indicator is 1, set to 1
        rowSums(!is.na(select(., all_of(child_abuse_columns)))) == 0 ~ NA_real_,  # If all indicators are NA, set to NA
        TRUE ~ 0  # Otherwise, set to 0
    ))

```

D.2a Extract Soil Moisture Values for Each Household
```{r}
# Load necessary libraries
library(sf)
library(raster)
library(dplyr)

# Check if the soil moisture stack exists
if (exists("soil_moisture_stack")) {
  # Convert nga_hl_21 to an sf object
  nga_hl_21_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
  
  # Extract soil moisture values for each household's location
  soil_moisture_values <- extract(soil_moisture_stack, as(nga_hl_21_sf, "Spatial"))
  
  # Check if extraction was successful
  print(head(soil_moisture_values))
  
  if (!is.null(soil_moisture_values) && ncol(soil_moisture_values) > 0) {
    # Convert to a data frame and ensure unique column names
    soil_moisture_df <- as.data.frame(soil_moisture_values)
    colnames(soil_moisture_df) <- paste0("soil_moisture_", seq_len(ncol(soil_moisture_df)))
    
    # Bind soil moisture data to household data
    nga_hl_21 <- cbind(nga_hl_21, soil_moisture_df)
    
    # Manually rename soil moisture variables
    soil_moisture_vars <- c(
      "soil_moisture_1" = "soil_2020_01",
      "soil_moisture_2" = "soil_2020_02",
      "soil_moisture_3" = "soil_2020_03",
      "soil_moisture_4" = "soil_2020_04",
      "soil_moisture_5" = "soil_2020_05",
      "soil_moisture_6" = "soil_2020_06",
      "soil_moisture_7" = "soil_2020_07",
      "soil_moisture_8" = "soil_2020_08",
      "soil_moisture_9" = "soil_2020_09",
      "soil_moisture_10" = "soil_2020_10",
      "soil_moisture_11" = "soil_2020_11",
      "soil_moisture_12" = "soil_2020_12",
      "soil_moisture_13" = "soil_2021_01",
      "soil_moisture_14" = "soil_2021_02",
      "soil_moisture_15" = "soil_2021_03",
      "soil_moisture_16" = "soil_2021_04",
      "soil_moisture_17" = "soil_2021_05",
      "soil_moisture_18" = "soil_2021_06",
      "soil_moisture_19" = "soil_2021_07"
    )
    
    # Rename columns manually to avoid duplication issues
    for (old_name in names(soil_moisture_vars)) {
      new_name <- soil_moisture_vars[[old_name]]
      names(nga_hl_21)[names(nga_hl_21) == old_name] <- new_name
    }
    
    # Calculate yearly averages for soil moisture for each unique geocode
    nga_hl_21 <- nga_hl_21 %>%
      mutate(
        soil_2020_avg = rowMeans(dplyr::select(., starts_with("soil_2020_")), na.rm = TRUE),
        soil_2021_avg = rowMeans(dplyr::select(., starts_with("soil_2021_")), na.rm = TRUE)
      )
    
    # Group by unique geocode and calculate average soil moisture per year
    average_soil_moisture <- nga_hl_21 %>%
      group_by(longitude, latitude) %>%
      summarise(
        soil_2020_avg = mean(soil_2020_avg, na.rm = TRUE),
        soil_2021_avg = mean(soil_2021_avg, na.rm = TRUE),
        .groups = 'drop'
      )
    
    # Merge the yearly averages back with the original data
    nga_hl_21 <- left_join(nga_hl_21, average_soil_moisture, by = c("longitude", "latitude"))
    
    # Save the processed data for plotting
    save(nga_hl_21, file = "processed_nga_hl_21.RData")
  } else {
    print("Soil moisture extraction failed. Please check the raster files and extraction process.")
  }
}

```

D.2b Extract Soil Moisture Values for Women
```{r}
# Load necessary libraries
library(sf)
library(raster)
library(dplyr)

# Check if the soil moisture stack exists
if (exists("soil_moisture_stack")) {
  # Convert nga_wm_21 to an sf object
  nga_wm_21_sf <- st_as_sf(nga_wm_21, coords = c("longitude", "latitude"), crs = 4326)
  
  # Extract soil moisture values for each household's location
  soil_moisture_values <- extract(soil_moisture_stack, as(nga_wm_21_sf, "Spatial"))
  
  # Check if extraction was successful
  print(head(soil_moisture_values))
  
  if (!is.null(soil_moisture_values) && ncol(soil_moisture_values) > 0) {
    # Convert to a data frame and ensure unique column names
    soil_moisture_df <- as.data.frame(soil_moisture_values)
    colnames(soil_moisture_df) <- paste0("soil_moisture_", seq_len(ncol(soil_moisture_df)))
    
    # Bind soil moisture data to household data
    nga_wm_21 <- cbind(nga_wm_21, soil_moisture_df)
    
    # Manually rename soil moisture variables
    soil_moisture_vars <- c(
      "soil_moisture_1" = "soil_2020_01",
      "soil_moisture_2" = "soil_2020_02",
      "soil_moisture_3" = "soil_2020_03",
      "soil_moisture_4" = "soil_2020_04",
      "soil_moisture_5" = "soil_2020_05",
      "soil_moisture_6" = "soil_2020_06",
      "soil_moisture_7" = "soil_2020_07",
      "soil_moisture_8" = "soil_2020_08",
      "soil_moisture_9" = "soil_2020_09",
      "soil_moisture_10" = "soil_2020_10",
      "soil_moisture_11" = "soil_2020_11",
      "soil_moisture_12" = "soil_2020_12",
      "soil_moisture_13" = "soil_2021_01",
      "soil_moisture_14" = "soil_2021_02",
      "soil_moisture_15" = "soil_2021_03",
      "soil_moisture_16" = "soil_2021_04",
      "soil_moisture_17" = "soil_2021_05",
      "soil_moisture_18" = "soil_2021_06",
      "soil_moisture_19" = "soil_2021_07"
    )
    
    # Rename columns manually to avoid duplication issues
    for (old_name in names(soil_moisture_vars)) {
      new_name <- soil_moisture_vars[[old_name]]
      names(nga_wm_21)[names(nga_wm_21) == old_name] <- new_name
    }
    
    # Calculate yearly averages for soil moisture for each unique geocode
    nga_wm_21 <- nga_wm_21 %>%
      mutate(
        soil_2020_avg = rowMeans(dplyr::select(., starts_with("soil_2020_")), na.rm = TRUE),
        soil_2021_avg = rowMeans(dplyr::select(., starts_with("soil_2021_")), na.rm = TRUE)
      )
    
    # Group by unique geocode and calculate average soil moisture per year
    average_soil_moisture <- nga_wm_21 %>%
      group_by(longitude, latitude) %>%
      summarise(
        soil_2020_avg = mean(soil_2020_avg, na.rm = TRUE),
        soil_2021_avg = mean(soil_2021_avg, na.rm = TRUE),
        .groups = 'drop'
      )
    
    # Merge the yearly averages back with the original data
    nga_wm_21 <- left_join(nga_wm_21, average_soil_moisture, by = c("longitude", "latitude"))
    
    # Save the processed data for plotting
    save(nga_wm_21, file = "processed_nga_wm_21.RData")
  } else {
    print("Soil moisture extraction failed. Please check the raster files and extraction process.")
  }
}
```

D.2c Extract Soil Moisture Values for Children
```{r}
# Load necessary libraries
library(sf)
library(raster)
library(dplyr)

# Check if the soil moisture stack exists
if (exists("soil_moisture_stack")) {
  # Convert nga_ch_21 to an sf object
  nga_ch_21_sf <- st_as_sf(nga_ch_21, coords = c("longitude", "latitude"), crs = 4326)
  
  # Extract soil moisture values for each household's location
  soil_moisture_values <- extract(soil_moisture_stack, as(nga_ch_21_sf, "Spatial"))
  
  # Check if extraction was successful
  print(head(soil_moisture_values))
  
  if (!is.null(soil_moisture_values) && ncol(soil_moisture_values) > 0) {
    # Convert to a data frame and ensure unique column names
    soil_moisture_df <- as.data.frame(soil_moisture_values)
    colnames(soil_moisture_df) <- paste0("soil_moisture_", seq_len(ncol(soil_moisture_df)))
    
    # Bind soil moisture data to household data
    nga_ch_21 <- cbind(nga_ch_21, soil_moisture_df)
    
    # Manually rename soil moisture variables
    soil_moisture_vars <- c(
      "soil_moisture_1" = "soil_2020_01",
      "soil_moisture_2" = "soil_2020_02",
      "soil_moisture_3" = "soil_2020_03",
      "soil_moisture_4" = "soil_2020_04",
      "soil_moisture_5" = "soil_2020_05",
      "soil_moisture_6" = "soil_2020_06",
      "soil_moisture_7" = "soil_2020_07",
      "soil_moisture_8" = "soil_2020_08",
      "soil_moisture_9" = "soil_2020_09",
      "soil_moisture_10" = "soil_2020_10",
      "soil_moisture_11" = "soil_2020_11",
      "soil_moisture_12" = "soil_2020_12",
      "soil_moisture_13" = "soil_2021_01",
      "soil_moisture_14" = "soil_2021_02",
      "soil_moisture_15" = "soil_2021_03",
      "soil_moisture_16" = "soil_2021_04",
      "soil_moisture_17" = "soil_2021_05",
      "soil_moisture_18" = "soil_2021_06",
      "soil_moisture_19" = "soil_2021_07"
    )
    
    # Rename columns manually to avoid duplication issues
    for (old_name in names(soil_moisture_vars)) {
      new_name <- soil_moisture_vars[[old_name]]
      names(nga_ch_21)[names(nga_ch_21) == old_name] <- new_name
    }
    
    # Calculate yearly averages for soil moisture for each unique geocode
    nga_ch_21 <- nga_ch_21 %>%
      mutate(
        soil_2020_avg = rowMeans(dplyr::select(., starts_with("soil_2020_")), na.rm = TRUE),
        soil_2021_avg = rowMeans(dplyr::select(., starts_with("soil_2021_")), na.rm = TRUE)
      )
    
    # Group by unique geocode and calculate average soil moisture per year
    average_soil_moisture <- nga_ch_21 %>%
      group_by(longitude, latitude) %>%
      summarise(
        soil_2020_avg = mean(soil_2020_avg, na.rm = TRUE),
        soil_2021_avg = mean(soil_2021_avg, na.rm = TRUE),
        .groups = 'drop'
      )
    
    # Merge the yearly averages back with the original data
    nga_ch_21 <- left_join(nga_ch_21, average_soil_moisture, by = c("longitude", "latitude"))
    
    # Save the processed data for plotting
    save(nga_ch_21, file = "processed_nga_ch_21.RData")
  } else {
    print("Soil moisture extraction failed. Please check the raster files and extraction process.")
  }
}

```

D.3 Remove additional data sets
```{r}
rm (nga_ch_16, nga_hh_16, nga_hl_16, nga_mn_16, nga_wm_16, nga_mn_21)
```

E.1 Maps: MICS Surveys & Violent Attacks During Previous Years
```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)

# Years of interest for the conflict data
years <- c(1999:2020)  

for (yy in years) {
  # Dynamically create a conflict subset for the current year within the loop
  conf_current <- subset(conf_nga, conf_nga$year == yy)
  
  # Convert the current year's conflict data to an sf object
  df2_sf <- st_as_sf(conf_current, coords = c("longitude", "latitude"), crs = 4326)
  
  # Base plot with Nigeria map
  plot <- ggplot() +
    geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
    geom_sf(data = df1_sf, aes(color = "MICS Survey"), size = 1.5) +
    geom_sf(data = df2_sf, aes(color = "Violent Attacks"), size = 1.5) +
    scale_color_manual(values = c("MICS Survey" = "blue", "Violent Attacks" = "red"),
                       name = NULL, 
                       labels = c("MICS Survey", "Violent Attacks")) +
    ggtitle(sprintf("Nigeria: UNICEF MICS Survey (2021) and Violent Attacks During %d", yy)) +
    theme_minimal() +
    labs(x = "Longitude", y = "Latitude") +
    theme(legend.position = "bottom")
  
  # Dynamically name the saved file based on the current year
  file_name <- sprintf("nga_mics_attacks_%d.png", yy)
  
  # Save the plot with a white background and adjusted size
  ggsave(file_name, plot, width = 12, height = 10, dpi = 300, bg = "white")
}

```

E.2 Map - Violent Attacks & Food Insecurity (Density)
```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Ensure date columns are of the same type
df1_sf$date <- as.character(df1_sf$date)
df2_sf$date <- as.character(df2_sf$date)

# Filter data to include only records with outcome (previously food3_21) information
outcome_data <- nga_hl_21 %>% filter(!is.na(food4_21))

# Convert outcome data to an sf object
outcome_sf <- st_as_sf(outcome_data, coords = c("longitude", "latitude"), crs = 4326)
outcome_sf$type <- "Food Insecurity"

# Ensure date column in outcome_sf is of the same type
outcome_sf$date <- as.character(outcome_sf$date)

# Combine all datasets
combined_sf <- bind_rows(df1_sf, df2_sf, outcome_sf)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  stat_density2d(data = outcome_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], fill = ..level..), 
                 geom = "polygon", alpha = 0.6) +  # Removed contour lines for smooth transition
  scale_fill_gradient(low = "yellow", high = "darkred", 
                      guide = guide_colorbar(title = "Food Insecurity Density", 
                                             title.position = "top",
                                             title.hjust = 0.5,
                                             barwidth = 15,
                                             barheight = 1,
                                             breaks = c(0, 1), 
                                             labels = c("Low", "High"))) +  # Updated scale
  # geom_point(data = df1_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 0.5, shape = 16) +  # MICS surveyed households
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  # Include label for Violent Attacks
  scale_color_manual(values = c("MICS Surveyed Households" = "blue", "Violent Attacks" = "darkred"), 
                     labels = c("MICS Surveyed Households", "Violent Attacks"), 
                     name = "") +  # Add label for MICS surveyed households and Violent Attacks
  ggtitle("Nigeria: Violent Attacks (2020) & Food Insecurity Density (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("nga_mics_attacks_food_hotspots_density_2020.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.2 Map - Violent Attacks & Food Insecurity (%)
```{r}
library(rnaturalearth)
library(ggplot2)
library(dplyr)
library(sf)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Calculate percentage of food insecurity at each geo-code level
food_insecurity_pct <- nga_hl_21 %>%
  group_by(longitude, latitude) %>%
  summarise(food_insecurity_pct = mean(food7_21, na.rm = TRUE) * 100, .groups = 'drop')  # Ungroup explicitly

# Convert the percentage data to an sf object
food_insecurity_sf <- st_as_sf(food_insecurity_pct, coords = c("longitude", "latitude"), crs = 4326)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_point(data = food_insecurity_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], 
                                            size = food_insecurity_pct, fill = food_insecurity_pct), 
             shape = 21, color = "white", stroke = 0.05, alpha = 0.2) +  # Increased transparency and reduced stroke
  geom_sf(data = nigeria, fill = NA, color = "gray60", lwd = 1) +  # Replot Nigeria border to ensure visibility
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  
  scale_fill_gradientn(colors = c("yellow", "orange", "green", "darkgreen"),  # Color gradient from yellow to dark brown using a hex code
                       guide = guide_colorbar(title = "Food Insecurity (%)", 
                                              title.position = "top", 
                                              title.hjust = 0.5, 
                                              barwidth = 15, 
                                              barheight = 1)) +
  scale_size(range = c(0.5, 6), guide = NULL) +  # Adjust size to vary smoothly
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "") +
  ggtitle("Nigeria: Violent Attacks (2020) & Food Insecurity Percentage (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("map_food_insecurity.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.3 Map - Violent Attacks & School Attendance (Density)
```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Ensure date columns are of the same type
df1_sf$date <- as.character(df1_sf$date)
df2_sf$date <- as.character(df2_sf$date)

# Filter data to include only records with school attendance (school20) information
school20_data <- nga_hl_21 %>% filter(!is.na(school20))

# Convert school attendance data to an sf object
school20_sf <- st_as_sf(school20_data, coords = c("longitude", "latitude"), crs = 4326)
school20_sf$type <- "School Attendance"

# Ensure date column in school20_sf is of the same type
school20_sf$date <- as.character(school20_sf$date)

# Combine all datasets
combined_sf <- bind_rows(df1_sf, df2_sf, school20_sf)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  stat_density2d(data = school20_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], fill = ..level..), 
                 geom = "polygon", alpha = 0.6) +  # Removed contour lines for smooth transition
  scale_fill_gradient(low = "lightblue", high = "darkblue", 
                      guide = guide_colorbar(title = "School Attendance Density", 
                                             title.position = "top",
                                             title.hjust = 0.5,
                                             barwidth = 15,
                                             barheight = 1,
                                             breaks = c(0, max(..level..)), 
                                             labels = c("Low", "High"))) +  # Updated scale
  # geom_point(data = df1_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 0.5, shape = 16) +  # MICS surveyed households
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  # Include label for Violent Attacks
  scale_color_manual(values = c("MICS Surveyed Households" = "darkgreen", "Violent Attacks" = "red"), 
                     labels = c("MICS Surveyed Households", "Violent Attacks"), 
                     name = "") +  # Add label for MICS surveyed households and Violent Attacks
  ggtitle("Nigeria: Violent Attacks (2020) & School Attendance Density (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("nga_mics_attacks_school_density_2020.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.3 Map - Violent Attacks & School Attendance (%)
```{r}
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Calculate percentage of school attendance at each geo-code level
school_attendance_pct <- nga_hl_21 %>%
  group_by(longitude, latitude) %>%
  summarise(school_attendance_pct = mean(school20, na.rm = TRUE) * 100) %>%
  ungroup()

# Convert the percentage data to an sf object
school_attendance_sf <- st_as_sf(school_attendance_pct, coords = c("longitude", "latitude"), crs = 4326)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_point(data = school_attendance_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], 
                                              size = school_attendance_pct, fill = school_attendance_pct), 
             shape = 21, color = "white", stroke = 0.05, alpha = 0.2) +  # Increased transparency and reduced stroke
  geom_sf(data = nigeria, fill = NA, color = "gray60", lwd = 1) +  # Replot Nigeria border to ensure visibility
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  
  scale_fill_gradientn(colors = c("white", "lightblue", "blue", "darkblue"),  # More colors for smoother transition
                      guide = guide_colorbar(title = "School Attendance (%)", 
                                             title.position = "top", 
                                             title.hjust = 0.5, 
                                             barwidth = 15, 
                                             barheight = 1)) +
  scale_size(range = c(0.5, 6), guide = NULL) +  # Adjust size to vary smoothly
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "") +
  ggtitle("Nigeria: Violent Attacks (2020) & School Attendance Percentage (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("map_school_attendance.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E. 4 Map - School Dropout (%)
```{r}
library(rnaturalearth)
library(ggplot2)
library(dplyr)
library(sf)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Calculate percentage of school dropout at each geo-code level
school_dropout_pct <- nga_hl_21 %>%
  group_by(longitude, latitude) %>%
  summarise(school_dropout_pct = mean(school_drop, na.rm = TRUE) * 100) %>%
  ungroup()

# Convert the percentage data to an sf object
school_dropout_sf <- st_as_sf(school_dropout_pct, coords = c("longitude", "latitude"), crs = 4326)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_point(data = school_dropout_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], 
                                           size = school_dropout_pct, fill = school_dropout_pct), 
             shape = 21, color = "white", stroke = 0.05, alpha = 0.2) +  # Increased transparency and reduced stroke
  geom_sf(data = nigeria, fill = NA, color = "gray60", lwd = 1) +  # Replot Nigeria border to ensure visibility
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  
  scale_fill_gradientn(colors = c("white", "lightblue", "blue", "darkblue"),  # More colors for smoother transition
                       guide = guide_colorbar(title = "School Dropout 20-21 (%)", 
                                              title.position = "top", 
                                              title.hjust = 0.5, 
                                              barwidth = 15, 
                                              barheight = 1)) +
  scale_size(range = c(0.5, 6), guide = NULL) +  # Adjust size to vary smoothly
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "") +
  ggtitle("Nigeria: Violent Attacks (2020) & School Dropout Percentage (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("map_school_dropout.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.5 Map - Violent Attacks & Happiness (Density)
```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_wm_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Ensure date columns are of the same type
df1_sf$date <- as.character(df1_sf$date)
df2_sf$date <- as.character(df2_sf$date)

# Filter data to include only records with happiness
happiness20_data <- nga_wm_21 %>% filter(!is.na(happiness_21))

# Convert school attendance data to an sf object
happiness20_sf <- st_as_sf(happiness20_data, coords = c("longitude", "latitude"), crs = 4326)
happiness20_sf$type <- "Happiness 2021"

# Ensure date column in happiness20_sf is of the same type
happiness20_sf$date <- as.character(happiness20_sf$date)

# Combine all datasets
combined_sf <- bind_rows(df1_sf, df2_sf, happiness20_sf)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  stat_density2d(data = happiness20_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], fill = ..level..), 
                 geom = "polygon", alpha = 0.6) +  # Removed contour lines for smooth transition
  scale_fill_gradient(low = "lightblue", high = "green", 
                      guide = guide_colorbar(title = "Happiness 2020 Density", 
                                             title.position = "top",
                                             title.hjust = 0.5,
                                             barwidth = 15,
                                             barheight = 1,
                                             breaks = c(0, max(..level..)), 
                                             labels = c("Low", "High"))) +  # Updated scale
  # geom_point(data = df1_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 0.5, shape = 16) +  # MICS surveyed households
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  # Include label for Violent Attacks
  scale_color_manual(values = c("MICS Surveyed Households" = "darkgreen", "Violent Attacks" = "red"), 
                     labels = c("MICS Surveyed Households", "Violent Attacks"), 
                     name = "") +  # Add label for MICS surveyed households and Violent Attacks
  ggtitle("Nigeria: Violent Attacks (2020) & Happiness Density (2020)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("nga_mics_attacks_happiness_density_2020.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.5 Map - Violent Attacks & Happiness (%)
```{r}
library(rnaturalearth)
library(ggplot2)
library(dplyr)
library(sf)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021 (Women Dataset)
df1_sf <- st_as_sf(nga_wm_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Calculate percentage of happiness at each geo-code level
happiness_pct <- nga_wm_21 %>%
  group_by(longitude, latitude) %>%
  summarise(happiness_pct = mean(happiness_21, na.rm = TRUE) * 100, .groups = 'drop')

# Convert the percentage data to an sf object
happiness_sf <- st_as_sf(happiness_pct, coords = c("longitude", "latitude"), crs = 4326)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_point(data = happiness_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], 
                                      size = happiness_pct, fill = happiness_pct), 
             shape = 21, color = "white", stroke = 0.05, alpha = 0.2) +  # Increased transparency and reduced stroke
  geom_sf(data = nigeria, fill = NA, color = "gray60", lwd = 1) +  # Replot Nigeria border to ensure visibility
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  
  scale_fill_gradientn(colors = c("purple", "yellow"),  # Color gradient from purple to yellow
                       guide = guide_colorbar(title = "Happiness (%)", 
                                              title.position = "top", 
                                              title.hjust = 0.5, 
                                              barwidth = 15, 
                                              barheight = 1)) +
  scale_size(range = c(0.5, 6), guide = NULL) +  # Adjust size to vary smoothly
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "") +
  ggtitle("Nigeria: Violent Attacks (2020) & Happiness Percentage (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("map_happiness.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.6 Map - Violent Attacks & Child Abuse (Density)
```{r}
library(sf)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021
df1_sf <- st_as_sf(nga_ch_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Ensure date columns are of the same type
df1_sf$date <- as.character(df1_sf$date)
df2_sf$date <- as.character(df2_sf$date)

# Filter data to include only records with happiness
violence_3_data <- nga_ch_21 %>% filter(!is.na(violence_3))

# Convert school attendance data to an sf object
violence_3_sf <- st_as_sf(violence_3_data, coords = c("longitude", "latitude"), crs = 4326)
violence_3_sf$type <- "Emotional Abuse"

# Ensure date column in happiness20_sf is of the same type
violence_3_sf$date <- as.character(violence_3_sf$date)

# Combine all datasets
combined_sf <- bind_rows(df1_sf, df2_sf, violence_3_sf)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  stat_density2d(data = violence_3_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], fill = ..level..), 
                 geom = "polygon", alpha = 0.6) +  # Removed contour lines for smooth transition
  scale_fill_gradient(low = "lightblue", high = "gray", 
                      guide = guide_colorbar(title = "Emotional Abuse Density", 
                                             title.position = "top",
                                             title.hjust = 0.5,
                                             barwidth = 15,
                                             barheight = 1,
                                             breaks = c(0, max(..level..)), 
                                             labels = c("Low", "High"))) +  # Updated scale
  # geom_point(data = df1_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 0.5, shape = 16) +  # MICS surveyed households
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  # Include label for Violent Attacks
  scale_color_manual(values = c("MICS Surveyed Households" = "darkgreen", "Violent Attacks" = "red"), 
                     labels = c("MICS Surveyed Households", "Violent Attacks"), 
                     name = "") +  # Add label for MICS surveyed households and Violent Attacks
  ggtitle("Nigeria: Violent Attacks (2020) & Emotional Abuse (2020)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("nga_mics_attacks_child_abuse_density_2020.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.6 Map - Violent Attacks & Child Abuse (%)
```{r}
library(rnaturalearth)
library(ggplot2)
library(dplyr)
library(sf)

# Download Nigeria shapefile
nigeria <- ne_countries(scale = "medium", country = "Nigeria", returnclass = "sf")

# UNICEF MICS Survey data for 2021 (Child Dataset)
df1_sf <- st_as_sf(nga_ch_21, coords = c("longitude", "latitude"), crs = 4326)
df1_sf$type <- "MICS Surveyed Households"

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
df2_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
df2_sf$type <- "Violent Attacks"

# Calculate percentage of child abuse at each geo-code level
child_abuse_pct <- nga_ch_21 %>%
  group_by(longitude, latitude) %>%
  summarise(child_abuse_pct = mean(child_abuse, na.rm = TRUE) * 100, .groups = 'drop')

# Convert the percentage data to an sf object
child_abuse_sf <- st_as_sf(child_abuse_pct, coords = c("longitude", "latitude"), crs = 4326)

# Base plot with Nigeria map
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_point(data = child_abuse_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], 
                                        size = child_abuse_pct, fill = child_abuse_pct), 
             shape = 21, color = "white", stroke = 0.05, alpha = 0.2) +  # Increased transparency and reduced stroke
  geom_sf(data = nigeria, fill = NA, color = "gray60", lwd = 1) +  # Replot Nigeria border to ensure visibility
  geom_point(data = df2_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +  
  scale_fill_gradientn(colors = c("yellow", "lightgreen", "green", "darkgreen"),  # Color gradient from light green to dark red
                       guide = guide_colorbar(title = "Child Abuse (%)", 
                                              title.position = "top", 
                                              title.hjust = 0.5, 
                                              barwidth = 15, 
                                              barheight = 1)) +
  scale_size(range = c(0.5, 6), guide = NULL) +  # Adjust size to vary smoothly
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "") +
  ggtitle("Nigeria: Violent Attacks (2020) & Child Abuse Percentage (2021)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude") +
  theme(legend.position = "bottom")

# Save the plot with a white background and adjusted size
ggsave("map_child_abuse.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

E.7 Map - Violent Attacks & Drought
```{r}
# Load necessary libraries
library(sf)
library(raster)
library(rnaturalearth)
library(ggplot2)
library(dplyr)

# Merge all soil moisture rasters to get an average soil moisture raster
soil_moisture_avg <- calc(soil_moisture_stack, mean, na.rm = TRUE)

# Reproject soil moisture raster to match the CRS of Nigeria shapefile if necessary
if (!identical(crs(soil_moisture_avg), st_crs(nigeria))) {
  soil_moisture_avg <- projectRaster(soil_moisture_avg, crs = st_crs(nigeria)$proj4string)
}

# Clip the soil moisture raster to Nigeria's boundaries
nigeria_raster <- mask(soil_moisture_avg, nigeria)

# Smooth the raster data using bilinear interpolation
nigeria_raster_smooth <- disaggregate(nigeria_raster, fact = 4, method = 'bilinear')

# Conflict data for the year 2020
conf_2020 <- subset(conf_nga, year == 2020)

# Convert the conflict data for 2020 to an sf object
conf_2020_sf <- st_as_sf(conf_2020, coords = c("longitude", "latitude"), crs = 4326)
conf_2020_sf$type <- "Violent Attacks"

# Plot with Nigeria map, soil moisture, and conflict data
plot <- ggplot() +
  geom_sf(data = nigeria, fill = "gray90", color = "gray60") +
  geom_raster(data = as.data.frame(rasterToPoints(nigeria_raster_smooth)), aes(x = x, y = y, fill = layer)) +
  scale_fill_gradient(low = "yellow", high = "blue", 
                      guide = guide_colorbar(title = "Average Soil Moisture (2020)", 
                                             title.position = "top",
                                             title.hjust = 0.5,
                                             barwidth = 15,
                                             barheight = 1)) +
  geom_point(data = conf_2020_sf, aes(x = st_coordinates(geometry)[,1], y = st_coordinates(geometry)[,2], color = type), size = 1.5, shape = 17) +
  scale_color_manual(values = c("Violent Attacks" = "red"), 
                     labels = c("Violent Attacks"), 
                     name = "Legend") + 
  ggtitle("Nigeria: Violent Attacks (2020) & Average Soil Moisture (2020)") +
  theme_minimal() +
  labs(x = "Longitude", y = "Latitude", color = "Legend") +
  theme(legend.position = "bottom") +
  guides(fill = guide_colorbar(title = "Average Soil Moisture (2020)", title.position = "top", title.hjust = 0.5, barwidth = 15, barheight = 1),
         color = guide_legend(title = "Legend"))

# Save the plot with a white background and adjusted size
ggsave("nga_conflicts_soil_moisture_2020.png", plot, width = 12, height = 10, dpi = 300, bg = "white")

```

F.1A Calculate distance to nearest violent attack every month during the last two years: Household Member
```{r}
library(sf)
library(lubridate)
library(dplyr)
library(units)

# Step 1: Convert data frames to sf objects
nga_hl_21_sf <- st_as_sf(nga_hl_21, coords = c("longitude", "latitude"), crs = 4326)
nga_hl_21$interview_date <- as.Date(nga_hl_21$int_day, format = "%Y-%m-%d")

# Step 2: Prepare and filter the conflict data
current_year <- year(Sys.Date())
start_year <- current_year - 5
conf_nga_clean <- conf_nga %>%
  filter(year >= start_year & !is.na(longitude) & !is.na(latitude) & !is.na(date)) %>%
  mutate(date = as.Date(date))

conf_nga_sf <- st_as_sf(conf_nga_clean, coords = c("longitude", "latitude"), crs = 4326)

# Step 3: Calculate the nearest attacks for each household in nga_hl_21
nga_hl_21_sf$nearest_attack_id <- st_nearest_feature(nga_hl_21_sf, conf_nga_sf)

# Extract the nearest attack dates
nearest_conflicts <- conf_nga_sf[nga_hl_21_sf$nearest_attack_id, ]
nga_hl_21$nearest_attack_date <- nearest_conflicts$date

# Calculate days between interview date and nearest attack date
nga_hl_21$nearest_attack_time <- as.integer(difftime(nga_hl_21$interview_date, nga_hl_21$nearest_attack_date, units = "days"))

# Calculate distances only for specific time frames, monthly
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep="")

  # Initialize the column with NAs for all rows
  nga_hl_21[[month_name]] <- NA

  # Define the time frame condition
  within_time_frame <- nga_hl_21$nearest_attack_time <= i * 30 # 30 days per month

  # Check if there are any households within the time frame
  if (any(within_time_frame)) {
    relevant_conflicts <- nearest_conflicts[within_time_frame, ]
    relevant_households <- nga_hl_21_sf[within_time_frame, ]

    # Calculate distances for relevant households
    distance_values <- st_distance(relevant_households, relevant_conflicts, by_element = TRUE)

    # Set the distances only for those within the time frame
    nga_hl_21[[month_name]][within_time_frame] <- set_units(distance_values, "km")
  }
}

# Additional fields from the nearest attacks
nga_hl_21$nearest_attack_type_of_violence <- nearest_conflicts$type_of_violence
nga_hl_21$nearest_attack_best_est <- nearest_conflicts$best_est
nga_hl_21$nearest_deaths <- nearest_conflicts$best_est  # Assuming 'best_est' gives the death toll

# Step 4: Calculate the attack exposure score using the most recent month's data (example: month 24)
distance_numeric <- as.numeric(nga_hl_21$attack_distance24)
nga_hl_21$attack_exposure_score <- (1 / (distance_numeric + 1)) * nga_hl_21$nearest_deaths

# Output to check results for each month up to 24
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep="")
  print(paste("Summary for", month_name))
  print(summary(nga_hl_21[[month_name]]))
}

```

F.1B Define Treatment Variables: Household Member
```{r}
# Define treatment based on proximity to a violent attack during month X: 5Km
nga_hl_21$t1 <- ifelse(nga_hl_21$attack_distance1 < 5, 1, 0)
nga_hl_21$t2 <- ifelse(nga_hl_21$attack_distance2 < 5, 1, 0)
nga_hl_21$t3 <- ifelse(nga_hl_21$attack_distance3 < 5, 1, 0)
nga_hl_21$t4 <- ifelse(nga_hl_21$attack_distance4 < 5, 1, 0)
nga_hl_21$t5 <- ifelse(nga_hl_21$attack_distance5 < 5, 1, 0)
nga_hl_21$t6 <- ifelse(nga_hl_21$attack_distance6 < 5, 1, 0)
nga_hl_21$t7 <- ifelse(nga_hl_21$attack_distance7 < 5, 1, 0)
nga_hl_21$t8 <- ifelse(nga_hl_21$attack_distance8 < 5, 1, 0)
nga_hl_21$t9 <- ifelse(nga_hl_21$attack_distance9 < 5, 1, 0)
nga_hl_21$t10 <- ifelse(nga_hl_21$attack_distance10 < 5, 1, 0)
nga_hl_21$t11 <- ifelse(nga_hl_21$attack_distance11 < 5, 1, 0)
nga_hl_21$t12 <- ifelse(nga_hl_21$attack_distance12 < 5, 1, 0)
nga_hl_21$t13 <- ifelse(nga_hl_21$attack_distance13 < 5, 1, 0)
nga_hl_21$t14 <- ifelse(nga_hl_21$attack_distance14 < 5, 1, 0)
nga_hl_21$t15 <- ifelse(nga_hl_21$attack_distance15 < 5, 1, 0)
nga_hl_21$t16 <- ifelse(nga_hl_21$attack_distance16 < 5, 1, 0)
nga_hl_21$t17 <- ifelse(nga_hl_21$attack_distance17 < 5, 1, 0)
nga_hl_21$t18 <- ifelse(nga_hl_21$attack_distance18 < 5, 1, 0)
nga_hl_21$t19 <- ifelse(nga_hl_21$attack_distance19 < 5, 1, 0)
nga_hl_21$t20 <- ifelse(nga_hl_21$attack_distance20 < 5, 1, 0)
nga_hl_21$t21 <- ifelse(nga_hl_21$attack_distance21 < 5, 1, 0)
nga_hl_21$t22 <- ifelse(nga_hl_21$attack_distance22 < 5, 1, 0)
nga_hl_21$t23 <- ifelse(nga_hl_21$attack_distance23 < 5, 1, 0)
nga_hl_21$t24 <- ifelse(nga_hl_21$attack_distance24 < 5, 1, 0)
```

F.2A Calculate distance to nearest violent attack every month during the last two years: Women
```{r}
library(sf)
library(lubridate)
library(dplyr)
library(units)

# Step 1: Convert data frames to sf objects
nga_wm_21_sf <- st_as_sf(nga_wm_21, coords = c("longitude", "latitude"), crs = 4326)
nga_wm_21$interview_date <- as.Date(nga_wm_21$int_day, format = "%Y-%m-%d")

# Step 2: Prepare and filter the conflict data
current_year <- year(Sys.Date())
start_year <- current_year - 5
conf_nga_clean <- conf_nga %>%
  filter(year >= start_year & !is.na(longitude) & !is.na(latitude) & !is.na(date)) %>%
  mutate(date = as.Date(date))

conf_nga_sf <- st_as_sf(conf_nga_clean, coords = c("longitude", "latitude"), crs = 4326)

# Step 3: Calculate the nearest attacks for each household in nga_wm_21
nga_wm_21_sf$nearest_attack_id <- st_nearest_feature(nga_wm_21_sf, conf_nga_sf)

# Extract the nearest attack dates
nearest_conflicts <- conf_nga_sf[nga_wm_21_sf$nearest_attack_id, ]
nga_wm_21$nearest_attack_date <- nearest_conflicts$date

# Calculate days between interview date and nearest attack date
nga_wm_21$nearest_attack_time <- as.integer(difftime(nga_wm_21$interview_date, nga_wm_21$nearest_attack_date, units = "days"))

# Calculate distances only for specific time frames, monthly
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep="")

  # Initialize the column with NAs for all rows
  nga_wm_21[[month_name]] <- NA

  # Define the time frame condition
  within_time_frame <- nga_wm_21$nearest_attack_time <= i * 30 # 30 days per month

  # Check if there are any households within the time frame
  if (any(within_time_frame)) {
    relevant_conflicts <- nearest_conflicts[within_time_frame, ]
    relevant_households <- nga_wm_21_sf[within_time_frame, ]

    # Calculate distances for relevant households
    distance_values <- st_distance(relevant_households, relevant_conflicts, by_element = TRUE)

    # Set the distances only for those within the time frame
    nga_wm_21[[month_name]][within_time_frame] <- set_units(distance_values, "km")
  }
}

# Additional fields from the nearest attacks
nga_wm_21$nearest_attack_type_of_violence <- nearest_conflicts$type_of_violence
nga_wm_21$nearest_attack_best_est <- nearest_conflicts$best_est
nga_wm_21$nearest_deaths <- nearest_conflicts$best_est  # Assuming 'best_est' gives the death toll

# Step 4: Calculate the attack exposure score using the most recent month's data (example: month 24)
distance_numeric <- as.numeric(nga_wm_21$attack_distance24)
nga_wm_21$attack_exposure_score <- (1 / (distance_numeric + 1)) * nga_wm_21$nearest_deaths

# Output to check results for each month up to 24
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep="")
  print(paste("Summary for", month_name))
  print(summary(nga_wm_21[[month_name]]))
}
```

F.2B Define Treatment Variables: Women
```{r}
# Define treatment based on proximity to a violent attack during month X: 5Km
nga_wm_21$t1 <- ifelse(nga_wm_21$attack_distance1 < 5, 1, 0)
nga_wm_21$t2 <- ifelse(nga_wm_21$attack_distance2 < 5, 1, 0)
nga_wm_21$t3 <- ifelse(nga_wm_21$attack_distance3 < 5, 1, 0)
nga_wm_21$t4 <- ifelse(nga_wm_21$attack_distance4 < 5, 1, 0)
nga_wm_21$t5 <- ifelse(nga_wm_21$attack_distance5 < 5, 1, 0)
nga_wm_21$t6 <- ifelse(nga_wm_21$attack_distance6 < 5, 1, 0)
nga_wm_21$t7 <- ifelse(nga_wm_21$attack_distance7 < 5, 1, 0)
nga_wm_21$t8 <- ifelse(nga_wm_21$attack_distance8 < 5, 1, 0)
nga_wm_21$t9 <- ifelse(nga_wm_21$attack_distance9 < 5, 1, 0)
nga_wm_21$t10 <- ifelse(nga_wm_21$attack_distance10 < 5, 1, 0)
nga_wm_21$t11 <- ifelse(nga_wm_21$attack_distance11 < 5, 1, 0)
nga_wm_21$t12 <- ifelse(nga_wm_21$attack_distance12 < 5, 1, 0)
nga_wm_21$t13 <- ifelse(nga_wm_21$attack_distance13 < 5, 1, 0)
nga_wm_21$t14 <- ifelse(nga_wm_21$attack_distance14 < 5, 1, 0)
nga_wm_21$t15 <- ifelse(nga_wm_21$attack_distance15 < 5, 1, 0)
nga_wm_21$t16 <- ifelse(nga_wm_21$attack_distance16 < 5, 1, 0)
nga_wm_21$t17 <- ifelse(nga_wm_21$attack_distance17 < 5, 1, 0)
nga_wm_21$t18 <- ifelse(nga_wm_21$attack_distance18 < 5, 1, 0)
nga_wm_21$t19 <- ifelse(nga_wm_21$attack_distance19 < 5, 1, 0)
nga_wm_21$t20 <- ifelse(nga_wm_21$attack_distance20 < 5, 1, 0)
nga_wm_21$t21 <- ifelse(nga_wm_21$attack_distance21 < 5, 1, 0)
nga_wm_21$t22 <- ifelse(nga_wm_21$attack_distance22 < 5, 1, 0)
nga_wm_21$t23 <- ifelse(nga_wm_21$attack_distance23 < 5, 1, 0)
nga_wm_21$t24 <- ifelse(nga_wm_21$attack_distance24 < 5, 1, 0)

```

F.3A Calculate distance to nearest violent attack every month during the last two years: Children
```{r}
library(sf)
library(lubridate)
library(dplyr)
library(units)

# Step 1: Convert data frames to sf objects
nga_ch_21_sf <- st_as_sf(nga_ch_21, coords = c("longitude", "latitude"), crs = 4326)
nga_ch_21$interview_date <- as.Date(nga_ch_21$int_day, format = "%Y-%m-%d")

# Step 2: Prepare and filter the conflict data
current_year <- year(Sys.Date())
start_year <- current_year - 5
conf_nga_clean <- conf_nga %>%
  filter(year >= start_year & !is.na(longitude) & !is.na(latitude) & !is.na(date)) %>%
  mutate(date = as.Date(date))

conf_nga_sf <- st_as_sf(conf_nga_clean, coords = c("longitude", "latitude"), crs = 4326)

# Step 3: Calculate the nearest attacks for each household in nga_ch_21
nga_ch_21_sf$nearest_attack_id <- st_nearest_feature(nga_ch_21_sf, conf_nga_sf)

# Extract the nearest attack dates
nearest_conflicts <- conf_nga_sf[nga_ch_21_sf$nearest_attack_id, ]
nga_ch_21$nearest_attack_date <- nearest_conflicts$date

# Calculate days between interview date and nearest attack date
nga_ch_21$nearest_attack_time <- as.integer(difftime(nga_ch_21$interview_date, nga_ch_21$nearest_attack_date, units = "days"))

# Calculate distances only for specific time frames with error handling
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep = "")

  # Initialize with appropriate data type to avoid NA issues
  nga_ch_21[[month_name]] <- rep(NA_real_, nrow(nga_ch_21))  # Fill with NA_real_ (numeric NA)

  # Define the time frame condition
  within_time_frame <- nga_ch_21$nearest_attack_time <= i * 30 # 30 days per month

  # Check if there are any households within the time frame
  if (any(within_time_frame)) {
    relevant_conflicts <- nearest_conflicts[within_time_frame, ]
    relevant_households <- nga_ch_21_sf[within_time_frame, ]

    # Calculate distances for relevant households
    distance_values <- st_distance(relevant_households, relevant_conflicts, by_element = TRUE)

    # Set the distances only for those with valid values (no NAs)
    nga_ch_21[[month_name]][!is.na(distance_values)] <- set_units(distance_values[ !is.na(distance_values)], "km")
  }
}

# Additional fields from the nearest attacks
nga_ch_21$nearest_attack_type_of_violence <- nearest_conflicts$type_of_violence
nga_ch_21$nearest_attack_best_est <- nearest_conflicts$best_est
nga_ch_21$nearest_deaths <- nearest_conflicts$best_est  # Assuming 'best_est' gives the death toll

# Step 4: Calculate the attack exposure score using the most recent month's data (example: month 24)
distance_numeric <- as.numeric(nga_ch_21$attack_distance24)
nga_ch_21$attack_exposure_score <- (1 / (distance_numeric + 1)) * nga_ch_21$nearest_deaths

# Output to check results for each month up to 24
for (i in 1:24) {
  month_name <- paste("attack_distance", i, sep="")
  print(paste("Summary for", month_name))
  print(summary(nga_ch_21[[month_name]]))
}

```

F.3B Define Treatment Variables: Children
```{r}
# Define treatment based on proximity to a violent attack during month X: 5Km
nga_ch_21$t1 <- ifelse(nga_ch_21$attack_distance1 < 5, 1, 0)
nga_ch_21$t2 <- ifelse(nga_ch_21$attack_distance2 < 5, 1, 0)
nga_ch_21$t3 <- ifelse(nga_ch_21$attack_distance3 < 5, 1, 0)
nga_ch_21$t4 <- ifelse(nga_ch_21$attack_distance4 < 5, 1, 0)
nga_ch_21$t5 <- ifelse(nga_ch_21$attack_distance5 < 5, 1, 0)
nga_ch_21$t6 <- ifelse(nga_ch_21$attack_distance6 < 5, 1, 0)
nga_ch_21$t7 <- ifelse(nga_ch_21$attack_distance7 < 5, 1, 0)
nga_ch_21$t8 <- ifelse(nga_ch_21$attack_distance8 < 5, 1, 0)
nga_ch_21$t9 <- ifelse(nga_ch_21$attack_distance9 < 5, 1, 0)
nga_ch_21$t10 <- ifelse(nga_ch_21$attack_distance10 < 5, 1, 0)
nga_ch_21$t11 <- ifelse(nga_ch_21$attack_distance11 < 5, 1, 0)
nga_ch_21$t12 <- ifelse(nga_ch_21$attack_distance12 < 5, 1, 0)
nga_ch_21$t13 <- ifelse(nga_ch_21$attack_distance13 < 5, 1, 0)
nga_ch_21$t14 <- ifelse(nga_ch_21$attack_distance14 < 5, 1, 0)
nga_ch_21$t15 <- ifelse(nga_ch_21$attack_distance15 < 5, 1, 0)
nga_ch_21$t16 <- ifelse(nga_ch_21$attack_distance16 < 5, 1, 0)
nga_ch_21$t17 <- ifelse(nga_ch_21$attack_distance17 < 5, 1, 0)
nga_ch_21$t18 <- ifelse(nga_ch_21$attack_distance18 < 5, 1, 0)
nga_ch_21$t19 <- ifelse(nga_ch_21$attack_distance19 < 5, 1, 0)
nga_ch_21$t20 <- ifelse(nga_ch_21$attack_distance20 < 5, 1, 0)
nga_ch_21$t21 <- ifelse(nga_ch_21$attack_distance21 < 5, 1, 0)
nga_ch_21$t22 <- ifelse(nga_ch_21$attack_distance22 < 5, 1, 0)
nga_ch_21$t23 <- ifelse(nga_ch_21$attack_distance23 < 5, 1, 0)
nga_ch_21$t24 <- ifelse(nga_ch_21$attack_distance24 < 5, 1, 0)

```

G.1 Data Analysis: Descriptive Statistics
```{r}
# Load necessary libraries
library(dplyr)
library(units)
library(survey)

# Convert all haven_labelled variables to numeric
nga_hl_21 <- nga_hl_21 %>%
  mutate(across(where(is.labelled), as.numeric))

# Data preparation with a conditional check for units
nga_hl_21 <- nga_hl_21 %>%
  mutate(
    soc_pro = as.numeric(soc_pro),
    age = as.numeric(age),
    female = as.numeric(female),
    size = as.numeric(size),
    rural = as.numeric(rural),
    windex5 = as.numeric(windex5),
    christian = as.numeric(christian),  # Convert to numeric
    muslim = as.numeric(muslim),        # Convert to numeric
    traditional = as.numeric(traditional) # Convert to numeric
  )

# Define the survey design
svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_hl_21)

# Descriptive labels for the variables
covariate_labels <- c(
  "food1_21" = "Food Insecurity: Worried (last month)",
  "food4_21" = "Food Insecurity: Skip a Meal (last month)",
  "food8_21" = "Food Insecurity: A Day Without Eating (last month)",
  "food1_20" = "Food Insecurity: Worried (last year)",
  "food4_20" = "Food Insecurity: Skip a Meal (last year)",
  "food8_20" = "Food Insecurity: A Day Without Eating (last year)",
  "school21" = "School Attendance (last month)",
  "school20" = "School Attendance (last year)",
  "soc_pro" = "Social Protection Index",
  "age" = "Age of Respondent",
  "female" = "Gender (Female=1; Male=0)",
  "size" = "Household Size",
  "rural" = "Rural Location (1=Yes; 0=No)",
  "windex5" = "Wealth Index Quintile",
  "christian" = "Christian Religion (1=Yes; 0=No)",
  "muslim" = "Muslim Religion (1=Yes; 0=No)",
  "traditional" = "Traditional Religion (1=Yes; 0=No)"
)

# Prepare a list for statistics
statistics_list <- list()

# Loop over variables to compute statistics
for (var in names(covariate_labels)) {
  formula_mean_sd <- as.formula(paste0("~", var))
  
  # Calculate statistics
  mean <- svymean(formula_mean_sd, svy_design, na.rm = TRUE)
  sd <- sqrt(svyvar(formula_mean_sd, svy_design, na.rm = TRUE))
  min <- svyquantile(formula_mean_sd, svy_design, 0, na.rm = TRUE, se = FALSE)
  max <- svyquantile(formula_mean_sd, svy_design, 1, na.rm = TRUE, se = FALSE)
  
  # Directly reflect the data used in mean, SD, min, max
  n <- sum(!is.na(nga_hl_21[[var]]), na.rm = TRUE)
  
  statistics_list[[var]] <- data.frame(
    mean = ifelse(is.na(coef(mean)), NA, coef(mean)),
    sd = ifelse(is.na(coef(sd)), NA, coef(sd)),
    min = ifelse(length(coef(min)) == 0, NA, coef(min)),
    max = ifelse(length(coef(max)) == 0, NA, coef(max)),
    N = n,
    stringsAsFactors = FALSE
  )
}

# Initialize an empty dataframe for the summary statistics
summary_stats_df <- data.frame(
  Variable = character(0),
  Mean = numeric(0),
  SD = numeric(0),
  Min = numeric(0),
  Max = numeric(0),
  N = numeric(0)
)

# Populate the dataframe
for (var in names(statistics_list)) {
  stats <- statistics_list[[var]]
  summary_stats_df <- rbind(summary_stats_df, data.frame(
    Variable = covariate_labels[var],
    Mean = stats$mean,
    SD = stats$sd,
    Min = stats$min,
    Max = stats$max,
    N = stats$N
  ))
}

# Save the summary statistics table to a text file
write.table(summary_stats_df, "descriptive_statistics_manual.txt", row.names = FALSE, sep = "\t", quote = FALSE)

```

H.1B PSM: Effect of Proximity to Violent Events, Age<19: HL
```{r}
# Required Libraries
library(MatchIt)
library(dplyr)
library(cobalt)
library(broom)
library(survey)
library(stargazer)
library(tidyr)
library(grf)

# Set survey option to handle single PSU in a stratum
options(survey.lonely.psu = "adjust")

# Subsetting data to include only those under age 19
nga_hl_21_ch <- subset(nga_hl_21, nga_hl_21$age < 19)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment

calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)

# Treatment Specifications
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, 0)
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)

# Focus on chronic violence (More than one violent event in the same zone)
#nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Print the summary of the new treatment variable
summary(nga_hl_21_ch$treatment)

# Clean data and create a complete data frame for matching
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  filter(complete.cases(soc_pro, age, female, rural, windex5, treatment, christian, muslim))

# Create survey design object for the full data
svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_hl_21_ch, singleunit = "scaled")

# Perform matching using the complete data frame
matchit_model <- matchit(treatment ~ age + female + rural + windex5 + christian + muslim,
                         data = nga_hl_21_ch_complete, method = "nearest")

# Extract matched data
matched_data <- match.data(matchit_model)

# Convert matched_data to a data frame
matched_data <- as.data.frame(matched_data)

# Create survey design object for the matched data
matched_svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = matched_data)

# Define outcome variables
outcome_labels <- c(
  school20 = "School Attendance (2020-2021)", 
  school19 = "School Attendance (2019-2020)", 
  # food1_20 = "Food Insecurity: Worried (last year)",
  # food2_20 = "Food Insecurity: Not eating healthy (last year)",
  # food3_20 = "Food Insecurity: Ate few kinds of food  (last year)",
  # food4_20 = "Food Insecurity: Skip a meal (last year)",
  # food5_20 = "Food Insecurity: Eating less  (last year)",
  # food6_20 = "Food Insecurity: Ran out of food  (last year)",
  # food7_20 = "Food Insecurity: Hungry and did not eat (last year)",
  # food8_20 = "Food Insecurity: A Day Without Eating (last year)",
  # food1_covid = "Food Insecurity due COVID: Worried (last year)",
  # food2_covid = "Food Insecurity due COVID: Not eating healthy (last year)",
  # food3_covid = "Food Insecurity due COVID: Ate few kinds of food  (last year)",
  # food4_covid = "Food Insecurity due COVID: Skip a meal (last year)",
  # food5_covid = "Food Insecurity due COVID: Eating less  (last year)",
  # food6_covid = "Food Insecurity due COVID: Ran out of food  (last year)",
  # food7_covid = "Food Insecurity due COVID: Hungry and did not eat (last year)",
  # food8_covid = "Food Insecurity due COVID: A Day Without Eating (last year)",
  food1_21 = "Food Insecurity: Worried (last month)",
  food2_21 = "Food Insecurity: Not eating healthy (last month)",
  food3_21 = "Food Insecurity: Ate few kinds of food  (last month)",
  food4_21 = "Food Insecurity: Skip a meal (last month)",
  food5_21 = "Food Insecurity: Eating less  (last month)",
  food6_21 = "Food Insecurity: Ran out of food  (last month)",
  food7_21 = "Food Insecurity: Hungry and did not eat (last month)",
  food8_21 = "Food Insecurity: A Day Without Eating (last month)"
)

# Loop through each outcome variable to fit models using the survey design and save regression tables
for (outcome_var in names(outcome_labels)) {
  complete_cases <- matched_data %>%
    filter(!is.na(!!sym(outcome_var)))
  
  # Ensure the outcome variable is binary (0/1)
  complete_cases[[outcome_var]] <- ifelse(complete_cases[[outcome_var]] > 1, 1, complete_cases[[outcome_var]])
  
  formula_base <- as.formula(paste(outcome_var, "~ treatment"))
  formula_interaction_soc_pro <- as.formula(paste(outcome_var, "~ treatment + soc_pro + age + female + rural + windex5 + christian + muslim + soil_2020_avg.x"))
  formula_with_covariates_and_interaction <- as.formula(paste(outcome_var, "~ treatment + soc_pro + treatment*soc_pro + age + female + rural + windex5 + christian + muslim + soil_2020_avg.x"))

  # Fit models using survey design
  model_base <- svyglm(formula_base, design = matched_svy_design, family = binomial())
  model_interaction_soc_pro <- svyglm(formula_interaction_soc_pro, design = matched_svy_design, family = binomial())
  model_with_covariates_and_interaction <- svyglm(formula_with_covariates_and_interaction, design = matched_svy_design, family = binomial())

  # Create a list of models for current outcome
  models_for_outcome <- list(model_base, model_interaction_soc_pro, model_with_covariates_and_interaction)

  # Use the tidy() function from the broom package to extract model results
  tidy_base <- broom::tidy(model_base)
  tidy_interaction <- broom::tidy(model_interaction_soc_pro)
  tidy_full <- broom::tidy(model_with_covariates_and_interaction)

  # Exponentiate coefficients for interpretation as odds ratios
  tidy_base$estimate <- exp(tidy_base$estimate)
  tidy_interaction$estimate <- exp(tidy_interaction$estimate)
  tidy_full$estimate <- exp(tidy_full$estimate)

  # Stargazer output
  output_filename_stargazer <- paste0("matched_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), ".txt")
  sink(output_filename_stargazer)
  stargazer(models_for_outcome, type = "text",
            coef = list(tidy_base$estimate, tidy_interaction$estimate, tidy_full$estimate),
            se = list(tidy_base$std.error, tidy_interaction$std.error, tidy_full$std.error),
            p = list(tidy_base$p.value, tidy_interaction$p.value, tidy_full$p.value),
            #covariate.labels = c("Treatment: Violent Attack Within 5km (last 24 months)", "Social Protection", "Treatment x Social Protection"), 
            omit = c("age", "female", "rural", "windex5", "christian", "muslim", "(Intercept)"),
            title = paste("Effect of Proximity to Conflict on Children's", outcome_labels[outcome_var]),
            dep.var.labels.include = TRUE, dep.var.labels = outcome_labels[outcome_var],
            keep.stat = "n",
            add.lines = list(c("Controls Included", "No", "Yes", "Yes")))
  sink()  # Turn off redirection
}

# Initialize an empty data frame for custom table
results_df <- data.frame(Covariate = character(),
                         Mean_Treatment_Pre = numeric(),
                         Mean_Control_Pre = numeric(),
                         Mean_Treatment_Post = numeric(),
                         Mean_Control_Post = numeric(),
                         P_Value_Pre = numeric(),
                         P_Value_Post = numeric(),
                         stringsAsFactors = FALSE)

# Specify covariates for comparison
covariates <- c("age", "female", "rural", "windex5", "christian", "muslim")

# Initialize variables for counting observations
n_pre_treatment <- n_pre_control <- n_post_treatment <- n_post_control <- numeric(length(covariates))

# Loop through covariates to compute means and t-tests
for (cov in covariates) {
  pre_treatment_data <- nga_hl_21_ch_complete %>%
    filter(treatment == 1) %>%
    pull(!!sym(cov))
  pre_control_data <- nga_hl_21_ch_complete %>%
    filter(treatment == 0) %>%
    pull(!!sym(cov))
  post_treatment_data <- matched_data %>%
    filter(treatment == 1) %>%
    pull(!!sym(cov))
  post_control_data <- matched_data %>%
    filter(treatment == 0) %>%
    pull(!!sym(cov))
  
  # Calculate means and perform t-tests
  mean_treatment_pre <- mean(pre_treatment_data, na.rm = TRUE)
  mean_control_pre <- mean(pre_control_data, na.rm = TRUE)
  mean_treatment_post <- mean(post_treatment_data, na.rm = TRUE)
  mean_control_post <- mean(post_control_data, na.rm = TRUE)
  t_test_pre <- t.test(pre_treatment_data, pre_control_data)
  t_test_post <- t.test(post_treatment_data, post_control_data)
  
  # Add to results data frame
  results_df <- rbind(results_df, data.frame(
    Covariate = cov,
    Mean_Treatment_Pre = mean_treatment_pre,
    Mean_Control_Pre = mean_control_pre,
    Mean_Treatment_Post = mean_treatment_post,
    Mean_Control_Post = mean_control_post,
    P_Value_Pre = t_test_pre$p.value,
    P_Value_Post = t_test_post$p.value
  ))
}

# Calculate number of observations
n_treatment <- nrow(nga_hl_21_ch_complete %>% filter(treatment == 1))
n_control <- nrow(nga_hl_21_ch_complete %>% filter(treatment == 0))
n_treatment_matched <- nrow(matched_data %>% filter(treatment == 1))
n_control_matched <- nrow(matched_data %>% filter(treatment == 0))

# Add N row
results_df <- rbind(results_df, data.frame(
  Covariate = "N",
  Mean_Treatment_Pre = n_treatment,
  Mean_Control_Pre = n_control,
  Mean_Treatment_Post = n_treatment_matched,
  Mean_Control_Post = n_control_matched,
  P_Value_Pre = NA,
  P_Value_Post = NA
))

# Rename columns for clarity
names(results_df) <- c("Covariate",
                       "Mean Treatment Pre-Match",
                       "Mean Control Pre-Match",
                       "Mean Treatment Post-Match",
                       "Mean Control Post-Match",
                       "P-Value Pre-Match",
                       "P-Value Post-Match")

# Export the custom table to a CSV file
write.csv(results_df, "PSM_Balance_Check_HL.csv", row.names = FALSE)

print(results_df)

```

H.1B PSM: Effect of Proximity to Violent Events, Age<19: HL (ONLY WITHIN CONFLICT ZONES)
```{r}
# Required Libraries
library(MatchIt)
library(dplyr)
library(cobalt)
library(broom)
library(survey)
library(stargazer)
library(tidyr)
library(grf)

# Set survey option to handle single PSU in a stratum
options(survey.lonely.psu = "adjust")

# Subsetting data to include only those under age 19
nga_hl_21_ch <- subset(nga_hl_21, nga_hl_21$age < 19)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment

calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)

# Treatment Specifications
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, 0)
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)

# Focus on chronic violence (More than one violent event in the same zone)
#nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Subset of households living in conflict zones
nga_hl_21_ch <- subset(nga_hl_21_ch, nga_hl_21_ch$treatment==1)

# Print the summary of the new treatment variable
summary(nga_hl_21_ch$treatment)

# Clean data and create a complete data frame for matching
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  filter(complete.cases(soc_pro, age, female, rural, windex5, treatment, christian, muslim))

# Create survey design object for the full data
svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_hl_21_ch, singleunit = "scaled")

# Perform matching using the complete data frame
matchit_model <- matchit(soc_pro ~ age + female + rural + windex5 + christian + muslim,
                         data = nga_hl_21_ch_complete, method = "nearest")

# Extract matched data
matched_data <- match.data(matchit_model)

# Convert matched_data to a data frame
matched_data <- as.data.frame(matched_data)

# Create survey design object for the matched data
matched_svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = matched_data)

# Define outcome variables
outcome_labels <- c(
  school20 = "School Attendance (2020-2021)", 
  school19 = "School Attendance (2019-2020)", 
  # food1_20 = "Food Insecurity: Worried (last year)",
  # food2_20 = "Food Insecurity: Not eating healthy (last year)",
  # food3_20 = "Food Insecurity: Ate few kinds of food  (last year)",
  # food4_20 = "Food Insecurity: Skip a meal (last year)",
  # food5_20 = "Food Insecurity: Eating less  (last year)",
  # food6_20 = "Food Insecurity: Ran out of food  (last year)",
  # food7_20 = "Food Insecurity: Hungry and did not eat (last year)",
  # food8_20 = "Food Insecurity: A Day Without Eating (last year)",
  # food1_covid = "Food Insecurity due COVID: Worried (last year)",
  # food2_covid = "Food Insecurity due COVID: Not eating healthy (last year)",
  # food3_covid = "Food Insecurity due COVID: Ate few kinds of food  (last year)",
  # food4_covid = "Food Insecurity due COVID: Skip a meal (last year)",
  # food5_covid = "Food Insecurity due COVID: Eating less  (last year)",
  # food6_covid = "Food Insecurity due COVID: Ran out of food  (last year)",
  # food7_covid = "Food Insecurity due COVID: Hungry and did not eat (last year)",
  # food8_covid = "Food Insecurity due COVID: A Day Without Eating (last year)",
  food1_21 = "Food Insecurity: Worried (last month)",
  food2_21 = "Food Insecurity: Not eating healthy (last month)",
  food3_21 = "Food Insecurity: Ate few kinds of food  (last month)",
  food4_21 = "Food Insecurity: Skip a meal (last month)",
  food5_21 = "Food Insecurity: Eating less  (last month)",
  food6_21 = "Food Insecurity: Ran out of food  (last month)",
  food7_21 = "Food Insecurity: Hungry and did not eat (last month)",
  food8_21 = "Food Insecurity: A Day Without Eating (last month)"
)

# Loop through each outcome variable to fit models using the survey design and save regression tables
for (outcome_var in names(outcome_labels)) {
  formula_base <- as.formula(paste(outcome_var, "~ soc_pro"))
  formula_interaction_soc_pro <- as.formula(paste(outcome_var, "~ soc_pro + age + female + rural + windex5 + christian + muslim"))

  # Fit models using survey design
  model_base <- svyglm(formula_base, design = matched_svy_design, family = binomial())
  model_interaction_soc_pro <- svyglm(formula_interaction_soc_pro, design = matched_svy_design, family = binomial())

  # Create a list of models for current outcome
  models_for_outcome <- list(model_base, model_interaction_soc_pro)

  # Use the tidy() function from the broom package to extract model results
  tidy_base <- broom::tidy(model_base)
  tidy_interaction <- broom::tidy(model_interaction_soc_pro)
  tidy_full <- broom::tidy(model_with_covariates_and_interaction)

  # Exponentiate coefficients for interpretation as odds ratios
  tidy_base$estimate <- exp(tidy_base$estimate)
  tidy_interaction$estimate <- exp(tidy_interaction$estimate)
  tidy_full$estimate <- exp(tidy_full$estimate)

  # Stargazer output
  output_filename_stargazer <- paste0("matched_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), ".txt")
  sink(output_filename_stargazer)
  stargazer(models_for_outcome, type = "text",
            coef = list(tidy_base$estimate, tidy_interaction$estimate, tidy_full$estimate),
            se = list(tidy_base$std.error, tidy_interaction$std.error, tidy_full$std.error),
            p = list(tidy_base$p.value, tidy_interaction$p.value, tidy_full$p.value),
            covariate.labels = c("Social Protection"), 
            omit = c("age", "female", "rural", "windex5", "christian", "muslim", "(Intercept)"),
            title = paste("Children Living in Conflict Zones: Effect of Cash Transfers on", outcome_labels[outcome_var]),
            dep.var.labels.include = TRUE, dep.var.labels = outcome_labels[outcome_var],
            keep.stat = "n",
            add.lines = list(c("Controls Included", "No", "Yes", "Yes")))
  sink()  # Turn off redirection
}

# Initialize an empty data frame for custom table
results_df <- data.frame(Covariate = character(),
                         Mean_Treatment_Pre = numeric(),
                         Mean_Control_Pre = numeric(),
                         Mean_Treatment_Post = numeric(),
                         Mean_Control_Post = numeric(),
                         P_Value_Pre = numeric(),
                         P_Value_Post = numeric(),
                         stringsAsFactors = FALSE)

# Specify covariates for comparison
covariates <- c("age", "female", "rural", "windex5", "christian", "muslim")

# Initialize variables for counting observations
n_pre_treatment <- n_pre_control <- n_post_treatment <- n_post_control <- numeric(length(covariates))

# Loop through covariates to compute means and t-tests
for (cov in covariates) {
  pre_treatment_data <- nga_hl_21_ch_complete %>%
    filter(treatment == 1) %>%
    pull(!!sym(cov))
  pre_control_data <- nga_hl_21_ch_complete %>%
    filter(treatment == 0) %>%
    pull(!!sym(cov))
  post_treatment_data <- matched_data %>%
    filter(treatment == 1) %>%
    pull(!!sym(cov))
  post_control_data <- matched_data %>%
    filter(treatment == 0) %>%
    pull(!!sym(cov))
  
  # Calculate means and perform t-tests
  mean_treatment_pre <- mean(pre_treatment_data, na.rm = TRUE)
  mean_control_pre <- mean(pre_control_data, na.rm = TRUE)
  mean_treatment_post <- mean(post_treatment_data, na.rm = TRUE)
  mean_control_post <- mean(post_control_data, na.rm = TRUE)
  t_test_pre <- t.test(pre_treatment_data, pre_control_data)
  t_test_post <- t.test(post_treatment_data, post_control_data)
  
  # Add to results data frame
  results_df <- rbind(results_df, data.frame(
    Covariate = cov,
    Mean_Treatment_Pre = mean_treatment_pre,
    Mean_Control_Pre = mean_control_pre,
    Mean_Treatment_Post = mean_treatment_post,
    Mean_Control_Post = mean_control_post,
    P_Value_Pre = t_test_pre$p.value,
    P_Value_Post = t_test_post$p.value
  ))
}

# Calculate number of observations
n_treatment <- nrow(nga_hl_21_ch_complete %>% filter(treatment == 1))
n_control <- nrow(nga_hl_21_ch_complete %>% filter(treatment == 0))
n_treatment_matched <- nrow(matched_data %>% filter(treatment == 1))
n_control_matched <- nrow(matched_data %>% filter(treatment == 0))

# Add N row
results_df <- rbind(results_df, data.frame(
  Covariate = "N",
  Mean_Treatment_Pre = n_treatment,
  Mean_Control_Pre = n_control,
  Mean_Treatment_Post = n_treatment_matched,
  Mean_Control_Post = n_control_matched,
  P_Value_Pre = NA,
  P_Value_Post = NA
))

# Rename columns for clarity
names(results_df) <- c("Covariate",
                       "Mean Treatment Pre-Match",
                       "Mean Control Pre-Match",
                       "Mean Treatment Post-Match",
                       "Mean Control Post-Match",
                       "P-Value Pre-Match",
                       "P-Value Post-Match")

# Export the custom table to a CSV file
write.csv(results_df, "PSM_Balance_Check_HL.csv", row.names = FALSE)

print(results_df)

```

H.1C Causal Forest: Individual Characteristics of Individuals with High Predicted Impact: Conflict (Food Insecurity)
```{r}
library(grf)
library(dplyr)
library(ggplot2)

# Define the function to calculate treatment
calculate_treatment <- function(data, num_t) {
  t_vars <- paste0("t", 1:num_t)
  data$treatment <- rowSums(data[, t_vars], na.rm = TRUE)
  data$treatment[rowSums(!is.na(data[, t_vars])) == 0] <- NA
  return(data)
}

# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21$soil_2020_avg.x, 0.5, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21 <- nga_hl_21 %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Subset data to include only those under age 20
nga_hl_21_ch <- subset(nga_hl_21, dry == 1)

# Apply the treatment calculation function
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, NA)
nga_hl_21_ch$treatment_chronic[nga_hl_21_ch$treatment == 0] <- 0
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)
nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Keep only the variables of interest and drop rows with NA values
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  select(soc_pro, age, female, rural, windex5, christian, muslim, treatment, soil_2020_avg.x, food7_21) %>%
  na.omit()

# Define the covariates matrix
X <- nga_hl_21_ch_complete %>%
  select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x) %>%
  as.matrix()

# Define the treatment and outcome variables
W <- as.vector(nga_hl_21_ch_complete$treatment)
Y <- as.vector(nga_hl_21_ch_complete$food7_21)

# Check for NAs in the variables
if (any(is.na(X)) || any(is.na(W)) || any(is.na(Y))) {
  stop("There are NA values in the covariates, treatment, or outcome variables.")
}

# Train the causal forest model
causal_forest_model <- causal_forest(X, Y, W, honesty = TRUE)

# Get the propensity scores
propensities <- causal_forest_model$W.hat

# Filter data to exclude extreme propensity scores (e.g., below 0.1 or above 0.9)
propensity_cutoff_low <- 0.1
propensity_cutoff_high <- 0.9

filtered_data <- nga_hl_21_ch_complete[
  propensities > propensity_cutoff_low & propensities < propensity_cutoff_high, 
]

# Redefine the covariates matrix, treatment, and outcome for the filtered data
X_filtered <- as.matrix(filtered_data %>% select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x))
W_filtered <- as.vector(filtered_data$treatment)
Y_filtered <- as.vector(filtered_data$food7_21)

# Re-train the causal forest model on the filtered data
causal_forest_model_filtered <- causal_forest(X_filtered, Y_filtered, W_filtered, honesty = TRUE)

# Calculate the general CATE for treatment on food insecurity
ate_filtered <- average_treatment_effect(causal_forest_model_filtered)

# Calculate the p-value for the general CATE
p_value_filtered <- 2 * pnorm(-abs(ate_filtered[1] / ate_filtered[2]))

# Determine statistical significance stars
stars <- ""
if (!is.na(p_value_filtered)) {
  if (p_value_filtered < 0.01) {
    stars <- "***"
  } else if (p_value_filtered < 0.05) {
    stars <- "**"
  } else if (p_value_filtered < 0.1) {
    stars <- "*"
  }
}

# Check if the result is valid and print the general CATE, standard error, p-value, and total number of observations
if (!is.nan(ate_filtered[1])) {
  cat("General CATE of Conflict on Food Insecurity (2020-2021):", round(ate_filtered[1], 3), stars, "\n")
  cat("Standard Error:", round(ate_filtered[2], 3), "\n")
  cat("P-Value:", round(p_value_filtered, 3), "\n")
  cat("Total Number of Observations for General CATE:", nrow(filtered_data), "\n")
} else {
  cat("The General CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# RATE analysis for the filtered data
cate_hat_filtered <- predict(causal_forest_model_filtered, X_filtered)$predictions
cf_eval_filtered <- causal_forest(X_filtered, Y_filtered, W_filtered)

# Perform RATE analysis and plot the TOC curve
rate_filtered <- rank_average_treatment_effect(cf_eval_filtered, cate_hat_filtered)
plot(rate_filtered, main = "TOC Curve for Food Insecurity (2020-2021) with Overlap Sample")

# Print the RATE estimates and standard errors
cat("RATE Estimate:", rate_filtered$estimate, "\n")
cat("RATE Standard Error:", rate_filtered$std.err, "\n")

# Plot the characteristics of individuals with the highest predicted treatment effect in the filtered data
top_fraction <- 0.1
top_individuals_filtered <- filtered_data %>%
  arrange(desc(cate_hat_filtered)) %>%
  top_frac(top_fraction, cate_hat_filtered)

# Age distribution
ggplot(top_individuals_filtered, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Age", y = "Count")

# Gender distribution
ggplot(top_individuals_filtered, aes(x = factor(female))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Gender Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Female (1 = Yes, 0 = No)", y = "Count")

# Rural status distribution
ggplot(top_individuals_filtered, aes(x = factor(rural))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Rural Status of Top 10% Individuals by Predicted Treatment Effect",
       x = "Rural (1 = Yes, 0 = No)", y = "Count")

# Wealth Index distribution
ggplot(top_individuals_filtered, aes(x = windex5)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Wealth Index Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Wealth Index", y = "Count")

# Christian distribution
ggplot(top_individuals_filtered, aes(x = factor(christian))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Christian Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Christian (1 = Yes, 0 = No)", y = "Count")

# Muslim distribution
ggplot(top_individuals_filtered, aes(x = factor(muslim))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Muslim Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Muslim (1 = Yes, 0 = No)", y = "Count")

# Soil Moisture Average distribution
ggplot(top_individuals_filtered, aes(x = soil_2020_avg.x)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Soil Moisture Average (2020) of Top 10% Individuals by Predicted Treatment Effect",
       x = "Soil Moisture Average (2020)", y = "Count")

```

H.1C Causal Forest: Individual Characteristics of Individuals with High Predicted Impact: Conflict (Education)
```{r}
library(grf)
library(dplyr)
library(ggplot2)

# Define the function to calculate treatment
calculate_treatment <- function(data, num_t) {
  t_vars <- paste0("t", 1:num_t)
  data$treatment <- rowSums(data[, t_vars], na.rm = TRUE)
  data$treatment[rowSums(!is.na(data[, t_vars])) == 0] <- NA
  return(data)
}

# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21$soil_2020_avg.x, 0.5, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21 <- nga_hl_21 %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Subset data to include only those under age 20
nga_hl_21_ch <- subset(nga_hl_21, dry == 1)

# Apply the treatment calculation function
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, NA)
nga_hl_21_ch$treatment_chronic[nga_hl_21_ch$treatment == 0] <- 0
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)
nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Keep only the variables of interest and drop rows with NA values
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  select(soc_pro, age, female, rural, windex5, christian, muslim, treatment, soil_2020_avg.x, school20) %>%
  na.omit()

# Define the covariates matrix
X <- nga_hl_21_ch_complete %>%
  select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x) %>%
  as.matrix()

# Define the treatment and outcome variables
W <- as.vector(nga_hl_21_ch_complete$treatment)
Y <- as.vector(nga_hl_21_ch_complete$school20)

# Check for NAs in the variables
if (any(is.na(X)) || any(is.na(W)) || any(is.na(Y))) {
  stop("There are NA values in the covariates, treatment, or outcome variables.")
}

# Train the causal forest model
causal_forest_model <- causal_forest(X, Y, W, honesty = TRUE)

# Calculate the general CATE for treatment on school attendance
ate_general <- average_treatment_effect(causal_forest_model)

# Calculate the p-value for the general CATE
p_value_general <- 2 * pnorm(-abs(ate_general[1] / ate_general[2]))

# Determine statistical significance stars
stars <- ""
if (!is.na(p_value_general)) {
  if (p_value_general < 0.01) {
    stars <- "***"
  } else if (p_value_general < 0.05) {
    stars <- "**"
  } else if (p_value_general < 0.1) {
    stars <- "*"
  }
}

# Check if the result is valid and print the general CATE, standard error, p-value, and total number of observations
if (!is.nan(ate_general[1])) {
  cat("General CATE of Conflict on School Attendance (2020-2021):", round(ate_general[1], 3), stars, "\n")
  cat("Standard Error:", round(ate_general[2], 3), "\n")
  cat("P-Value:", round(p_value_general, 3), "\n")
  cat("Total Number of Observations for General CATE:", nrow(nga_hl_21_ch_complete), "\n")
} else {
  cat("The General CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# RATE analysis for the general CATE (without trimming)
cate_hat <- predict(causal_forest_model, X)$predictions
cf_eval <- causal_forest(X, Y, W)

# Perform RATE analysis and plot the TOC curve
rate <- rank_average_treatment_effect(cf_eval, cate_hat)
plot(rate, main = "TOC Curve for School Attendance (2020-2021) without trimmed data")

# Print the RATE estimates and standard errors
cat("RATE Estimate:", rate$estimate, "\n")
cat("RATE Standard Error:", rate$std.err, "\n")

# Plot the characteristics of individuals with the highest predicted treatment effect
top_fraction <- 0.1
top_individuals <- nga_hl_21_ch_complete %>%
  arrange(desc(cate_hat)) %>%
  top_frac(top_fraction, cate_hat)

# Age distribution
ggplot(top_individuals, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Age", y = "Count")

# Gender distribution
ggplot(top_individuals, aes(x = factor(female))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Gender Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Female (1 = Yes, 0 = No)", y = "Count")

# Rural status distribution
ggplot(top_individuals, aes(x = factor(rural))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Rural Status of Top 10% Individuals by Predicted Treatment Effect",
       x = "Rural (1 = Yes, 0 = No)", y = "Count")

# Wealth Index distribution
ggplot(top_individuals, aes(x = windex5)) +
  geom_histogram(binwidth = 0.5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Wealth Index Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Wealth Index", y = "Count")

# Christian distribution
ggplot(top_individuals, aes(x = factor(christian))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Christian Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Christian (1 = Yes, 0 = No)", y = "Count")

# Muslim distribution
ggplot(top_individuals, aes(x = factor(muslim))) +
  geom_bar(fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Muslim Distribution of Top 10% Individuals by Predicted Treatment Effect",
       x = "Muslim (1 = Yes, 0 = No)", y = "Count")

# Soil Moisture Average distribution
ggplot(top_individuals, aes(x = soil_2020_avg.x)) +
  geom_histogram(binwidth = 0.05, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Soil Moisture Average (2020) of Top 10% Individuals by Predicted Treatment Effect",
       x = "Soil Moisture Average (2020)", y = "Count")

```

H.1D Causal Forest: Individual Characteristics of Individuals with Lowest Predicted Impact: Conflict
```{r}
library(grf)
library(dplyr)
library(ggplot2)

# Define the function to calculate treatment
calculate_treatment <- function(data, num_t) {
  t_vars <- paste0("t", 1:num_t)
  data$treatment <- rowSums(data[, t_vars], na.rm = TRUE)
  data$treatment[rowSums(!is.na(data[, t_vars])) == 0] <- NA
  return(data)
}

# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21$soil_2020_avg.x, 0.5, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21 <- nga_hl_21 %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Subset data to include only those under age 20
nga_hl_21_ch <- subset(nga_hl_21, dry == 1)

# Apply the treatment calculation function
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, NA)
nga_hl_21_ch$treatment_chronic[nga_hl_21_ch$treatment == 0] <- 0
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)
nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Keep only the variables of interest and drop rows with NA values
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  select(soc_pro, age, female, rural, windex5, christian, muslim, treatment, soil_2020_avg.x, school20) %>%
  na.omit()

# Define the covariates matrix
X <- nga_hl_21_ch_complete %>%
  select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x) %>%
  as.matrix()

# Define the treatment and outcome variables
W <- as.vector(nga_hl_21_ch_complete$treatment)
Y <- as.vector(nga_hl_21_ch_complete$school20)

# Check for NAs in the variables
if (any(is.na(X)) || any(is.na(W)) || any(is.na(Y))) {
  stop("There are NA values in the covariates, treatment, or outcome variables.")
}

# Train the causal forest model
causal_forest_model <- causal_forest(X, Y, W, honesty = TRUE)

# Calculate the general CATE for treatment on school attendance
ate_general <- average_treatment_effect(causal_forest_model)

# Calculate the p-value for the general CATE
p_value_general <- 2 * pnorm(-abs(ate_general[1] / ate_general[2]))

# Determine statistical significance stars
stars <- ""
if (!is.na(p_value_general)) {
  if (p_value_general < 0.01) {
    stars <- "***"
  } else if (p_value_general < 0.05) {
    stars <- "**"
  } else if (p_value_general < 0.1) {
    stars <- "*"
  }
}

# Check if the result is valid and print the general CATE, standard error, p-value, and total number of observations
if (!is.nan(ate_general[1])) {
  cat("General CATE of Conflict on School Attendance (2020-2021):", round(ate_general[1], 3), stars, "\n")
  cat("Standard Error:", round(ate_general[2], 3), "\n")
  cat("P-Value:", round(p_value_general, 3), "\n")
  cat("Total Number of Observations for General CATE:", nrow(nga_hl_21_ch_complete), "\n")
} else {
  cat("The General CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# RATE analysis for the general CATE (without trimming)
cate_hat <- predict(causal_forest_model, X)$predictions
cf_eval <- causal_forest(X, Y, W)

# Perform RATE analysis and plot the TOC curve
rate <- rank_average_treatment_effect(cf_eval, cate_hat)
plot(rate, main = "TOC Curve for School Attendance (2020-2021) without trimmed data")

# Print the RATE estimates and standard errors
cat("RATE Estimate:", rate$estimate, "\n")
cat("RATE Standard Error:", rate$std.err, "\n")

# Plot the characteristics of individuals with the lowest predicted treatment effect
bottom_fraction <- 0.1
bottom_individuals <- nga_hl_21_ch_complete %>%
  arrange(cate_hat) %>%
  top_frac(bottom_fraction, -cate_hat)

# Age distribution
ggplot(bottom_individuals, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Age", y = "Count")

# Gender distribution
ggplot(bottom_individuals, aes(x = factor(female))) +
  geom_bar(fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Gender Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Female (1 = Yes, 0 = No)", y = "Count")

# Rural status distribution
ggplot(bottom_individuals, aes(x = factor(rural))) +
  geom_bar(fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Rural Status of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Rural (1 = Yes, 0 = No)", y = "Count")

# Wealth Index distribution
ggplot(bottom_individuals, aes(x = windex5)) +
  geom_histogram(binwidth = 0.5, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Wealth Index Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Wealth Index", y = "Count")

# Christian distribution
ggplot(bottom_individuals, aes(x = factor(christian))) +
  geom_bar(fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Christian Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Christian (1 = Yes, 0 = No)", y = "Count")

# Muslim distribution
ggplot(bottom_individuals, aes(x = factor(muslim))) +
  geom_bar(fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Muslim Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Muslim (1 = Yes, 0 = No)", y = "Count")

# Soil Moisture Average distribution
ggplot(bottom_individuals, aes(x = soil_2020_avg.x)) +
  geom_histogram(binwidth = 0.05, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Soil Moisture Average (2020) of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Soil Moisture Average (2020)", y = "Count")

```

H.1E Causal Forest: Individual Characteristics of Individuals with High Predicted Impact: Soc Pro in Conflict Zones
```{r}
library(grf)
library(dplyr)
library(ggplot2)

# Define the function to calculate treatment
calculate_treatment <- function(data, num_t) {
  t_vars <- paste0("t", 1:num_t)
  data$treatment <- rowSums(data[, t_vars], na.rm = TRUE)
  data$treatment[rowSums(!is.na(data[, t_vars])) == 0] <- NA
  return(data)
}

# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21$soil_2020_avg.x, 0.5, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21 <- nga_hl_21 %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Subset data to include only those under age 20, where dry == 1 and treatment == 1
nga_hl_21_ch <- subset(nga_hl_21, dry == 1 & treatment == 1)

# Apply the treatment calculation function
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, NA)
nga_hl_21_ch$treatment_chronic[nga_hl_21_ch$treatment == 0] <- 0
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)
nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Keep only the variables of interest and drop rows with NA values
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  select(soc_pro, age, female, rural, windex5, christian, muslim, soil_2020_avg.x, school20) %>%
  na.omit()

# Define the covariates matrix
X <- nga_hl_21_ch_complete %>%
  select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x) %>%
  as.matrix()

# Define the treatment and outcome variables
W <- as.vector(nga_hl_21_ch_complete$soc_pro)
Y <- as.vector(nga_hl_21_ch_complete$school20)

# Check for NAs in the variables
if (any(is.na(X)) || any(is.na(W)) || any(is.na(Y))) {
  stop("There are NA values in the covariates, treatment, or outcome variables.")
}

# Train the causal forest model
causal_forest_model <- causal_forest(X, Y, W, honesty = TRUE)

# Get the propensity scores
propensities <- causal_forest_model$W.hat

# Trim the data to focus on middle propensity scores
propensity_cutoff_low <- 0.01
propensity_cutoff_high <- 0.09

trimmed_data <- nga_hl_21_ch_complete[
  propensities > propensity_cutoff_low & propensities < propensity_cutoff_high, 
]

# Define the covariates matrix, treatment, and outcome for the trimmed data
X_trimmed <- as.matrix(trimmed_data %>% select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x))
W_trimmed <- as.vector(trimmed_data$soc_pro)
Y_trimmed <- as.vector(trimmed_data$school20)

# Re-run the causal forest model on the trimmed data
causal_forest_model_trimmed <- causal_forest(X_trimmed, Y_trimmed, W_trimmed, honesty = TRUE)

# Calculate the CATE for social protection on school attendance using the trimmed data
ate_soc_pro_trimmed <- average_treatment_effect(causal_forest_model_trimmed)

# Check if the result is valid
if (!is.nan(ate_soc_pro_trimmed[1])) {
  cat("CATE of Social Protection on School Attendance (2020-2021) - Trimmed Data:", round(ate_soc_pro_trimmed[1], 3), "\n")
  cat("Standard Error:", round(ate_soc_pro_trimmed[2], 3), "\n")
  cat("Total Number of Observations:", nrow(trimmed_data), "\n")
  
  # Determine statistical significance
  p_value <- 2 * pnorm(-abs(ate_soc_pro_trimmed[1] / ate_soc_pro_trimmed[2]))
  if (p_value < 0.01) {
    cat("Statistical Significance: *** (p < 0.01)\n")
  } else if (p_value < 0.05) {
    cat("Statistical Significance: ** (p < 0.05)\n")
  } else if (p_value < 0.1) {
    cat("Statistical Significance: * (p < 0.1)\n")
  } else {
    cat("Statistical Significance: Not significant\n")
  }
} else {
  cat("The CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# If you want to explore the bottom 10% by predicted treatment effect after trimming
predictions_general <- predict(causal_forest_model_trimmed)$predictions
trimmed_data <- trimmed_data %>%
  mutate(predicted_treatment_effect = predictions_general) %>%
  arrange(predicted_treatment_effect)

bottom_fraction <- 0.1
bottom_individuals <- trimmed_data %>%
  top_frac(bottom_fraction, predicted_treatment_effect)

# Plot the characteristics of these individuals

# Age distribution
ggplot(bottom_individuals, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Age", y = "Count")

# Gender distribution
ggplot(bottom_individuals, aes(x = factor(female))) +
  geom_bar(fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Gender Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Female (1 = Yes, 0 = No)", y = "Count")

# Rural status distribution
ggplot(bottom_individuals, aes(x = factor(rural))) +
  geom_bar(fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Rural Status of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Rural (1 = Yes, 0 = No)", y = "Count")

# Wealth Index distribution
ggplot(bottom_individuals, aes(x = windex5)) +
  geom_histogram(binwidth = 0.5, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Wealth Index Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Wealth Index", y = "Count")

# Christian distribution
ggplot(bottom_individuals, aes(x = factor(christian))) +
  geom_bar(fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Christian Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Christian (1 = Yes, 0 = No)", y = "Count")

# Muslim distribution
ggplot(bottom_individuals, aes(x = factor(muslim))) +
  geom_bar(fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Muslim Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Muslim (1 = Yes, 0 = No)", y = "Count")

# Soil Moisture Average distribution
ggplot(bottom_individuals, aes(x = soil_2020_avg.x)) +
  geom_histogram(binwidth = 0.05, fill = "green", color = "black", alpha = 0.7) +
  labs(title = "Soil Moisture Average (2020) of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Soil Moisture Average (2020)", y = "Count")

```

H.1G Causal Forest: Individual Characteristics of Individuals with Lowest Predicted Impact: Soc Pro in Conflict Zones
```{r}
library(grf)
library(dplyr)
library(ggplot2)

# Define the function to calculate treatment
calculate_treatment <- function(data, num_t) {
  t_vars <- paste0("t", 1:num_t)
  data$treatment <- rowSums(data[, t_vars], na.rm = TRUE)
  data$treatment[rowSums(!is.na(data[, t_vars])) == 0] <- NA
  return(data)
}

# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21$soil_2020_avg.x, 0.5, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21 <- nga_hl_21 %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Subset data to include only those under age 20, where dry == 1 and treatment == 1
nga_hl_21_ch <- subset(nga_hl_21, dry == 1 & treatment == 1)

# Apply the treatment calculation function
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, NA)
nga_hl_21_ch$treatment_chronic[nga_hl_21_ch$treatment == 0] <- 0
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)
nga_hl_21_ch$treatment <- nga_hl_21_ch$treatment_chronic

# Keep only the variables of interest and drop rows with NA values
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  select(soc_pro, age, female, rural, windex5, christian, muslim, soil_2020_avg.x, school20) %>%
  na.omit()

# Define the covariates matrix
X <- nga_hl_21_ch_complete %>%
  select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x) %>%
  as.matrix()

# Define the treatment and outcome variables
W <- as.vector(nga_hl_21_ch_complete$soc_pro)
Y <- as.vector(nga_hl_21_ch_complete$school20)

# Check for NAs in the variables
if (any(is.na(X)) || any(is.na(W)) || any(is.na(Y))) {
  stop("There are NA values in the covariates, treatment, or outcome variables.")
}

# Train the causal forest model
causal_forest_model <- causal_forest(X, Y, W, honesty = TRUE)

# Calculate the general CATE for social protection on school attendance
ate_soc_pro_general <- average_treatment_effect(causal_forest_model)

# Calculate the p-value for the general CATE
p_value_general <- 2 * pnorm(-abs(ate_soc_pro_general[1] / ate_soc_pro_general[2]))

# Check if the result is valid and print the CATE, standard error, p-value, and total number of observations
if (!is.nan(ate_soc_pro_general[1])) {
  cat("General CATE of Social Protection on School Attendance (2020-2021):", round(ate_soc_pro_general[1], 3), "\n")
  cat("Standard Error:", round(ate_soc_pro_general[2], 3), "\n")
  cat("P-Value:", round(p_value_general, 3), "\n")
  cat("Total Number of Observations for General CATE:", nrow(nga_hl_21_ch_complete), "\n")
  
  # Determine statistical significance
  if (p_value_general < 0.01) {
    cat("Statistical Significance: *** (p < 0.01)\n")
  } else if (p_value_general < 0.05) {
    cat("Statistical Significance: ** (p < 0.05)\n")
  } else if (p_value_general < 0.1) {
    cat("Statistical Significance: * (p < 0.1)\n")
  } else {
    cat("Statistical Significance: Not significant\n")
  }
} else {
  cat("The General CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# Trim the data to focus on low propensity scores (lowest impact)
propensities <- causal_forest_model$W.hat
propensity_cutoff_low <- 0.01
propensity_cutoff_high <- 0.09

trimmed_data <- nga_hl_21_ch_complete[
  propensities > propensity_cutoff_low & propensities < propensity_cutoff_high, 
]

# Define the covariates matrix, treatment, and outcome for the trimmed data
X_trimmed <- as.matrix(trimmed_data %>% select(age, female, rural, windex5, christian, muslim, soil_2020_avg.x))
W_trimmed <- as.vector(trimmed_data$soc_pro)
Y_trimmed <- as.vector(trimmed_data$school20)

# Re-run the causal forest model on the trimmed data
causal_forest_model_trimmed <- causal_forest(X_trimmed, Y_trimmed, W_trimmed, honesty = TRUE)

# Calculate the CATE for social protection on school attendance using the trimmed data
ate_soc_pro_trimmed <- average_treatment_effect(causal_forest_model_trimmed)

# Check if the result is valid
if (!is.nan(ate_soc_pro_trimmed[1])) {
  cat("CATE of Social Protection on School Attendance (2020-2021) - Trimmed Data:", round(ate_soc_pro_trimmed[1], 3), "\n")
  cat("Standard Error:", round(ate_soc_pro_trimmed[2], 3), "\n")
  cat("Total Number of Observations:", nrow(trimmed_data), "\n")
  
  # Determine statistical significance
  p_value <- 2 * pnorm(-abs(ate_soc_pro_trimmed[1] / ate_soc_pro_trimmed[2]))
  if (p_value < 0.01) {
    cat("Statistical Significance: *** (p < 0.01)\n")
  } else if (p_value < 0.05) {
    cat("Statistical Significance: ** (p < 0.05)\n")
  } else if (p_value < 0.1) {
    cat("Statistical Significance: * (p < 0.1)\n")
  } else {
    cat("Statistical Significance: Not significant\n")
  }
} else {
  cat("The CATE could not be estimated. Consider further filtering the data or using a different method.\n")
}

# Explore the bottom 10% by predicted treatment effect after trimming
predictions_general <- predict(causal_forest_model_trimmed)$predictions
trimmed_data <- trimmed_data %>%
  mutate(predicted_treatment_effect = predictions_general) %>%
  arrange(predicted_treatment_effect)

bottom_fraction <- 0.1
bottom_individuals <- trimmed_data %>%
  top_frac(bottom_fraction, -predicted_treatment_effect)

# Plot the characteristics of these individuals

# Age distribution
ggplot(bottom_individuals, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Age Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Age", y = "Count")

# Gender distribution
ggplot(bottom_individuals, aes(x = factor(female))) +
  geom_bar(fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Gender Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Female (1 = Yes, 0 = No)", y = "Count")

# Rural status distribution
ggplot(bottom_individuals, aes(x = factor(rural))) +
  geom_bar(fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Rural Status of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Rural (1 = Yes, 0 = No)", y = "Count")

# Wealth Index distribution
ggplot(bottom_individuals, aes(x = windex5)) +
  geom_histogram(binwidth = 0.5, fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Wealth Index Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Wealth Index", y = "Count")

# Christian distribution
ggplot(bottom_individuals, aes(x = factor(christian))) +
  geom_bar(fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Christian Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Christian (1 = Yes, 0 = No)", y = "Count")

# Muslim distribution
ggplot(bottom_individuals, aes(x = factor(muslim))) +
  geom_bar(fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Muslim Distribution of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Muslim (1 = Yes, 0 = No)", y = "Count")

# Soil Moisture Average distribution
ggplot(bottom_individuals, aes(x = soil_2020_avg.x)) +
  geom_histogram(binwidth = 0.05, fill = "purple", color = "black", alpha = 0.7) +
  labs(title = "Soil Moisture Average (2020) of Bottom 10% Individuals by Predicted Treatment Effect",
       x = "Soil Moisture Average (2020)", y = "Count")

```

H.1D IV: Effect of Proximity to Violent Events, Age<20: HL (Combined Social Protection)
```{r}
# Load necessary libraries
library(dplyr)
library(sf)
library(AER)
library(stargazer)
library(survey)

# Compute soc_pro variable considering NA values
nga_hl_21 <- nga_hl_21 %>%
  mutate(
    soc_pro = rowSums(select(., soc_cash, soc_pension, soc_hup), na.rm = TRUE),
    soc_pro = ifelse(is.na(soc_cash) & is.na(soc_pension) & is.na(soc_hup), NA, soc_pro)
  )

# Subsetting data to include only those under age 19
nga_hl_21_ch <- subset(nga_hl_21, nga_hl_21$age < 20)

### Define IV ###
# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21_ch$soil_2020_avg.x, 0.25, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21_ch <- nga_hl_21_ch %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Check the first few rows to ensure the dummy variable is created correctly
head(nga_hl_21_ch)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment
calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)

# Treatment Specifications
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, 0)
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)

# Print the summary of the new treatment variable
summary(nga_hl_21_ch$treatment)

# Clean data and create a complete data frame for the IV approach
nga_hl_21_ch_complete <- nga_hl_21_ch %>%
  filter(complete.cases(soc_pro, age, female, rural, windex5, treatment, christian, muslim, dry))

# Create survey design object for the full data
svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_hl_21_ch, singleunit = "scaled")

# Define outcome variables
outcome_labels <- c(
  school20 = "School Attendance (2020-2021)", 
  school19 = "School Attendance (2019-2020)", 
  food1_21 = "Food Insecurity: Worried (last month)",
  food2_21 = "Food Insecurity: Not eating healthy (last month)",
  food3_21 = "Food Insecurity: Ate few kinds of food  (last month)",
  food4_21 = "Food Insecurity: Skip a meal (last month)",
  food5_21 = "Food Insecurity: Eating less  (last month)",
  food6_21 = "Food Insecurity: Ran out of food  (last month)",
  food7_21 = "Food Insecurity: Hungry and did not eat (last month)",
  food8_21 = "Food Insecurity: A Day Without Eating (last month)"
)

# Function to exponentiate coefficients and calculate robust standard errors
exponentiate_results <- function(model) {
  coef_table <- summary(model)$coefficients
  exp_coef <- exp(coef_table[, 1])
  robust_se <- coef_table[, 2]
  p_values <- coef_table[, 4]
  result <- data.frame(Estimate = exp_coef, `Robust SE` = robust_se, `P-Value` = p_values)
  return(result)
}

# Loop through each outcome variable to fit IV models and save regression tables
for (outcome_var in names(outcome_labels)) {
  complete_cases <- nga_hl_21_ch_complete %>%
    filter(!is.na(!!sym(outcome_var)))
  
  # Ensure the outcome variable is binary (0/1)
  complete_cases[[outcome_var]] <- ifelse(complete_cases[[outcome_var]] > 1, 1, complete_cases[[outcome_var]])
  
  # Create survey design object for the complete cases
  svy_design_complete <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = complete_cases, singleunit = "scaled")
  
  # First stage: Regress treatment on the instrument and covariates
  formula_first_stage <- as.formula(paste("treatment ~ dry + age + female + rural + windex5 + christian + muslim"))
  first_stage <- svyglm(formula_first_stage, design = svy_design_complete)

  # Calculate the F-statistic manually
  first_stage_ssr <- sum((fitted(first_stage) - mean(fitted(first_stage)))^2)
  first_stage_sse <- sum(residuals(first_stage)^2)
  first_stage_fstat <- (first_stage_ssr / length(coef(first_stage))) / (first_stage_sse / df.residual(first_stage))
  first_stage_fstat <- as.numeric(first_stage_fstat)

  # Generate predicted treatment values (treatment_hat)
  complete_cases$treatment_hat <- predict(first_stage, complete_cases, type = "response")
  
  # Update survey design to include treatment_hat
  svy_design_complete <- update(svy_design_complete, treatment_hat = complete_cases$treatment_hat)
  
  # Second stage specifications
  formula_second_stage_1 <- as.formula(paste(outcome_var, "~ treatment_hat + age + female + rural + windex5 + christian + muslim"))
  formula_second_stage_2 <- as.formula(paste(outcome_var, "~ treatment_hat + soc_pro + age + female + rural + windex5 + christian + muslim"))
  formula_second_stage_3 <- as.formula(paste(outcome_var, "~ treatment_hat * soc_pro + age + female + rural + windex5 + christian + muslim"))
  
  # Fit the second stage models
  second_stage_1 <- svyglm(formula_second_stage_1, design = svy_design_complete)
  second_stage_2 <- svyglm(formula_second_stage_2, design = svy_design_complete)
  second_stage_3 <- svyglm(formula_second_stage_3, design = svy_design_complete)
  
  # Exponentiate the results for easier interpretation
  first_stage_results <- exponentiate_results(first_stage)
  second_stage_results_1 <- exponentiate_results(second_stage_1)
  second_stage_results_2 <- exponentiate_results(second_stage_2)
  second_stage_results_3 <- exponentiate_results(second_stage_3)
  
  # Define all required coefficients
  required_coeffs <- c("dry", "treatment_hat", "soc_pro", "treatment_hat:soc_pro")
  
  # Function to ensure all required coefficients are present
  ensure_all_coeffs <- function(results, required_coeffs) {
    missing_coeffs <- setdiff(required_coeffs, rownames(results))
    for (missing in missing_coeffs) {
      results <- rbind(results, data.frame(Estimate = NA, `Robust SE` = NA, `P-Value` = NA, row.names = missing))
    }
    return(results)
  }
  
  # Ensure all coefficients are present in the results
  first_stage_results <- ensure_all_coeffs(first_stage_results, required_coeffs)
  second_stage_results_1 <- ensure_all_coeffs(second_stage_results_1, required_coeffs)
  second_stage_results_2 <- ensure_all_coeffs(second_stage_results_2, required_coeffs)
  second_stage_results_3 <- ensure_all_coeffs(second_stage_results_3, required_coeffs)
  
  # Stargazer output for both stages
  output_filename_stargazer <- paste0("iv_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), ".txt")
  sink(output_filename_stargazer)
  stargazer(first_stage, second_stage_1, second_stage_2, second_stage_3, type = "text",
            coef = list(first_stage_results$Estimate, second_stage_results_1$Estimate, second_stage_results_2$Estimate, second_stage_results_3$Estimate),
            se = list(first_stage_results$`Robust SE`, second_stage_results_1$`Robust SE`, second_stage_results_2$`Robust SE`, second_stage_results_3$`Robust SE`),
            p = list(first_stage_results$`P-Value`, second_stage_results_1$`P-Value`, second_stage_results_2$`P-Value`, second_stage_results_3$`P-Value`),
            title = paste("2SLS Regression Results for", outcome_labels[outcome_var]),
            dep.var.labels.include = TRUE, 
            dep.var.labels = c("1st Stage: Conflict Zone", paste0("2nd Stage: ", outcome_labels[outcome_var])),
            omit = c("age", "female", "rural", "windex5", "christian", "muslim", "(Intercept)"),
            covariate.labels = c("Drought", "Conflict Zone", "Social Protection", "Conflict Zone x Social Protection"),
            keep.stat = c("n", "rsq", "adj.rsq"),
            add.lines = list(c("Controls Included", "Yes", "Yes", "Yes", "Yes"),
                             c("1st Stage F-Statistic", ifelse(!is.na(first_stage_fstat), sprintf("%.2f", first_stage_fstat), "NA"))))
  sink()  # Turn off redirection
}

```

H.1D IV: Effect of Proximity to Violent Events, Age<20: HL (Separate Social Protection Programmes) *
```{r}
library(dplyr)
library(sf)
library(AER)
library(stargazer)
library(survey)
library(ggplot2)

# Create exclusive assistance variables
nga_hl_21 <- nga_hl_21 %>%
  mutate(
    soc_cash2 = ifelse(soc_cash == 1 & (is.na(soc_pension) | soc_pension == 0) & (is.na(soc_hup) | soc_hup == 0), 1, 0),
    soc_pension2 = ifelse((is.na(soc_cash) | soc_cash == 0) & soc_pension == 1 & (is.na(soc_hup) | soc_hup == 0), 1, 0),
    soc_hup2 = ifelse((is.na(soc_cash) | soc_cash == 0) & (is.na(soc_pension) | soc_pension == 0) & soc_hup == 1, 1, 0)
  )

# Subsetting data to include only those under age 19
nga_hl_21_ch <- subset(nga_hl_21, nga_hl_21$age < 20)

### Define IV ###
# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_hl_21_ch$soil_2020_avg.x, 0.25, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_hl_21_ch <- nga_hl_21_ch %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Check the first few rows to ensure the dummy variable is created correctly
head(nga_hl_21_ch)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment
calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_hl_21_ch <- calculate_treatment(nga_hl_21_ch, 24)

# Treatment Specifications
nga_hl_21_ch$treatment_chronic <- ifelse(nga_hl_21_ch$treatment > 1, 1, 0)
nga_hl_21_ch$treatment <- ifelse(nga_hl_21_ch$treatment > 0, 1, nga_hl_21_ch$treatment)

# Print the summary of the new treatment variable
summary(nga_hl_21_ch$treatment)

# Clean data and create a complete data frame for the IV approach
variables_list <- c("soc_cash2", "soc_hup2", "soc_pension2")
labels_list <- c("Cash Transfers 1", "Cash Transfers 2", "Pension")

for (i in 1:length(variables_list)) {
  soc_var <- variables_list[i]
  soc_label <- labels_list[i]
  
  nga_hl_21_ch_complete <- nga_hl_21_ch %>%
    filter(complete.cases(.data[[soc_var]], age, female, rural, windex5, treatment, christian, muslim, dry))

  # Create survey design object for the full data
  svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_hl_21_ch_complete, singleunit = "scaled")

  # Define outcome variables
  outcome_labels <- c(
    school20 = "School Attendance (2020-2021)", 
    school19 = "School Attendance (2019-2020)", 
    school_drop = "School Dropout",
    food1_21 = "Food Insecurity: Worried (last month)",
    food2_21 = "Food Insecurity: Not eating healthy (last month)",
    food3_21 = "Food Insecurity: Ate few kinds of food  (last month)",
    food4_21 = "Food Insecurity: Skip a meal (last month)",
    food5_21 = "Food Insecurity: Eating less  (last month)",
    food6_21 = "Food Insecurity: Ran out of food  (last month)",
    food7_21 = "Food Insecurity: Hungry and did not eat (last month)",
    food8_21 = "Food Insecurity: A Day Without Eating (last month)"
  )

  # Function to exponentiate coefficients and calculate robust standard errors
  exponentiate_results <- function(model) {
    coef_table <- summary(model)$coefficients
    exp_coef <- exp(coef_table[, 1])
    robust_se <- coef_table[, 2]
    p_values <- coef_table[, 4]
    result <- data.frame(Estimate = exp_coef, `Robust SE` = robust_se, `P-Value` = p_values)
    return(result)
  }

  # Loop through each outcome variable to fit IV models and save regression tables
  for (outcome_var in names(outcome_labels)) {
    complete_cases <- nga_hl_21_ch_complete %>%
      filter(!is.na(!!sym(outcome_var)))
    
    # Ensure the outcome variable is binary (0/1)
    complete_cases[[outcome_var]] <- ifelse(complete_cases[[outcome_var]] > 1, 1, complete_cases[[outcome_var]])
    
    # Create survey design object for the complete cases
    svy_design_complete <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = complete_cases, singleunit = "scaled")
    
    # First stage: Regress treatment on the instrument and covariates
    formula_first_stage <- as.formula(paste("treatment ~ dry + age + female + rural + windex5 + christian + muslim"))
    first_stage <- svyglm(formula_first_stage, design = svy_design_complete)
    
    # Calculate the F-statistic manually
    first_stage_ssr <- sum((fitted(first_stage) - mean(fitted(first_stage)))^2)
    first_stage_sse <- sum(residuals(first_stage)^2)
    first_stage_fstat <- (first_stage_ssr / length(coef(first_stage))) / (first_stage_sse / df.residual(first_stage))
    first_stage_fstat <- as.numeric(first_stage_fstat)

    # Generate predicted treatment values (treatment_hat)
    complete_cases$treatment_hat <- predict(first_stage, complete_cases, type = "response")
    
    # Update survey design to include treatment_hat
    svy_design_complete <- update(svy_design_complete, treatment_hat = complete_cases$treatment_hat)
    
    # Second stage specifications
    formula_second_stage_1 <- as.formula(paste(outcome_var, "~ treatment_hat + age + female + rural + windex5 + christian + muslim"))
    formula_second_stage_2 <- as.formula(paste(outcome_var, "~ treatment_hat +", soc_var, "+ age + female + rural + windex5 + christian + muslim"))
    formula_second_stage_3 <- as.formula(paste(outcome_var, "~ treatment_hat *", soc_var, "+ age + female + rural + windex5 + christian + muslim"))
    
    # Fit the second stage models
    second_stage_1 <- svyglm(formula_second_stage_1, design = svy_design_complete)
    second_stage_2 <- svyglm(formula_second_stage_2, design = svy_design_complete)
    second_stage_3 <- svyglm(formula_second_stage_3, design = svy_design_complete)
    
    # Exponentiate the results for easier interpretation
    first_stage_results <- exponentiate_results(first_stage)
    second_stage_results_1 <- exponentiate_results(second_stage_1)
    second_stage_results_2 <- exponentiate_results(second_stage_2)
    second_stage_results_3 <- exponentiate_results(second_stage_3)
    
    # Define all required coefficients
    required_coeffs <- c("dry", "treatment_hat", soc_var, paste0("treatment_hat:", soc_var))
    
    # Function to ensure all required coefficients are present
    ensure_all_coeffs <- function(results, required_coeffs) {
      missing_coeffs <- setdiff(required_coeffs, rownames(results))
      for (missing in missing_coeffs) {
        results <- rbind(results, data.frame(Estimate = NA, `Robust SE` = NA, `P-Value` = NA, row.names = missing))
      }
      return(results)
    }
    
    # Ensure all coefficients are present in the results
    first_stage_results <- ensure_all_coeffs(first_stage_results, required_coeffs)
    second_stage_results_1 <- ensure_all_coeffs(second_stage_results_1, required_coeffs)
    second_stage_results_2 <- ensure_all_coeffs(second_stage_results_2, required_coeffs)
    second_stage_results_3 <- ensure_all_coeffs(second_stage_results_3, required_coeffs)
    
    # Stargazer output for both stages with the F-statistic included
    output_filename_stargazer <- paste0("iv_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), "_", soc_var, ".txt")
    sink(output_filename_stargazer)
    stargazer(first_stage, second_stage_1, second_stage_2, second_stage_3, type = "text",
              coef = list(first_stage_results$Estimate, second_stage_results_1$Estimate, second_stage_results_2$Estimate, second_stage_results_3$Estimate),
              se = list(first_stage_results$`Robust SE`, second_stage_results_1$`Robust SE`, second_stage_results_2$`Robust SE`, second_stage_results_3$`Robust SE`),
              p = list(first_stage_results$`P-Value`, second_stage_results_1$`P-Value`, second_stage_results_2$`P-Value`, second_stage_results_3$`P-Value`),
              title = paste("2SLS Regression Results for", outcome_labels[outcome_var]),
              dep.var.labels.include = TRUE, 
              dep.var.labels = c("1st Stage: Conflict Zone", paste0("2nd Stage: ", outcome_labels[outcome_var])),
              omit = c("age", "female", "rural", "windex5", "christian", "muslim", "(Intercept)"),
              covariate.labels = c("Drought", "Conflict Zone", soc_label, paste0("Conflict Zone x ", soc_label)),
              keep.stat = c("n", "rsq", "adj.rsq"),
              add.lines = list(c("Controls Included", "Yes", "Yes", "Yes", "Yes"),
                               c("1st Stage F-Statistic", ifelse(!is.na(first_stage_fstat), sprintf("%.2f", first_stage_fstat), "NA"))))
    sink()  # Turn off redirection

    # Calculate the coefficients and their standard errors
    coef_conflict <- ifelse(!is.na(coef(second_stage_3)["treatment_hat"]), coef(second_stage_3)["treatment_hat"], NA)
    se_conflict <- ifelse(!is.na(vcov(second_stage_3)["treatment_hat", "treatment_hat"]), sqrt(vcov(second_stage_3)["treatment_hat", "treatment_hat"]), NA)
    
    coef_soc_protection <- ifelse(!is.na(coef(second_stage_3)[soc_var]), coef(second_stage_3)[soc_var], NA)
    se_soc_protection <- ifelse(!is.na(vcov(second_stage_3)[soc_var, soc_var]), sqrt(vcov(second_stage_3)[soc_var, soc_var]), NA)
    
    coef_interaction <- ifelse(!is.na(coef(second_stage_3)[paste0("treatment_hat:", soc_var)]), coef(second_stage_3)[paste0("treatment_hat:", soc_var)], NA)
    se_interaction <- ifelse(!is.na(vcov(second_stage_3)[paste0("treatment_hat:", soc_var), paste0("treatment_hat:", soc_var)]), sqrt(vcov(second_stage_3)[paste0("treatment_hat:", soc_var), paste0("treatment_hat:", soc_var)]), NA)
    
    # Exponentiate the coefficients to interpret them as odds ratios
    odds_conflict <- exp(coef_conflict)
    odds_soc_protection <- exp(coef_soc_protection)
    odds_interaction <- exp(coef_interaction)

    # Calculate the product of the odds ratios directly
    odds_product_effect <- odds_soc_protection * odds_interaction

    # Convert odds ratios to percentage changes
    perc_conflict <- ifelse(odds_conflict > 1, (odds_conflict - 1) * 100, (1 - odds_conflict) * -100)
    perc_soc_protection <- ifelse(odds_soc_protection > 1, (odds_soc_protection - 1) * 100, (1 - odds_soc_protection) * -100)
    perc_interaction <- ifelse(odds_interaction > 1, (odds_interaction - 1) * 100, (1 - odds_interaction) * -100)
    perc_product_effect <- ifelse(odds_product_effect > 1, (odds_product_effect - 1) * 100, (1 - odds_product_effect) * -100)

    # Calculate the variance of the product effect using the delta method
    variance_product_effect <- coef_soc_protection^2 * se_interaction^2 +
                               coef_interaction^2 * se_soc_protection^2 +
                               2 * coef_soc_protection * coef_interaction * vcov(second_stage_3)[soc_var, paste0("treatment_hat:", soc_var)]

    # Calculate the standard error for the product effect percentage change
    se_product_effect <- sqrt(variance_product_effect) * 100

    # Adjust the order of effects in the data frame
    effects_df <- data.frame(
      Effect = factor(c("Conflict Effect", "Social Protection Effect", "Interaction Effect", "Interaction Effect x Soc. Pro. Effect"),
                      levels = c("Conflict Effect", "Social Protection Effect", "Interaction Effect", "Interaction Effect x Soc. Pro. Effect")),
      Coefficient = c(perc_conflict, perc_soc_protection, perc_interaction, perc_product_effect),
      SE = c(se_conflict * 100, se_soc_protection * 100, se_interaction * 100, se_product_effect)
    )

    # Check the contents of effects_df to ensure no issues
    print(effects_df)

    # Ensure there are no NA or NULL values before plotting
    if (all(!is.na(effects_df$Coefficient)) & all(!is.na(effects_df$SE))) {
      # Plot all coefficients with confidence intervals
      plot <- ggplot(effects_df, aes(x = Effect, y = Coefficient)) +
        geom_point(size = 4) +
        geom_errorbar(aes(ymin = Coefficient - 1.96 * SE, ymax = Coefficient + 1.96 * SE), width = 0.1) +
        labs(title = paste("Percentage Changes and Interaction Effects"),
             x = "Effect Type",
             y = "Percentage Change with 95% CI") +
        theme_minimal()

      # Save the plot
      output_plot_filename <- paste0("coefficients_comparison_", gsub("[^[:alnum:] ]", "", outcome_var), "_", soc_var, ".png")
      ggsave(output_plot_filename, plot, width = 10, height = 6)
    } else {
      warning("NA values detected in the effects_df. Plot will not be generated.")
    }
  }
}

```

H.2D IV: Effect of Proximity to Violent Events, Age<20: WM (Combined Social Protection)
```{r}
library(dplyr)
library(sf)
library(AER)
library(stargazer)
library(survey)

# Subsetting data to include only those under age 19
nga_wm_21_ch <- subset(nga_wm_21, nga_wm_21$age < 20)

### Define IV ###
# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_wm_21_ch$soil_2020_avg.x, 0.25, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_wm_21_ch <- nga_wm_21_ch %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Check the first few rows to ensure the dummy variable is created correctly
head(nga_wm_21_ch)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment
calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_wm_21_ch <- calculate_treatment(nga_wm_21_ch, 24)

# Treatment Specifications
nga_wm_21_ch$treatment_chronic <- ifelse(nga_wm_21_ch$treatment > 1, 1, 0)
nga_wm_21_ch$treatment <- ifelse(nga_wm_21_ch$treatment > 0, 1, nga_wm_21_ch$treatment)

# Print the summary of the new treatment variable
summary(nga_wm_21_ch$treatment)

# Clean data and create a complete data frame for the IV approach
nga_wm_21_ch_complete <- nga_wm_21_ch %>%
  filter(complete.cases(soc_pro, age, rural, windex5, treatment, christian, muslim, dry))

# Create survey design object for the full data
svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_wm_21_ch, singleunit = "scaled")

# Define outcome variables
outcome_labels <- c(
  happiness_20 = "Happiness 2020",
  happiness_21 = "Happiness 2021",
  happiness_change = "Happiness Change 20-21"
)

# Function to exponentiate coefficients and calculate robust standard errors
exponentiate_results <- function(model) {
  coef_table <- summary(model)$coefficients
  exp_coef <- exp(coef_table[, 1])
  robust_se <- coef_table[, 2]
  p_values <- coef_table[, 4]
  result <- data.frame(Estimate = exp_coef, `Robust SE` = robust_se, `P-Value` = p_values)
  return(result)
}

# Loop through each outcome variable to fit IV models and save regression tables
for (outcome_var in names(outcome_labels)) {
  complete_cases <- nga_wm_21_ch_complete %>%
    filter(!is.na(!!sym(outcome_var)))
  
  # Ensure the outcome variable is binary (0/1)
  complete_cases[[outcome_var]] <- ifelse(complete_cases[[outcome_var]] > 1, 1, complete_cases[[outcome_var]])
  
  # Create survey design object for the complete cases
  svy_design_complete <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = complete_cases, singleunit = "scaled")
  
  # First stage: Regress treatment on the instrument and covariates
  formula_first_stage <- as.formula(paste("treatment ~ dry + age + rural + windex5 + christian + muslim"))
  first_stage <- svyglm(formula_first_stage, design = svy_design_complete)
  
  # Calculate the F-statistic manually
  first_stage_ssr <- sum((fitted(first_stage) - mean(fitted(first_stage)))^2)
  first_stage_sse <- sum(residuals(first_stage)^2)
  first_stage_fstat <- (first_stage_ssr / length(coef(first_stage))) / (first_stage_sse / df.residual(first_stage))
  first_stage_fstat <- as.numeric(first_stage_fstat)

  # Generate predicted treatment values (treatment_hat)
  complete_cases$treatment_hat <- predict(first_stage, complete_cases, type = "response")
  
  # Update survey design to include treatment_hat
  svy_design_complete <- update(svy_design_complete, treatment_hat = complete_cases$treatment_hat)
  
  # Second stage specifications
  formula_second_stage_1 <- as.formula(paste(outcome_var, "~ treatment_hat + age + rural + windex5 + christian + muslim"))
  formula_second_stage_2 <- as.formula(paste(outcome_var, "~ treatment_hat + soc_pro + age + rural + windex5 + christian + muslim"))
  formula_second_stage_3 <- as.formula(paste(outcome_var, "~ treatment_hat * soc_pro + age + rural + windex5 + christian + muslim"))
  
  # Fit the second stage models
  second_stage_1 <- svyglm(formula_second_stage_1, design = svy_design_complete)
  second_stage_2 <- svyglm(formula_second_stage_2, design = svy_design_complete)
  second_stage_3 <- svyglm(formula_second_stage_3, design = svy_design_complete)
  
  # Exponentiate the results for easier interpretation
  first_stage_results <- exponentiate_results(first_stage)
  second_stage_results_1 <- exponentiate_results(second_stage_1)
  second_stage_results_2 <- exponentiate_results(second_stage_2)
  second_stage_results_3 <- exponentiate_results(second_stage_3)
  
  # Define all required coefficients
  required_coeffs <- c("dry", "treatment_hat", "soc_pro", "treatment_hat:soc_pro")
  
  # Function to ensure all required coefficients are present
  ensure_all_coeffs <- function(results, required_coeffs) {
    missing_coeffs <- setdiff(required_coeffs, rownames(results))
    for (missing in missing_coeffs) {
      results <- rbind(results, data.frame(Estimate = NA, `Robust SE` = NA, `P-Value` = NA, row.names = missing))
    }
    return(results)
  }
  
  # Ensure all coefficients are present in the results
  first_stage_results <- ensure_all_coeffs(first_stage_results, required_coeffs)
  second_stage_results_1 <- ensure_all_coeffs(second_stage_results_1, required_coeffs)
  second_stage_results_2 <- ensure_all_coeffs(second_stage_results_2, required_coeffs)
  second_stage_results_3 <- ensure_all_coeffs(second_stage_results_3, required_coeffs)
  
  # Stargazer output for both stages with the F-statistic included
  output_filename_stargazer <- paste0("iv_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), "f.txt")
  sink(output_filename_stargazer)
  stargazer(first_stage, second_stage_1, second_stage_2, second_stage_3, type = "text",
            coef = list(first_stage_results$Estimate, second_stage_results_1$Estimate, second_stage_results_2$Estimate, second_stage_results_3$Estimate),
            se = list(first_stage_results$`Robust SE`, second_stage_results_1$`Robust SE`, second_stage_results_2$`Robust SE`, second_stage_results_3$`Robust SE`),
            p = list(first_stage_results$`P-Value`, second_stage_results_1$`P-Value`, second_stage_results_2$`P-Value`, second_stage_results_3$`P-Value`),
            title = paste("2SLS Regression Results for", outcome_labels[outcome_var]),
            dep.var.labels.include = TRUE, 
            dep.var.labels = c("1st Stage: Conflict Zone", paste0("2nd Stage: ", outcome_labels[outcome_var])),
            omit = c("age", "female", "rural", "windex5", "christian", "muslim", "(Intercept)"),
            covariate.labels = c("Drought", "Conflict Zone", "Social Protection", "Conflict Zone x Social Protection"),
            keep.stat = c("n", "rsq", "adj.rsq"),
            add.lines = list(c("Controls Included", "Yes", "Yes", "Yes", "Yes"),
                             c("1st Stage F-Statistic", ifelse(!is.na(first_stage_fstat), sprintf("%.2f", first_stage_fstat), "NA"))))
  sink()  # Turn off redirection
}

```

H.3D IV: Effect of Proximity to Violent Events, Age<20: CH (Combined Social Protection)
```{r}
library(dplyr)
library(sf)
library(AER)
library(stargazer)
library(survey)
library(ggplot2)

# Use the dataset nga_ch_21
nga_ch_21 <- nga_ch_21

# Create exclusive assistance variables
nga_ch_21 <- nga_ch_21 %>%
  mutate(
    soc_cash2 = ifelse(soc_cash == 1 & (is.na(soc_pension) | soc_pension == 0) & (is.na(soc_hup) | soc_hup == 0), 1, 0),
    soc_pension2 = ifelse((is.na(soc_cash) | soc_cash == 0) & soc_pension == 1 & (is.na(soc_hup) | soc_hup == 0), 1, 0),
    soc_hup2 = ifelse((is.na(soc_cash) | soc_cash == 0) & (is.na(soc_pension) | soc_pension == 0) & soc_hup == 1, 1, 0)
  )

# Subsetting data to include only those under age 19
nga_ch_21_ch <- subset(nga_ch_21, nga_ch_21$age < 20)

### Define IV ###
# Calculate the 1st quartile soil moisture for the year 2020
threshold_soil_moisture_2020 <- quantile(nga_ch_21_ch$soil_2020_avg.x, 0.25, na.rm = TRUE)

# Create a dummy variable 'dry' indicating locations with soil moisture levels below the 1st quartile threshold
nga_ch_21_ch <- nga_ch_21_ch %>%
  mutate(dry = ifelse(soil_2020_avg.x < threshold_soil_moisture_2020, 1, 0))

# Check the first few rows to ensure the dummy variable is created correctly
head(nga_ch_21_ch)

### Define Treatment ###
# Create a function to define the number of months to take into account in the treatment
calculate_treatment <- function(data, num_t) {
  # Create a list of t variable names
  t_vars <- paste0("t", 1:num_t)
  
  # Sum all t's, handling NAs by assuming NA + number = NA
  data$treatment <- rowSums(data[t_vars], na.rm = TRUE)
  
  # Replace row sums of 0 (where all are NA) with NA
  data$treatment[rowSums(!is.na(data[t_vars])) == 0] <- NA
  
  return(data)
}

# Apply function 
nga_ch_21_ch <- calculate_treatment(nga_ch_21_ch, 24)

# Treatment Specifications
nga_ch_21_ch$treatment_chronic <- ifelse(nga_ch_21_ch$treatment > 1, 1, 0)
nga_ch_21_ch$treatment <- ifelse(nga_ch_21_ch$treatment > 0, 1, nga_ch_21_ch$treatment)

# Print the summary of the new treatment variable
summary(nga_ch_21_ch$treatment)

# Clean data and create a complete data frame for the IV approach
variables_list <- c("soc_cash2", "soc_hup2", "soc_pension2")
labels_list <- c("Cash Transfers 1", "Cash Transfers 2", "Pension")

# Use the updated list of outcomes
outcome_labels <- c(
  depressed = "Depressed Child",
  violence_1 = "Child Abuse: Spanked",
  violence_2 = "Child Abuse: Hit with Object",
  violence_3 = "Child Abuse: Called Names",
  violence_4 = "Child Abuse: Slap on Face",
  violence_5 = "Child Abuse: Slap on Hand or Legs",
  violence_6 = "Child Abuse: Beaten Up",
  child_abuse = "Child Abuse"
)

for (i in 1:length(variables_list)) {
  soc_var <- variables_list[i]
  soc_label <- labels_list[i]
  
  nga_ch_21_ch_complete <- nga_ch_21_ch %>%
    filter(complete.cases(.data[[soc_var]], age, rural, windex5, treatment, christian, muslim, dry))

  # Create survey design object for the full data
  svy_design <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = nga_ch_21_ch_complete, singleunit = "scaled")

  # Function to exponentiate coefficients and calculate robust standard errors
  exponentiate_results <- function(model) {
    coef_table <- summary(model)$coefficients
    exp_coef <- exp(coef_table[, 1])
    robust_se <- coef_table[, 2]
    p_values <- coef_table[, 4]
    result <- data.frame(Estimate = exp_coef, `Robust SE` = robust_se, `P-Value` = p_values)
    return(result)
  }

  # Loop through each outcome variable to fit IV models and save regression tables
  for (outcome_var in names(outcome_labels)) {
    complete_cases <- nga_ch_21_ch_complete %>%
      filter(!is.na(!!sym(outcome_var)))
    
    # Ensure the outcome variable is binary (0/1)
    complete_cases[[outcome_var]] <- ifelse(complete_cases[[outcome_var]] > 1, 1, complete_cases[[outcome_var]])
    
    # Create survey design object for the complete cases
    svy_design_complete <- svydesign(ids = ~PSU, strata = ~stratum, weights = ~weight, data = complete_cases, singleunit = "scaled")
    
    # First stage: Regress treatment on the instrument and covariates
    formula_first_stage <- as.formula(paste("treatment ~ dry + age + rural + windex5 + christian + muslim"))
    first_stage <- svyglm(formula_first_stage, design = svy_design_complete)
    
    # Calculate the F-statistic manually
    first_stage_ssr <- sum((fitted(first_stage) - mean(fitted(first_stage)))^2)
    first_stage_sse <- sum(residuals(first_stage)^2)
    first_stage_fstat <- (first_stage_ssr / length(coef(first_stage))) / (first_stage_sse / df.residual(first_stage))
    first_stage_fstat <- as.numeric(first_stage_fstat)

    # Generate predicted treatment values (treatment_hat)
    complete_cases$treatment_hat <- predict(first_stage, complete_cases, type = "response")
    
    # Update survey design to include treatment_hat
    svy_design_complete <- update(svy_design_complete, treatment_hat = complete_cases$treatment_hat)
    
    # Second stage specifications
    formula_second_stage_1 <- as.formula(paste(outcome_var, "~ treatment_hat + age + rural + windex5 + christian + muslim"))
    formula_second_stage_2 <- as.formula(paste(outcome_var, "~ treatment_hat +", soc_var, "+ age + rural + windex5 + christian + muslim"))
    formula_second_stage_3 <- as.formula(paste(outcome_var, "~ treatment_hat *", soc_var, "+ age + rural + windex5 + christian + muslim"))
    
    # Fit the second stage models
    second_stage_1 <- svyglm(formula_second_stage_1, design = svy_design_complete)
    second_stage_2 <- svyglm(formula_second_stage_2, design = svy_design_complete)
    second_stage_3 <- svyglm(formula_second_stage_3, design = svy_design_complete)
    
    # Exponentiate the results for easier interpretation
    first_stage_results <- exponentiate_results(first_stage)
    second_stage_results_1 <- exponentiate_results(second_stage_1)
    second_stage_results_2 <- exponentiate_results(second_stage_2)
    second_stage_results_3 <- exponentiate_results(second_stage_3)
    
    # Define all required coefficients
    required_coeffs <- c("dry", "treatment_hat", soc_var, paste0("treatment_hat:", soc_var))
    
    # Function to ensure all required coefficients are present
    ensure_all_coeffs <- function(results, required_coeffs) {
      missing_coeffs <- setdiff(required_coeffs, rownames(results))
      for (missing in missing_coeffs) {
        results <- rbind(results, data.frame(Estimate = NA, `Robust SE` = NA, `P-Value` = NA, row.names = missing))
      }
      return(results)
    }
    
    # Ensure all coefficients are present in the results
    first_stage_results <- ensure_all_coeffs(first_stage_results, required_coeffs)
    second_stage_results_1 <- ensure_all_coeffs(second_stage_results_1, required_coeffs)
    second_stage_results_2 <- ensure_all_coeffs(second_stage_results_2, required_coeffs)
    second_stage_results_3 <- ensure_all_coeffs(second_stage_results_3, required_coeffs)
    
    # Stargazer output for both stages with the F-statistic included
    output_filename_stargazer <- paste0("iv_regression_outputs_", gsub("[^[:alnum:] ]", "", outcome_var), "_", soc_var, ".txt")
    sink(output_filename_stargazer)
    stargazer(first_stage, second_stage_1, second_stage_2, second_stage_3, type = "text",
              coef = list(first_stage_results$Estimate, second_stage_results_1$Estimate, second_stage_results_2$Estimate, second_stage_results_3$Estimate),
              se = list(first_stage_results$`Robust SE`, second_stage_results_1$`Robust SE`, second_stage_results_2$`Robust SE`, second_stage_results_3$`Robust SE`),
              p = list(first_stage_results$`P-Value`, second_stage_results_1$`P-Value`, second_stage_results_2$`P-Value`, second_stage_results_3$`P-Value`),
              title = paste("2SLS Regression Results for", outcome_labels[outcome_var]),
              dep.var.labels.include = TRUE, 
              dep.var.labels = c("1st Stage: Conflict Zone", paste0("2nd Stage: ", outcome_labels[outcome_var])),
              omit = c("age", "rural", "windex5", "christian", "muslim", "(Intercept)"),
              covariate.labels = c("Drought", "Conflict Zone", soc_label, paste0("Conflict Zone x ", soc_label)),
              keep.stat = c("n", "rsq", "adj.rsq"),
              add.lines = list(c("Controls Included", "Yes", "Yes", "Yes", "Yes"),
                               c("1st Stage F-Statistic", ifelse(!is.na(first_stage_fstat), sprintf("%.2f", first_stage_fstat), "NA"))))
    sink()  # Turn off redirection

    # Calculate the coefficients and their standard errors
    coef_conflict <- ifelse(!is.na(coef(second_stage_3)["treatment_hat"]), coef(second_stage_3)["treatment_hat"], NA)
    se_conflict <- ifelse(!is.na(vcov(second_stage_3)["treatment_hat", "treatment_hat"]), sqrt(vcov(second_stage_3)["treatment_hat", "treatment_hat"]), NA)
    
    coef_soc_protection <- ifelse(!is.na(coef(second_stage_3)[soc_var]), coef(second_stage_3)[soc_var], NA)
    se_soc_protection <- ifelse(!is.na(vcov(second_stage_3)[soc_var, soc_var]), sqrt(vcov(second_stage_3)[soc_var, soc_var]), NA)
    
    coef_interaction <- ifelse(!is.na(coef(second_stage_3)[paste0("treatment_hat:", soc_var)]), coef(second_stage_3)[paste0("treatment_hat:", soc_var)], NA)
    se_interaction <- ifelse(!is.na(vcov(second_stage_3)[paste0("treatment_hat:", soc_var), paste0("treatment_hat:", soc_var)]), sqrt(vcov(second_stage_3)[paste0("treatment_hat:", soc_var), paste0("treatment_hat:", soc_var)]), NA)
    
    # Exponentiate the coefficients to interpret them as odds ratios
    odds_conflict <- exp(coef_conflict)
    odds_soc_protection <- exp(coef_soc_protection)
    odds_interaction <- exp(coef_interaction)

    # Calculate the product of the odds ratios directly
    odds_product_effect <- odds_soc_protection * odds_interaction

    # Convert odds ratios to percentage changes
    perc_conflict <- ifelse(odds_conflict > 1, (odds_conflict - 1) * 100, (1 - odds_conflict) * -100)
    perc_soc_protection <- ifelse(odds_soc_protection > 1, (odds_soc_protection - 1) * 100, (1 - odds_soc_protection) * -100)
    perc_interaction <- ifelse(odds_interaction > 1, (odds_interaction - 1) * 100, (1 - odds_interaction) * -100)
    perc_product_effect <- ifelse(odds_product_effect > 1, (odds_product_effect - 1) * 100, (1 - odds_product_effect) * -100)

    # Calculate the variance of the product effect using the delta method
    variance_product_effect <- coef_soc_protection^2 * se_interaction^2 +
                               coef_interaction^2 * se_soc_protection^2 +
                               2 * coef_soc_protection * coef_interaction * vcov(second_stage_3)[soc_var, paste0("treatment_hat:", soc_var)]

    # Calculate the standard error for the product effect percentage change
    se_product_effect <- sqrt(variance_product_effect) * 100

    # Adjust the order of effects in the data frame
    effects_df <- data.frame(
      Effect = factor(c("Conflict Effect", "Social Protection Effect", "Interaction Effect", "Interaction Effect x Soc. Pro. Effect"),
                      levels = c("Conflict Effect", "Social Protection Effect", "Interaction Effect", "Interaction Effect x Soc. Pro. Effect")),
      Coefficient = c(perc_conflict, perc_soc_protection, perc_interaction, perc_product_effect),
      SE = c(se_conflict * 100, se_soc_protection * 100, se_interaction * 100, se_product_effect)
    )

    # Check the contents of effects_df to ensure no issues
    print(effects_df)

    # Ensure there are no NA or NULL values before plotting
    if (all(!is.na(effects_df$Coefficient)) & all(!is.na(effects_df$SE))) {
      # Plot all coefficients with confidence intervals
      plot <- ggplot(effects_df, aes(x = Effect, y = Coefficient)) +
        geom_point(size = 4) +
        geom_errorbar(aes(ymin = Coefficient - 1.96 * SE, ymax = Coefficient + 1.96 * SE), width = 0.1) +
        labs(title = paste("Percentage Changes and Interaction Effects"),
             x = "Effect Type",
             y = "Percentage Change with 95% CI") +
        theme_minimal()

      # Save the plot
      output_plot_filename <- paste0("coefficients_comparison_", gsub("[^[:alnum:] ]", "", outcome_var), "_", soc_var, ".png")
      ggsave(output_plot_filename, plot, width = 10, height = 6)
    } else {
      warning("NA values detected in the effects_df. Plot will not be generated.")
    }
  }
}

```
